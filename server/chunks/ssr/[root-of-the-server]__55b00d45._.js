module.exports = {

"[externals]/perf_hooks [external] (perf_hooks, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("perf_hooks", () => require("perf_hooks"));

module.exports = mod;
}}),
"[externals]/node:perf_hooks [external] (node:perf_hooks, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("node:perf_hooks", () => require("node:perf_hooks"));

module.exports = mod;
}}),
"[externals]/async_hooks [external] (async_hooks, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("async_hooks", () => require("async_hooks"));

module.exports = mod;
}}),
"[externals]/events [external] (events, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}}),
"[externals]/os [external] (os, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("os", () => require("os"));

module.exports = mod;
}}),
"[externals]/process [external] (process, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("process", () => require("process"));

module.exports = mod;
}}),
"[externals]/child_process [external] (child_process, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("child_process", () => require("child_process"));

module.exports = mod;
}}),
"[externals]/util [external] (util, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}}),
"[externals]/fs [external] (fs, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}}),
"[externals]/crypto [external] (crypto, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}}),
"[externals]/require-in-the-middle [external] (require-in-the-middle, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("require-in-the-middle", () => require("require-in-the-middle"));

module.exports = mod;
}}),
"[externals]/import-in-the-middle [external] (import-in-the-middle, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("import-in-the-middle", () => require("import-in-the-middle"));

module.exports = mod;
}}),
"[externals]/http [external] (http, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}}),
"[externals]/https [external] (https, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}}),
"[externals]/zlib [external] (zlib, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}}),
"[externals]/stream [external] (stream, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}}),
"[externals]/tls [external] (tls, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("tls", () => require("tls"));

module.exports = mod;
}}),
"[externals]/net [external] (net, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("net", () => require("net"));

module.exports = mod;
}}),
"[externals]/http2 [external] (http2, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("http2", () => require("http2"));

module.exports = mod;
}}),
"[externals]/dns [external] (dns, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("dns", () => require("dns"));

module.exports = mod;
}}),
"[externals]/node:async_hooks [external] (node:async_hooks, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("node:async_hooks", () => require("node:async_hooks"));

module.exports = mod;
}}),
"[externals]/buffer [external] (buffer, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}}),
"[externals]/express [external] (express, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("express", () => require("express"));

module.exports = mod;
}}),
"[externals]/fs/promises [external] (fs/promises, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("fs/promises", () => require("fs/promises"));

module.exports = mod;
}}),
"[externals]/node:crypto [external] (node:crypto, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("node:crypto", () => require("node:crypto"));

module.exports = mod;
}}),
"[project]/src/ai/genkit.ts [app-rsc] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "ai": (()=>ai)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$genkit$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/node_modules/genkit/lib/index.mjs [app-rsc] (ecmascript) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$genkit$2f$lib$2f$genkit$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/genkit/lib/genkit.js [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$genkit$2d$ai$2f$googleai$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/node_modules/@genkit-ai/googleai/lib/index.mjs [app-rsc] (ecmascript) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$genkit$2d$ai$2f$googleai$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/@genkit-ai/googleai/lib/index.mjs [app-rsc] (ecmascript) <locals>");
;
;
const ai = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$genkit$2f$lib$2f$genkit$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["genkit"])({
    plugins: [
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$genkit$2d$ai$2f$googleai$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__$3c$locals$3e$__["googleAI"])()
    ],
    model: 'googleai/gemini-2.0-flash'
});
}}),
"[project]/src/ai/schemas.ts [app-rsc] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
/**
 * @fileOverview Shared Zod schemas and TypeScript types for AI flows.
 */ __turbopack_context__.s({
    "ExcelErrorDetectionInputSchema": (()=>ExcelErrorDetectionInputSchema),
    "ExcelErrorDetectionOutputSchema": (()=>ExcelErrorDetectionOutputSchema)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$genkit$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/node_modules/genkit/lib/index.mjs [app-rsc] (ecmascript) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$genkit$2f$lib$2f$common$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/genkit/lib/common.js [app-rsc] (ecmascript)");
;
const ExcelErrorDetectionInputSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$genkit$2f$lib$2f$common$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].object({
    excelDataUri: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$genkit$2f$lib$2f$common$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().describe("The Excel file data as a data URI that must include a MIME type and use Base64 encoding. Expected format: 'data:<mimetype>;base64,<encoded_data>'.")
});
const ExcelErrorDetectionOutputSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$genkit$2f$lib$2f$common$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].object({
    errors: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$genkit$2f$lib$2f$common$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].array(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$genkit$2f$lib$2f$common$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string()).describe('A list of potential errors and inconsistencies found in the Excel file.'),
    suggestions: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$genkit$2f$lib$2f$common$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].array(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$genkit$2f$lib$2f$common$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string()).describe('A list of suggestions to fix the errors and inconsistencies.')
});
}}),
"[project]/src/ai/flows/excel-error-detection.ts [app-rsc] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
/* __next_internal_action_entry_do_not_use__ [{"403b9feddd90d00be57568bea4e2dd31901c7c1bfc":"excelErrorDetection"},"",""] */ __turbopack_context__.s({
    "excelErrorDetection": (()=>excelErrorDetection)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/build/webpack/loaders/next-flight-loader/server-reference.js [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$server$2f$app$2d$render$2f$encryption$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/server/app-render/encryption.js [app-rsc] (ecmascript)");
/**
 * @fileOverview Analyzes an Excel file for potential errors and inconsistencies using AI.
 *
 * - excelErrorDetection - A function that handles the Excel file analysis process.
 */ var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$ai$2f$genkit$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/ai/genkit.ts [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$ai$2f$schemas$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/ai/schemas.ts [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/build/webpack/loaders/next-flight-loader/action-validate.js [app-rsc] (ecmascript)");
;
;
;
;
async function excelErrorDetection(input) {
    return excelErrorDetectionFlow(input);
}
const prompt = __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$ai$2f$genkit$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["ai"].definePrompt({
    name: 'excelErrorDetectionPrompt',
    input: {
        schema: __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$ai$2f$schemas$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["ExcelErrorDetectionInputSchema"]
    },
    output: {
        schema: __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$ai$2f$schemas$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["ExcelErrorDetectionOutputSchema"]
    },
    prompt: `You are an AI assistant that analyzes Excel files for potential errors and inconsistencies.

You will receive the Excel file data as a data URI.

Analyze the Excel data and identify any potential errors, inconsistencies, or formatting issues that might cause problems during conversion to .DAT or PDF formats.

Provide a list of errors and a list of suggestions to fix them.

Excel Data: {{media url=excelDataUri}}

Errors:
{{errors}}

Suggestions:
{{suggestions}}`
});
const excelErrorDetectionFlow = __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$ai$2f$genkit$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["ai"].defineFlow({
    name: 'excelErrorDetectionFlow',
    inputSchema: __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$ai$2f$schemas$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["ExcelErrorDetectionInputSchema"],
    outputSchema: __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$ai$2f$schemas$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["ExcelErrorDetectionOutputSchema"]
}, async (input)=>{
    const { output } = await prompt(input);
    return output;
});
;
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["ensureServerEntryExports"])([
    excelErrorDetection
]);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerServerReference"])(excelErrorDetection, "403b9feddd90d00be57568bea4e2dd31901c7c1bfc", null);
}}),
"[externals]/assert [external] (assert, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("assert", () => require("assert"));

module.exports = mod;
}}),
"[externals]/tty [external] (tty, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("tty", () => require("tty"));

module.exports = mod;
}}),
"[externals]/punycode [external] (punycode, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("punycode", () => require("punycode"));

module.exports = mod;
}}),
"[externals]/querystring [external] (querystring, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("querystring", () => require("querystring"));

module.exports = mod;
}}),
"[externals]/node:events [external] (node:events, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("node:events", () => require("node:events"));

module.exports = mod;
}}),
"[externals]/node:process [external] (node:process, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("node:process", () => require("node:process"));

module.exports = mod;
}}),
"[externals]/node:util [external] (node:util, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("node:util", () => require("node:util"));

module.exports = mod;
}}),
"[project]/src/lib/drive-oauth.ts [app-rsc] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "getOAuth2Client": (()=>getOAuth2Client),
    "getSheetsClient": (()=>getSheetsClient)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$googleapis$2f$build$2f$src$2f$index$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/googleapis/build/src/index.js [app-rsc] (ecmascript)");
;
const { GOOGLE_OAUTH_CLIENT_ID, GOOGLE_OAUTH_CLIENT_SECRET, GOOGLE_OAUTH_REFRESH_TOKEN } = process.env;
if (!GOOGLE_OAUTH_CLIENT_ID || !GOOGLE_OAUTH_CLIENT_SECRET || !GOOGLE_OAUTH_REFRESH_TOKEN) {
    // This check is important but shouldn't throw an error that crashes the server on startup,
    // as the credentials might not be used on every page load.
    // We will let the functions that use it handle the error.
    console.warn('Google OAuth credentials are not fully configured in .env. Some Drive/Sheets features may not work.');
}
// This is a fixed value for web applications
const GOOGLE_OAUTH_REDIRECT_URI = 'https://developers.google.com/oauthplayground';
let oauth2Client = null;
async function getOAuth2Client() {
    // Add the check here to provide a clear error when the credentials are used.
    if (!GOOGLE_OAUTH_CLIENT_ID || !GOOGLE_OAUTH_CLIENT_SECRET || !GOOGLE_OAUTH_REFRESH_TOKEN) {
        throw new Error('Google OAuth credentials (CLIENT_ID, CLIENT_SECRET, REFRESH_TOKEN) must be configured in your .env file.');
    }
    if (oauth2Client) {
        // Check if the token is about to expire (within 60 seconds) and refresh if needed
        if (oauth2Client.credentials.expiry_date && oauth2Client.credentials.expiry_date < Date.now() + 60 * 1000) {
            console.log('[OAuth] Access token expiring soon, refreshing...');
            await oauth2Client.refreshAccessToken();
            console.log('[OAuth] Access token refreshed.');
        }
        return oauth2Client;
    }
    const client = new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$googleapis$2f$build$2f$src$2f$index$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["google"].auth.OAuth2(GOOGLE_OAUTH_CLIENT_ID, GOOGLE_OAUTH_CLIENT_SECRET, GOOGLE_OAUTH_REDIRECT_URI);
    client.setCredentials({
        refresh_token: GOOGLE_OAUTH_REFRESH_TOKEN
    });
    // Do an initial token refresh to get the access token
    try {
        console.log('[OAuth] Initializing and refreshing access token...');
        await client.refreshAccessToken();
        console.log('[OAuth] Initial token refreshed successfully.');
    } catch (error) {
        console.error('[OAuth] Failed to refresh access token:', error);
        throw new Error('Failed to refresh access token. Check your refresh token and credentials.');
    }
    oauth2Client = client;
    return oauth2Client;
}
async function getSheetsClient() {
    const oauth2Client = await getOAuth2Client();
    return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$googleapis$2f$build$2f$src$2f$index$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["google"].sheets({
        version: 'v4',
        auth: oauth2Client
    });
}
}}),
"[project]/src/lib/googlesheets.ts [app-rsc] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "appendHeaderDataToSheet": (()=>appendHeaderDataToSheet),
    "appendUserToSheet": (()=>appendUserToSheet),
    "deleteHeaderDataRowInSheet": (()=>deleteHeaderDataRowInSheet),
    "getAllHeaderDataFromSheet": (()=>getAllHeaderDataFromSheet),
    "getAllUsers": (()=>getAllUsers),
    "updateHeaderDataInSheet": (()=>updateHeaderDataInSheet),
    "updateUserFolderId": (()=>updateUserFolderId)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/zod/lib/index.mjs [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2d$oauth$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/drive-oauth.ts [app-rsc] (ecmascript)");
;
;
const signupSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].object({
    userName: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string(),
    email: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().email(),
    password: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string(),
    folderId: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string()
});
const loginSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].object({
    userName: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string(),
    password: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string()
});
const { GOOGLE_SHEETS_SHEET_ID } = process.env;
if (!GOOGLE_SHEETS_SHEET_ID) {
    throw new Error('GOOGLE_SHEETS_SHEET_ID is not configured in .env');
}
const SPREADSHEET_ID = GOOGLE_SHEETS_SHEET_ID;
const SHEET_NAME = 'credentials';
async function appendUserToSheet(userData) {
    const { email, userName, password, folderId } = userData;
    const timestamp = new Date().toISOString();
    const sheets = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2d$oauth$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["getSheetsClient"])();
    // Mapping to sheet headers: emailAddress, userName, pwd, databaseID, folderID, status, lastLogin, runtime
    const values = [
        [
            email,
            userName,
            password,
            '',
            folderId,
            'active',
            timestamp,
            ''
        ]
    ];
    const request = {
        spreadsheetId: SPREADSHEET_ID,
        range: `${SHEET_NAME}!A1`,
        valueInputOption: 'USER_ENTERED',
        resource: {
            values
        }
    };
    try {
        const response = await sheets.spreadsheets.values.append(request);
        console.log('Appended to sheet:', response.data);
        return response.data;
    } catch (err) {
        console.error('The API returned an error: ' + err);
        throw new Error('Failed to append data to Google Sheet.');
    }
}
async function getAllUsers() {
    try {
        const sheets = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2d$oauth$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["getSheetsClient"])();
        const response = await sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: SHEET_NAME
        });
        const rows = response.data.values;
        if (!rows || rows.length === 0) {
            return [];
        }
        const header = rows[0];
        const emailIndex = header.indexOf('emailAddress');
        const userNameIndex = header.indexOf('userName');
        const pwdIndex = header.indexOf('pwd');
        const databaseIdIndex = header.indexOf('databaseID');
        const folderIdIndex = header.indexOf('folderID');
        if (userNameIndex === -1 || pwdIndex === -1 || emailIndex === -1 || databaseIdIndex === -1 || folderIdIndex === -1) {
            throw new Error('Could not find required columns in the credentials sheet.');
        }
        return rows.slice(1).map((row)=>({
                emailAddress: row[emailIndex] || '',
                userName: row[userNameIndex] || '',
                pwd: row[pwdIndex] || '',
                databaseId: row[databaseIdIndex] || '',
                folderId: row[folderIdIndex] || ''
            }));
    } catch (err) {
        console.error('The API returned an error: ' + err);
        throw new Error('Failed to retrieve data from Google Sheet.');
    }
}
async function updateUserFolderId(userName, folderId) {
    const sheets = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2d$oauth$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["getSheetsClient"])();
    const range = `${SHEET_NAME}!A:H`; // Adjust range to cover all columns
    const response = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range
    });
    const rows = response.data.values;
    if (!rows || rows.length === 0) {
        throw new Error('No users found in credentials sheet.');
    }
    const header = rows[0];
    const userNameIndex = header.indexOf('userName');
    const folderIdIndex = header.indexOf('folderID');
    if (userNameIndex === -1 || folderIdIndex === -1) {
        throw new Error('userName or folderID column not found.');
    }
    const userRowIndex = rows.findIndex((row)=>row[userNameIndex] === userName);
    if (userRowIndex === -1) {
        throw new Error(`User ${userName} not found.`);
    }
    const rowToUpdate = userRowIndex + 1;
    const columnToUpdate = String.fromCharCode('A'.charCodeAt(0) + folderIdIndex);
    await sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SHEET_NAME}!${columnToUpdate}${rowToUpdate}`,
        valueInputOption: 'RAW',
        resource: {
            values: [
                [
                    folderId
                ]
            ]
        }
    });
}
async function getAllHeaderDataFromSheet(databaseId) {
    try {
        const sheets = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2d$oauth$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["getSheetsClient"])();
        const response = await sheets.spreadsheets.values.get({
            spreadsheetId: databaseId,
            range: 'tpList!A:Q'
        });
        const rows = response.data.values;
        if (!rows || rows.length < 2) {
            return [];
        }
        const header = rows[0];
        const dataRows = rows.slice(1);
        const objects = dataRows.map((row)=>{
            const rowData = {};
            header.forEach((key, headerIndex)=>{
                rowData[key] = row[headerIndex] || '';
            });
            return rowData;
        }).filter((profile)=>profile.tpTIN && typeof profile.tpTIN === 'string' && profile.tpTIN.trim() !== '');
        return objects;
    } catch (err) {
        console.error(`The API returned an error for spreadsheet ${databaseId}: ` + err);
        throw new Error('Failed to retrieve header data from Google Sheet.');
    }
}
async function appendHeaderDataToSheet(profileData, databaseId) {
    const sheets = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2d$oauth$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["getSheetsClient"])();
    const headerResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: databaseId,
        range: 'tpList!A1:Q1'
    });
    const headers = headerResponse.data.values?.[0];
    if (!headers) {
        throw new Error('Could not retrieve headers from tpList sheet.');
    }
    const values = [
        headers.map((header)=>profileData[header] || '')
    ];
    const request = {
        spreadsheetId: databaseId,
        range: `tpList!A1`,
        valueInputOption: 'USER_ENTERED',
        resource: {
            values
        }
    };
    try {
        const response = await sheets.spreadsheets.values.append(request);
        console.log('Appended to sheet:', response.data);
        return response.data;
    } catch (err) {
        console.error('The API returned an error: ' + err);
        throw new Error('Failed to append data to Google Sheet.');
    }
}
async function updateHeaderDataInSheet(profileData, databaseId) {
    const sheets = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2d$oauth$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["getSheetsClient"])();
    const range = 'tpList!A:Q';
    const getResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: databaseId,
        range
    });
    const rows = getResponse.data.values;
    if (!rows || rows.length === 0) {
        throw new Error('No data found in the sheet.');
    }
    const headers = rows[0];
    const tinIndex = headers.indexOf('tpTIN');
    if (tinIndex === -1) {
        throw new Error('TIN column not found in the sheet.');
    }
    const rowIndex = rows.findIndex((row)=>row[tinIndex] === profileData.tpTIN);
    if (rowIndex === -1) {
        throw new Error('Profile with the specified TIN not found.');
    }
    const rowToUpdate = rowIndex + 1;
    const values = [
        headers.map((header)=>profileData[header] || '')
    ];
    const request = {
        spreadsheetId: databaseId,
        range: `tpList!A${rowToUpdate}`,
        valueInputOption: 'USER_ENTERED',
        resource: {
            values
        }
    };
    try {
        const response = await sheets.spreadsheets.values.update(request);
        console.log('Updated sheet:', response.data);
        return response.data;
    } catch (err) {
        console.error('The API returned an error: ' + err);
        throw new Error('Failed to update data in Google Sheet.');
    }
}
async function getSheetId(spreadsheetId, sheetName) {
    const sheets = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2d$oauth$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["getSheetsClient"])();
    const response = await sheets.spreadsheets.get({
        spreadsheetId
    });
    const sheet = response.data.sheets?.find((s)=>s.properties?.title === sheetName);
    return sheet?.properties?.sheetId ?? null;
}
async function deleteHeaderDataRowInSheet(tpTIN, databaseId) {
    const sheets = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2d$oauth$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["getSheetsClient"])();
    const sheetName = 'tpList';
    const range = `${sheetName}!A:Q`;
    // 1. Get all data to find the row index
    const getResponse = await sheets.spreadsheets.values.get({
        spreadsheetId: databaseId,
        range
    });
    const rows = getResponse.data.values;
    if (!rows || rows.length === 0) {
        console.log('No data found in the sheet to delete.');
        return;
    }
    const headers = rows[0];
    const tinIndex = headers.indexOf('tpTIN');
    if (tinIndex === -1) {
        throw new Error('TIN column not found in the sheet.');
    }
    const rowIndex = rows.findIndex((row)=>row[tinIndex] === tpTIN);
    if (rowIndex === -1) {
        console.log(`Profile with TIN ${tpTIN} not found for deletion.`);
        return; // Profile not found, so nothing to delete
    }
    // 2. Get the sheetId required for batchUpdate
    const sheetId = await getSheetId(databaseId, sheetName);
    if (sheetId === null) {
        throw new Error(`Sheet with name "${sheetName}" not found.`);
    }
    // 3. Perform batch update to delete the row and add a blank one
    const batchUpdateRequest = {
        spreadsheetId: databaseId,
        resource: {
            requests: [
                {
                    deleteDimension: {
                        range: {
                            sheetId: sheetId,
                            dimension: 'ROWS',
                            startIndex: rowIndex,
                            endIndex: rowIndex + 1
                        }
                    }
                },
                {
                    appendDimension: {
                        sheetId: sheetId,
                        dimension: "ROWS",
                        length: 1
                    }
                }
            ]
        }
    };
    try {
        await sheets.spreadsheets.batchUpdate(batchUpdateRequest);
        console.log(`Successfully deleted row at index ${rowIndex} and added a new one.`);
    } catch (err) {
        console.error('The API returned an error during batch update: ' + err);
        throw new Error('Failed to delete row from Google Sheet.');
    }
}
}}),
"[project]/src/lib/schemas.ts [app-rsc] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "DatFileSchema": (()=>DatFileSchema),
    "MutationResultSchema": (()=>MutationResultSchema),
    "TaxProfileSchema": (()=>TaxProfileSchema)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/zod/lib/index.mjs [app-rsc] (ecmascript)");
;
const alphanumericWithSpaces = (name, length, required = true)=>{
    const schema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().max(length, `${name} must be ${length} characters or less.`).regex(/^[a-zA-Z0-9\s]*$/, `${name} must only contain letters, numbers, and spaces.`);
    if (required) {
        return schema.min(1, `${name} is required.`);
    }
    return schema.optional().or(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].literal(''));
};
const TaxProfileSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].object({
    tpTIN: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().regex(/^[0-9]{9}$/, 'TIN must be 9 digits.'),
    branchCode: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().regex(/^[0-9]{4}$/, 'Branch code must be 4 digits.'),
    rdoCode: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().min(1, 'RDO Code is required.'),
    entityType: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string(),
    cycleType: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string(),
    monthSelect: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().min(1, 'Month is required.'),
    companyName: alphanumericWithSpaces('Company Name', 50, false),
    lastName: alphanumericWithSpaces('Last Name', 30, false),
    firstName: alphanumericWithSpaces('First Name', 30, false),
    middleName: alphanumericWithSpaces('Middle Name', 30, false),
    tradeName: alphanumericWithSpaces('Trade Name', 50),
    subStreet: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().max(30, 'Unit/Floor/Substreet must be 30 characters or less.').optional().or(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].literal('')),
    street: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().max(30, 'Street must be 30 characters or less.').min(1, 'Street is required.'),
    barangay: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().max(30, 'Barangay must be 30 characters or less.').min(1, 'Barangay is required.'),
    cityMunicipality: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().max(30, 'City/Municipality must be 30 characters or less.').min(1, 'City/Municipality is required.'),
    province: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().max(30, 'Province must be 30 characters or less.').min(1, 'Province is required.'),
    zipCode: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().regex(/^[0-9]{4}$/, 'Zip code must be 4 digits.')
}).passthrough().refine((data)=>{
    if (data.entityType === 'Individual') {
        return !!data.lastName && !!data.firstName && !!data.middleName;
    }
    return true;
}, {
    message: "First, Middle, and Last name are required for individuals.",
    path: [
        "lastName"
    ]
}).refine((data)=>{
    if (data.entityType === 'Non-Individual') {
        return !!data.companyName;
    }
    return true;
}, {
    message: "Company name is required for non-individuals.",
    path: [
        "companyName"
    ]
});
const MutationResultSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].object({
    success: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].boolean(),
    error: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().nullable(),
    data: TaxProfileSchema.nullable()
});
const DatFileSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].object({
    id: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string(),
    name: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string(),
    path: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string(),
    modifiedTime: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string()
});
}}),
"[project]/src/lib/drive.ts [app-rsc] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
/* __next_internal_action_entry_do_not_use__ [{"4019d8efc0e8739c514bfb3847f6eef6107aca4d72":"createFolderInDrive","40dd2f09e524554b4ec3a9fff80a021fad2531abc0":"listDatFiles","70864395bb092dc39044827f4dcf80a5be65f97fdf":"checkFileExists","7cada598f594d88c11337b2248ef7320b7b540f236":"uploadFileToDrive"},"",""] */ __turbopack_context__.s({
    "checkFileExists": (()=>checkFileExists),
    "createFolderInDrive": (()=>createFolderInDrive),
    "listDatFiles": (()=>listDatFiles),
    "uploadFileToDrive": (()=>uploadFileToDrive)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/build/webpack/loaders/next-flight-loader/server-reference.js [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$server$2f$app$2d$render$2f$encryption$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/server/app-render/encryption.js [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$googleapis$2f$build$2f$src$2f$index$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/googleapis/build/src/index.js [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2d$oauth$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/drive-oauth.ts [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/build/webpack/loaders/next-flight-loader/action-validate.js [app-rsc] (ecmascript)");
;
;
;
;
async function getDriveClient() {
    const oauth2Client = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2d$oauth$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["getOAuth2Client"])();
    return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$googleapis$2f$build$2f$src$2f$index$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["google"].drive({
        version: 'v3',
        auth: oauth2Client
    });
}
async function createFolderInDrive(name) {
    const drive = await getDriveClient();
    const fileMetadata = {
        name,
        mimeType: 'application/vnd.google-apps.folder'
    };
    try {
        const file = await drive.files.create({
            resource: fileMetadata,
            fields: 'id'
        });
        console.log(`[Drive] Created root folder "${name}" with ID: ${file.data.id}`);
        return file.data.id;
    } catch (error) {
        console.error(`[Drive] Error creating root folder "${name}":`, error);
        throw error;
    }
}
async function findFolder(drive, name, parentId) {
    const query = `mimeType='application/vnd.google-apps.folder' and name='${name.replace(/'/g, "\\'")}' and '${parentId}' in parents and trashed=false`;
    try {
        const res = await drive.files.list({
            q: query,
            fields: 'files(id)',
            spaces: 'drive',
            pageSize: 1
        });
        if (res.data.files && res.data.files.length > 0 && res.data.files[0].id) {
            return res.data.files[0].id;
        }
        return null;
    } catch (error) {
        console.error(`[Drive] Error finding folder "${name}" in parent "${parentId}":`, error);
        return null;
    }
}
async function createFolder(drive, name, parentId) {
    const fileMetadata = {
        name: name,
        mimeType: 'application/vnd.google-apps.folder',
        parents: [
            parentId
        ]
    };
    const folder = await drive.files.create({
        resource: fileMetadata,
        fields: 'id'
    });
    if (!folder.data.id) throw new Error(`Failed to create folder "${name}"`);
    console.log(`[Drive] Created folder "${name}" with ID: ${folder.data.id}.`);
    return folder.data.id;
}
async function getOrCreateFolderByPath(drive, rootFolderId, path) {
    let currentParentId = rootFolderId;
    const datFilesFolderName = 'DATFiles';
    let datFilesFolderId = await findFolder(drive, datFilesFolderName, currentParentId);
    if (!datFilesFolderId) {
        datFilesFolderId = await createFolder(drive, datFilesFolderName, currentParentId);
    }
    currentParentId = datFilesFolderId;
    for (const folderName of path){
        let nextFolderId = await findFolder(drive, folderName, currentParentId);
        if (!nextFolderId) {
            nextFolderId = await createFolder(drive, folderName, currentParentId);
        }
        currentParentId = nextFolderId;
    }
    return currentParentId;
}
async function checkFileExists(fileName, rootFolderId, path) {
    try {
        const drive = await getDriveClient();
        const finalFolderId = await getOrCreateFolderByPath(drive, rootFolderId, path);
        const query = `name='${fileName.replace(/'/g, "\\'")}' and '${finalFolderId}' in parents and trashed=false`;
        const res = await drive.files.list({
            q: query,
            fields: 'files(id)',
            pageSize: 1
        });
        return !!(res.data.files && res.data.files.length > 0);
    } catch (error) {
        console.error(`[Drive] Error checking if file '${fileName}' exists:`, error);
        return false;
    }
}
async function uploadFileToDrive(fileName, fileContent, rootFolderId, path, overwrite = false) {
    try {
        const drive = await getDriveClient();
        const finalFolderId = await getOrCreateFolderByPath(drive, rootFolderId, path);
        console.log(`[Drive] Final folder for upload is '${finalFolderId}'.`);
        const media = {
            mimeType: 'text/plain',
            body: fileContent
        };
        if (overwrite) {
            const query = `name='${fileName.replace(/'/g, "\\'")}' and '${finalFolderId}' in parents and trashed=false`;
            const res = await drive.files.list({
                q: query,
                fields: 'files(id)',
                pageSize: 1
            });
            if (res.data.files && res.data.files.length > 0 && res.data.files[0].id) {
                const fileId = res.data.files[0].id;
                console.log(`[Drive] Overwriting existing file '${fileName}' with ID: ${fileId}`);
                const updatedFile = await drive.files.update({
                    fileId: fileId,
                    media: media,
                    fields: 'id'
                });
                if (!updatedFile.data.id) throw new Error('File update did not return an ID.');
                return updatedFile.data.id;
            }
        }
        // If not overwriting or file doesn't exist, create a new one.
        const fileMetadata = {
            name: fileName,
            parents: [
                finalFolderId
            ]
        };
        const file = await drive.files.create({
            requestBody: fileMetadata,
            media: media,
            fields: 'id'
        });
        if (!file.data.id) throw new Error('File creation did not return an ID.');
        console.log(`[Drive] Successfully uploaded new file '${fileName}', File ID: ${file.data.id}`);
        return file.data.id;
    } catch (error) {
        const errorMessage = error instanceof Error ? error.message : 'An unknown error occurred.';
        console.error(`[Drive] Failed to upload file '${fileName}':`, errorMessage);
        throw new Error(`Failed to upload file to Google Drive: ${errorMessage}`);
    }
}
async function listDatFiles(rootFolderId) {
    const drive = await getDriveClient();
    const allFiles = [];
    // Find the main "DATFiles" folder first
    const datFilesFolderId = await findFolder(drive, 'DATFiles', rootFolderId);
    if (!datFilesFolderId) {
        console.log('[Drive] "DATFiles" folder not found, returning empty list.');
        return []; // No DATFiles folder, so no files to list
    }
    async function searchRecursively(folderId, currentPath) {
        let pageToken = undefined;
        do {
            const res = await drive.files.list({
                q: `'${folderId}' in parents and trashed=false`,
                fields: 'nextPageToken, files(id, name, mimeType, modifiedTime)',
                spaces: 'drive',
                pageToken: pageToken
            });
            for (const file of res.data.files){
                if (file.mimeType === 'application/vnd.google-apps.folder') {
                    await searchRecursively(file.id, [
                        ...currentPath,
                        file.name
                    ]);
                } else if (file.name?.toUpperCase().endsWith('.DAT')) {
                    allFiles.push({
                        id: file.id,
                        name: file.name,
                        path: currentPath.join(' / '),
                        modifiedTime: file.modifiedTime
                    });
                }
            }
            pageToken = res.data.nextPageToken;
        }while (pageToken)
    }
    await searchRecursively(datFilesFolderId, []);
    return allFiles;
}
;
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["ensureServerEntryExports"])([
    createFolderInDrive,
    checkFileExists,
    uploadFileToDrive,
    listDatFiles
]);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerServerReference"])(createFolderInDrive, "4019d8efc0e8739c514bfb3847f6eef6107aca4d72", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerServerReference"])(checkFileExists, "70864395bb092dc39044827f4dcf80a5be65f97fdf", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerServerReference"])(uploadFileToDrive, "7cada598f594d88c11337b2248ef7320b7b540f236", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerServerReference"])(listDatFiles, "40dd2f09e524554b4ec3a9fff80a021fad2531abc0", null);
}}),
"[project]/src/lib/actions.ts [app-rsc] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
/* __next_internal_action_entry_do_not_use__ [{"40098fdfbbb36170895d26f1c11d82363ee9a1b214":"signUpUser","401ce1a9d271208095f87042b1ec2b335fce067d9a":"overwriteDatFile","405640ada876955278e1ad2e9d85009c459c46777d":"validateExcelForPurchases","405c07508d183d72b5368850183fd267f67971612c":"createPurchasesDatFile","40684f4520a7c51a570d419ba1c98670ab6ba52b14":"loginUser","40895842e07ef2f9872e21c8c7ad22133d33c8c849":"convertExcelToDat","40b2e571cd0cb75ab827e90db3316b90dd461882f2":"getUserHeaderData","40e37ac9324786da7f1b62b630be8993e4441f6a02":"getDatFiles","40eadca5c4f32c710e73aff0bf3f9fa61fc3c2f4cb":"analyzeExcelFile","600d25a2a512748645b2ab9e08d882195aee5baea8":"deleteTaxProfile","6043bcb009bc6aa9b83327467834f75494fa1f00b7":"addTaxProfile","60c03a02cedce74d6fc9664d1879a50f2ea48706fa":"updateTaxProfile"},"",""] */ __turbopack_context__.s({
    "addTaxProfile": (()=>addTaxProfile),
    "analyzeExcelFile": (()=>analyzeExcelFile),
    "convertExcelToDat": (()=>convertExcelToDat),
    "createPurchasesDatFile": (()=>createPurchasesDatFile),
    "deleteTaxProfile": (()=>deleteTaxProfile),
    "getDatFiles": (()=>getDatFiles),
    "getUserHeaderData": (()=>getUserHeaderData),
    "loginUser": (()=>loginUser),
    "overwriteDatFile": (()=>overwriteDatFile),
    "signUpUser": (()=>signUpUser),
    "updateTaxProfile": (()=>updateTaxProfile),
    "validateExcelForPurchases": (()=>validateExcelForPurchases)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/build/webpack/loaders/next-flight-loader/server-reference.js [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$server$2f$app$2d$render$2f$encryption$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/server/app-render/encryption.js [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$ai$2f$flows$2f$excel$2d$error$2d$detection$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/ai/flows/excel-error-detection.ts [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$ai$2f$schemas$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/ai/schemas.ts [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/zod/lib/index.mjs [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$googlesheets$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/googlesheets.ts [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$schemas$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/schemas.ts [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$xlsx$2f$xlsx$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/xlsx/xlsx.mjs [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/drive.ts [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/build/webpack/loaders/next-flight-loader/action-validate.js [app-rsc] (ecmascript)");
;
;
;
;
;
;
;
;
;
const AnalyzeFileResultSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].object({
    success: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].boolean(),
    data: __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$ai$2f$schemas$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["ExcelErrorDetectionOutputSchema"].nullable(),
    error: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().nullable()
});
async function analyzeExcelFile(formData) {
    const file = formData.get('file');
    if (!file) {
        return {
            success: false,
            data: null,
            error: 'No file uploaded.'
        };
    }
    // Check file type
    if (file.type !== 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' && file.type !== 'application/vnd.ms-excel') {
        return {
            success: false,
            data: null,
            error: 'Invalid file type. Please upload an Excel file.'
        };
    }
    try {
        const bytes = await file.arrayBuffer();
        const buffer = Buffer.from(bytes);
        const dataUri = `data:${file.type};base64,${buffer.toString('base64')}`;
        const result = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$ai$2f$flows$2f$excel$2d$error$2d$detection$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["excelErrorDetection"])({
            excelDataUri: dataUri
        });
        return {
            success: true,
            data: result,
            error: null
        };
    } catch (e) {
        console.error(e);
        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';
        return {
            success: false,
            data: null,
            error: `Failed to analyze file: ${errorMessage}`
        };
    }
}
const AuthResultSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].object({
    success: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].boolean(),
    error: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().nullable(),
    user: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].object({
        userName: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string(),
        databaseId: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().optional(),
        folderId: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().optional()
    }).nullable()
});
async function signUpUser(userData) {
    try {
        const folderId = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["createFolderInDrive"])(`DATGenie_${userData.userName}`);
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$googlesheets$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["appendUserToSheet"])({
            ...userData,
            folderId
        });
        return {
            success: true,
            error: null,
            user: null
        };
    } catch (e) {
        console.error('Error signing up user:', e);
        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';
        return {
            success: false,
            error: `Failed to sign up: ${errorMessage}`,
            user: null
        };
    }
}
async function loginUser(credentials) {
    try {
        const users = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$googlesheets$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["getAllUsers"])();
        const user = users.find((u)=>u.userName === credentials.userName && u.pwd === credentials.password);
        if (user) {
            let folderId = user.folderId;
            if (!folderId) {
                console.log(`User ${user.userName} does not have a folderId. Creating one now.`);
                folderId = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["createFolderInDrive"])(`DATGenie_${user.userName}`);
                await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$googlesheets$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["updateUserFolderId"])(user.userName, folderId);
                console.log(`Successfully created and assigned folderId ${folderId} to user ${user.userName}.`);
            }
            return {
                success: true,
                error: null,
                user: {
                    userName: user.userName,
                    databaseId: user.databaseId,
                    folderId: folderId
                }
            };
        } else {
            return {
                success: false,
                error: 'Invalid username or password.',
                user: null
            };
        }
    } catch (e) {
        console.error('Error logging in user:', e);
        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';
        return {
            success: false,
            error: `Failed to login: ${errorMessage}`,
            user: null
        };
    }
}
const TaxProfileResultSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].object({
    success: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].boolean(),
    data: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].array(__TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$schemas$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["TaxProfileSchema"]).nullable(),
    error: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().nullable()
});
async function getUserHeaderData(databaseId) {
    try {
        if (!databaseId) {
            return {
                success: false,
                data: null,
                error: 'Database ID is required.'
            };
        }
        const headerData = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$googlesheets$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["getAllHeaderDataFromSheet"])(databaseId);
        return {
            success: true,
            data: headerData,
            error: null
        };
    } catch (error) {
        console.error('Error fetching header data:', error);
        const errorMessage = error instanceof Error ? error.message : 'An unknown error occurred.';
        return {
            success: false,
            data: null,
            error: `Failed to fetch header data: ${errorMessage}`
        };
    }
}
function transformToUppercase(data) {
    const uppercasedData = {};
    for(const key in data){
        const value = data[key];
        if (typeof value === 'string' && key !== 'entityType' && key !== 'cycleType' && key !== 'monthSelect' && key !== 'rdoCode') {
            uppercasedData[key] = value.toUpperCase();
        } else {
            uppercasedData[key] = value;
        }
    }
    return uppercasedData;
}
async function addTaxProfile(profileData, databaseId) {
    try {
        const validatedData = __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$schemas$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["TaxProfileSchema"].parse(profileData);
        const existingProfiles = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$googlesheets$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["getAllHeaderDataFromSheet"])(databaseId);
        const tinExists = existingProfiles.some((p)=>p.tpTIN === validatedData.tpTIN);
        if (tinExists) {
            return {
                success: false,
                error: 'This TIN already has a profile. Please check your data or refresh the page.',
                data: null
            };
        }
        const uppercasedData = transformToUppercase(validatedData);
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$googlesheets$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["appendHeaderDataToSheet"])(uppercasedData, databaseId);
        return {
            success: true,
            error: null,
            data: uppercasedData
        };
    } catch (e) {
        console.error('Error adding tax profile:', e);
        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';
        return {
            success: false,
            error: `Failed to add profile: ${errorMessage}`,
            data: null
        };
    }
}
async function updateTaxProfile(profileData, databaseId) {
    try {
        const validatedData = __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$schemas$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["TaxProfileSchema"].parse(profileData);
        const uppercasedData = transformToUppercase(validatedData);
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$googlesheets$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["updateHeaderDataInSheet"])(uppercasedData, databaseId);
        return {
            success: true,
            error: null,
            data: uppercasedData
        };
    } catch (e) {
        console.error('Error updating tax profile:', e);
        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';
        return {
            success: false,
            error: `Failed to update profile: ${errorMessage}`,
            data: null
        };
    }
}
const SimpleResultSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].object({
    success: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].boolean(),
    error: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().nullable()
});
async function deleteTaxProfile(tpTIN, databaseId) {
    try {
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$googlesheets$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["deleteHeaderDataRowInSheet"])(tpTIN, databaseId);
        return {
            success: true,
            error: null
        };
    } catch (e) {
        console.error('Error deleting tax profile:', e);
        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';
        return {
            success: false,
            error: `Failed to delete profile: ${errorMessage}`
        };
    }
}
const DatFileResultSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].object({
    success: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].boolean(),
    datContent: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().nullable(),
    fileName: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().nullable(),
    error: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().nullable(),
    errors: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].array(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string()).nullable(),
    fileExists: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].boolean().optional(),
    // Sales Totals
    totalExempt: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].number().nullable(),
    totalZeroRated: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].number().nullable(),
    totalTaxableSales: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].number().nullable(),
    totalOutputTax: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].number().nullable(),
    // Purchase Totals
    totalServices: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].number().nullable(),
    totalCapitalGoods: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].number().nullable(),
    totalOtherGoods: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].number().nullable(),
    totalInputTax: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].number().nullable(),
    processedData: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].any().nullable()
});
function sanitizeAndValidateString(input, fieldName, maxLength, rowNumber, isRequired = false) {
    let value = input === null || input === undefined ? '' : String(input).trim();
    if (!value) {
        if (isRequired) {
            return {
                value: '',
                error: `Row ${rowNumber}: ${fieldName} is missing.`
            };
        }
        return {
            value: '',
            error: null
        };
    }
    let processedString = value.toUpperCase().replace(/&/g, 'AND').replace(//g, 'N').replace(/\s\s+/g, ' ').trim().replace(/[^A-Z0-9\s-]/g, '').replace(/\s\s+/g, ' ').trim();
    if (processedString.length > maxLength) {
        return {
            value: processedString,
            error: `Row ${rowNumber}: ${fieldName} must be ${maxLength} characters or less. It is currently ${processedString.length} characters.`
        };
    }
    return {
        value: processedString,
        error: null
    };
}
function sanitizeAndValidateNumber(input, fieldName, rowNumber) {
    if (input === null || input === undefined || String(input).trim() === '') {
        return {
            value: '0',
            error: null
        };
    }
    const valueAsString = String(input).replace(/,/g, '');
    const num = parseFloat(valueAsString);
    if (isNaN(num)) {
        return {
            value: String(input),
            error: `Row ${rowNumber}: ${fieldName} contains an invalid number.`
        };
    }
    const roundedNum = Math.round(num * 100) / 100;
    if (roundedNum === 0) {
        return {
            value: '0',
            error: null
        };
    }
    return {
        value: roundedNum.toFixed(2),
        error: null
    };
}
function getFormattedLastDay(year, month) {
    // Get the last day of the month. This correctly handles leap years.
    const day = new Date(year, month, 0).getDate();
    const date = new Date(year, month - 1, day);
    const mm = String(date.getMonth() + 1).padStart(2, '0');
    const dd = String(date.getDate()).padStart(2, '0');
    const yyyy = date.getFullYear();
    return `${mm}/${dd}/${yyyy}`;
}
const quoteIfNotEmpty = (value)=>{
    const str = String(value || '').trim();
    return str ? `"${str}"` : '';
};
async function processExcelFile(file, sheetName) {
    const bytes = await file.arrayBuffer();
    const workbook = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$xlsx$2f$xlsx$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["read"])(bytes, {
        type: 'array'
    });
    if (!workbook.SheetNames.includes(sheetName)) {
        return {
            data: [],
            validationErrors: [
                `Sheet "${sheetName}" not found in the uploaded file.`
            ]
        };
    }
    const worksheet = workbook.Sheets[sheetName];
    const data = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$xlsx$2f$xlsx$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["utils"].sheet_to_json(worksheet, {
        header: 1,
        defval: '',
        raw: false
    });
    if (data.length <= 1) {
        return {
            data: [],
            validationErrors: [
                "The sheet has no data to process."
            ]
        };
    }
    return {
        data: data.slice(1),
        validationErrors: []
    };
}
async function generateSalesDatFile(file, profile, month, year, folderId, overwrite = false) {
    const { tpTIN: tin } = profile;
    const datFileName = `${tin}S${month}${year}.DAT`;
    const reportTypeShort = "Sales";
    const drivePath = [
        tin,
        reportTypeShort,
        year
    ];
    if (!overwrite) {
        const fileExists = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["checkFileExists"])(datFileName, folderId, drivePath);
        if (fileExists) {
            return {
                success: false,
                fileExists: true,
                fileName: datFileName,
                datContent: null,
                error: null,
                errors: null,
                totalExempt: null,
                totalZeroRated: null,
                totalTaxableSales: null,
                totalOutputTax: null,
                totalServices: null,
                totalCapitalGoods: null,
                totalOtherGoods: null,
                totalInputTax: null,
                processedData: null
            };
        }
    }
    const { data: dataRows, validationErrors: fileErrors } = await processExcelFile(file, "vat_sales");
    if (fileErrors.length > 0) {
        return {
            success: false,
            error: fileErrors[0],
            datContent: null,
            fileName: null,
            errors: null,
            totalExempt: null,
            totalZeroRated: null,
            totalTaxableSales: null,
            totalOutputTax: null,
            totalServices: null,
            totalCapitalGoods: null,
            totalOtherGoods: null,
            totalInputTax: null,
            processedData: null
        };
    }
    const validationErrors = [];
    const processedData = dataRows.map((row, index)=>{
        const originalRowNumber = index + 2;
        const processedRow = [
            ...row
        ];
        if (processedRow.length > 0 && String(processedRow[0]).trim()) {
            const originalTin = String(processedRow[0]);
            const sanitizedTin = originalTin.replace(/[^0-9]/g, '');
            if (sanitizedTin.substring(0, 9) === tin) validationErrors.push(`Row ${originalRowNumber}: The TIN matches the selected profile's TIN. A company cannot make a sale to itself.`);
            if (sanitizedTin.length < 9) validationErrors.push(`Row ${originalRowNumber}: TIN '${originalTin}' is too short. It must be at least 9 digits.`);
            processedRow[0] = sanitizedTin.substring(0, 9);
        } else {
            validationErrors.push(`Row ${originalRowNumber}: TIN is missing.`);
        }
        const nameFieldsInfo = [
            {
                name: 'Registered Name',
                index: 1,
                maxLength: 150,
                required: true
            },
            {
                name: 'Last Name',
                index: 2,
                maxLength: 30,
                required: false
            },
            {
                name: 'First Name',
                index: 3,
                maxLength: 30,
                required: false
            },
            {
                name: 'Middle Name',
                index: 4,
                maxLength: 30,
                required: false
            },
            {
                name: 'Address 1',
                index: 5,
                maxLength: 30,
                required: false
            },
            {
                name: 'Address 2',
                index: 6,
                maxLength: 30,
                required: false
            }
        ];
        nameFieldsInfo.forEach((field)=>{
            const result = sanitizeAndValidateString(processedRow[field.index], field.name, field.maxLength, originalRowNumber, field.required);
            if (result.error) validationErrors.push(result.error);
            processedRow[field.index] = result.value;
        });
        const hasFirstName = String(processedRow[3]).trim().length > 0;
        const hasLastName = String(processedRow[2]).trim().length > 0;
        const hasMiddleName = String(processedRow[4]).trim().length > 0;
        if (hasFirstName && !hasLastName || !hasFirstName && hasLastName) validationErrors.push(`Row ${originalRowNumber}: First Name and Last Name must be provided together.`);
        if (hasMiddleName && (!hasFirstName || !hasLastName)) validationErrors.push(`Row ${originalRowNumber}: If Middle Name is provided, First Name and Last Name are also required.`);
        const numericFields = [
            {
                name: 'Exempt Sales',
                index: 7
            },
            {
                name: 'Zero-Rated Sales',
                index: 8
            },
            {
                name: 'Taxable Sales',
                index: 9
            },
            {
                name: 'Output Tax',
                index: 10
            }
        ];
        numericFields.forEach((field)=>{
            const result = sanitizeAndValidateNumber(processedRow[field.index], field.name, originalRowNumber);
            if (result.error) validationErrors.push(result.error);
            processedRow[field.index] = result.value;
        });
        if (parseFloat(processedRow[7]) === 0 && parseFloat(processedRow[8]) === 0 && parseFloat(processedRow[9]) === 0) {
            validationErrors.push(`Row ${originalRowNumber}: At least one sales amount (Exempt, Zero-Rated, or Taxable) must be greater than zero.`);
        }
        return processedRow;
    });
    if (validationErrors.length > 0) {
        return {
            success: false,
            errors: validationErrors,
            error: "Validation failed.",
            datContent: null,
            fileName: null,
            totalExempt: null,
            totalZeroRated: null,
            totalTaxableSales: null,
            totalOutputTax: null,
            totalServices: null,
            totalCapitalGoods: null,
            totalOtherGoods: null,
            totalInputTax: null,
            processedData: null
        };
    }
    const lastDayDate = getFormattedLastDay(parseInt(year), parseInt(month));
    const address1 = [
        profile.subStreet,
        profile.street,
        profile.barangay
    ].filter(Boolean).join(' ');
    const address2 = [
        profile.cityMunicipality,
        profile.province,
        profile.zipCode
    ].filter(Boolean).join(' ');
    const detailRows = processedData.map((row)=>[
            'D',
            'S',
            quoteIfNotEmpty(row[0]),
            quoteIfNotEmpty(row[1]),
            quoteIfNotEmpty(row[2]),
            quoteIfNotEmpty(row[3]),
            quoteIfNotEmpty(row[4]),
            quoteIfNotEmpty(row[5]),
            quoteIfNotEmpty(row[6]),
            row[7],
            row[8],
            row[9],
            row[10],
            tin,
            lastDayDate
        ].join(',')).join('\n');
    const totalExempt = processedData.reduce((acc, row)=>acc + parseFloat(row[7]), 0);
    const totalZeroRated = processedData.reduce((acc, row)=>acc + parseFloat(row[8]), 0);
    const totalTaxableSales = processedData.reduce((acc, row)=>acc + parseFloat(row[9]), 0);
    const totalOutputTax = processedData.reduce((acc, row)=>acc + parseFloat(row[10]), 0);
    const headerRow = [
        'H',
        'S',
        quoteIfNotEmpty(tin),
        quoteIfNotEmpty(profile.companyName),
        quoteIfNotEmpty(profile.lastName),
        quoteIfNotEmpty(profile.firstName),
        quoteIfNotEmpty(profile.middleName),
        quoteIfNotEmpty(profile.tradeName),
        quoteIfNotEmpty(address1),
        quoteIfNotEmpty(address2),
        totalExempt.toFixed(2),
        totalZeroRated.toFixed(2),
        totalTaxableSales.toFixed(2),
        totalOutputTax.toFixed(2),
        profile.rdoCode,
        lastDayDate,
        profile.monthSelect
    ].join(',');
    const datContent = `${headerRow}\n${detailRows}`;
    // Non-blocking upload
    (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["uploadFileToDrive"])(datFileName, datContent, folderId, drivePath, overwrite).catch(console.error);
    return {
        success: true,
        datContent,
        fileName: datFileName,
        totalExempt,
        totalZeroRated,
        totalTaxableSales,
        totalOutputTax,
        error: null,
        errors: null,
        totalServices: null,
        totalCapitalGoods: null,
        totalOtherGoods: null,
        totalInputTax: null,
        processedData: null
    };
}
async function convertExcelToDat(formData) {
    const file = formData.get('file');
    const reportType = formData.get('reportType');
    const month = formData.get('month');
    const year = formData.get('year');
    const profileString = formData.get('profile');
    const folderId = formData.get('folderId');
    const defaultErrorResult = {
        success: false,
        datContent: null,
        fileName: null,
        errors: null,
        error: null,
        totalExempt: null,
        totalZeroRated: null,
        totalTaxableSales: null,
        totalOutputTax: null,
        totalServices: null,
        totalCapitalGoods: null,
        totalOtherGoods: null,
        totalInputTax: null,
        processedData: null
    };
    if (!file || !reportType || !month || !year || !profileString || !folderId) {
        return {
            ...defaultErrorResult,
            error: 'Missing required parameters for conversion.'
        };
    }
    try {
        const profile = JSON.parse(profileString);
        if (reportType === "Summary of Sales (SLS)") {
            return await generateSalesDatFile(file, profile, month, year, folderId, false);
        }
        return {
            ...defaultErrorResult,
            error: `Report type "${reportType}" is not yet supported.`
        };
    } catch (e) {
        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred during conversion.';
        console.error('[convertExcelToDat] CRITICAL ERROR:', e);
        return {
            ...defaultErrorResult,
            error: `Conversion failed: ${errorMessage}`
        };
    }
}
async function overwriteDatFile(formData) {
    const file = formData.get('file');
    const reportType = formData.get('reportType');
    const month = formData.get('month');
    const year = formData.get('year');
    const profileString = formData.get('profile');
    const folderId = formData.get('folderId');
    const processedDataString = formData.get('processedData');
    const nonCreditableTaxString = formData.get('nonCreditableInputTax');
    const defaultErrorResult = {
        success: false,
        datContent: null,
        fileName: null,
        errors: null,
        error: null,
        totalExempt: null,
        totalZeroRated: null,
        totalTaxableSales: null,
        totalOutputTax: null,
        totalServices: null,
        totalCapitalGoods: null,
        totalOtherGoods: null,
        totalInputTax: null,
        processedData: null
    };
    if (!reportType || !month || !year || !profileString || !folderId) {
        return {
            ...defaultErrorResult,
            error: 'Missing required parameters for overwrite.'
        };
    }
    const profile = JSON.parse(profileString);
    try {
        // This function now only generates the content and returns it immediately.
        // The file upload will be handled by a separate background function.
        if (reportType === "Summary of Sales (SLS)") {
            if (!file) return {
                ...defaultErrorResult,
                error: 'Missing file for overwrite.'
            };
            return await generateSalesDatFile(file, profile, month, year, folderId, true);
        }
        if (reportType === "Summary of Purchases (SLP)") {
            if (!processedDataString || nonCreditableTaxString === null) return {
                ...defaultErrorResult,
                error: 'Missing processed data for overwrite.'
            };
            const processedData = JSON.parse(processedDataString);
            const nonCreditableInputTax = parseFloat(nonCreditableTaxString);
            return await generatePurchasesDatFile(processedData, profile, month, year, nonCreditableInputTax, folderId, true);
        }
        return {
            ...defaultErrorResult,
            error: `Report type "${reportType}" is not yet supported for overwrite.`
        };
    } catch (e) {
        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred during overwrite.';
        console.error('[overwriteDatFile] CRITICAL ERROR:', e);
        return {
            ...defaultErrorResult,
            error: `Overwrite failed: ${errorMessage}`
        };
    }
}
async function validateExcelForPurchases(formData) {
    const file = formData.get('file');
    const profileString = formData.get('profile');
    const profile = JSON.parse(profileString);
    const { tpTIN: tin } = profile;
    const defaultErrorResult = {
        success: false,
        datContent: null,
        fileName: null,
        errors: null,
        error: null,
        totalExempt: null,
        totalZeroRated: null,
        totalTaxableSales: null,
        totalOutputTax: null,
        totalServices: null,
        totalCapitalGoods: null,
        totalOtherGoods: null,
        totalInputTax: null,
        processedData: null
    };
    const { data: dataRows, validationErrors: fileErrors } = await processExcelFile(file, "vat_purchases");
    if (fileErrors.length > 0) return {
        ...defaultErrorResult,
        error: fileErrors[0]
    };
    const validationErrors = [];
    const processedData = dataRows.map((row, index)=>{
        const originalRowNumber = index + 2;
        const processedRow = [
            ...row
        ];
        if (String(processedRow[0] || '').trim()) {
            const originalTin = String(processedRow[0]);
            const sanitizedTin = originalTin.replace(/[^0-9]/g, '');
            if (sanitizedTin.substring(0, 9) === tin) validationErrors.push(`Row ${originalRowNumber}: The TIN matches the selected profile's TIN. A company cannot have a purchase from itself.`);
            if (sanitizedTin.length < 9) validationErrors.push(`Row ${originalRowNumber}: TIN '${originalTin}' is too short. It must be at least 9 digits.`);
            processedRow[0] = sanitizedTin.substring(0, 9);
        } else {
            validationErrors.push(`Row ${originalRowNumber}: TIN is missing.`);
        }
        const nameFieldsInfo = [
            {
                name: 'Registered Name',
                index: 1,
                maxLength: 150,
                required: true
            },
            {
                name: 'Last Name',
                index: 2,
                maxLength: 30,
                required: false
            },
            {
                name: 'First Name',
                index: 3,
                maxLength: 30,
                required: false
            },
            {
                name: 'Middle Name',
                index: 4,
                maxLength: 30,
                required: false
            },
            {
                name: 'Address 1',
                index: 5,
                maxLength: 30,
                required: false
            },
            {
                name: 'Address 2',
                index: 6,
                maxLength: 30,
                required: false
            }
        ];
        nameFieldsInfo.forEach((field)=>{
            const result = sanitizeAndValidateString(processedRow[field.index], field.name, field.maxLength, originalRowNumber, field.required);
            if (result.error) validationErrors.push(result.error);
            processedRow[field.index] = result.value;
        });
        const hasFirstName = String(processedRow[3]).trim().length > 0;
        const hasLastName = String(processedRow[2]).trim().length > 0;
        const hasMiddleName = String(processedRow[4]).trim().length > 0;
        if (hasFirstName && !hasLastName || !hasFirstName && hasLastName) validationErrors.push(`Row ${originalRowNumber}: First Name and Last Name must be provided together.`);
        if (hasMiddleName && (!hasFirstName || !hasLastName)) validationErrors.push(`Row ${originalRowNumber}: If Middle Name is provided, First Name and Last Name are also required.`);
        const numericFields = [
            {
                name: 'Exempt Purchases',
                index: 7
            },
            {
                name: 'Zero-Rated Purchases',
                index: 8
            },
            {
                name: 'Purchases of Services',
                index: 9
            },
            {
                name: 'Purchases of Capital Goods',
                index: 10
            },
            {
                name: 'Purchases of Other Goods',
                index: 11
            },
            {
                name: 'Input Tax',
                index: 12
            }
        ];
        numericFields.forEach((field)=>{
            const result = sanitizeAndValidateNumber(processedRow[field.index], field.name, originalRowNumber);
            if (result.error) validationErrors.push(result.error);
            processedRow[field.index] = result.value;
        });
        if (parseFloat(processedRow[7]) === 0 && parseFloat(processedRow[8]) === 0 && parseFloat(processedRow[9]) === 0 && parseFloat(processedRow[10]) === 0 && parseFloat(processedRow[11]) === 0) {
            validationErrors.push(`Row ${originalRowNumber}: At least one purchase amount must be greater than zero.`);
        }
        return processedRow;
    });
    if (validationErrors.length > 0) {
        return {
            ...defaultErrorResult,
            success: false,
            errors: validationErrors
        };
    }
    const totalInputTax = processedData.reduce((acc, row)=>acc + parseFloat(row[12]), 0);
    return {
        ...defaultErrorResult,
        success: true,
        totalInputTax,
        processedData
    };
}
async function generatePurchasesDatFile(processedData, profile, month, year, nonCreditableInputTax, folderId, overwrite = false) {
    const { tpTIN: tin } = profile;
    const datFileName = `${tin}P${month}${year}.DAT`;
    const reportTypeShort = "Purchases";
    const drivePath = [
        tin,
        reportTypeShort,
        year
    ];
    if (!overwrite) {
        const fileExists = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["checkFileExists"])(datFileName, folderId, drivePath);
        if (fileExists) {
            return {
                success: false,
                fileExists: true,
                fileName: datFileName,
                datContent: null,
                error: null,
                errors: null,
                totalExempt: null,
                totalZeroRated: null,
                totalTaxableSales: null,
                totalOutputTax: null,
                totalServices: null,
                totalCapitalGoods: null,
                totalOtherGoods: null,
                totalInputTax: null,
                processedData: null
            };
        }
    }
    const lastDayDate = getFormattedLastDay(parseInt(year), parseInt(month));
    const address1 = [
        profile.subStreet,
        profile.street,
        profile.barangay
    ].filter(Boolean).join(' ');
    const address2 = [
        profile.cityMunicipality,
        profile.province,
        profile.zipCode
    ].filter(Boolean).join(' ');
    const detailRows = processedData.map((row)=>[
            'D',
            'P',
            quoteIfNotEmpty(row[0]),
            quoteIfNotEmpty(row[1]),
            quoteIfNotEmpty(row[2]),
            quoteIfNotEmpty(row[3]),
            quoteIfNotEmpty(row[4]),
            quoteIfNotEmpty(row[5]),
            quoteIfNotEmpty(row[6]),
            row[7],
            row[8],
            row[9],
            row[10],
            row[11],
            row[12],
            tin,
            lastDayDate
        ].join(',')).join('\n');
    const totalExempt = processedData.reduce((acc, row)=>acc + parseFloat(row[7]), 0);
    const totalZeroRated = processedData.reduce((acc, row)=>acc + parseFloat(row[8]), 0);
    const totalServices = processedData.reduce((acc, row)=>acc + parseFloat(row[9]), 0);
    const totalCapitalGoods = processedData.reduce((acc, row)=>acc + parseFloat(row[10]), 0);
    const totalOtherGoods = processedData.reduce((acc, row)=>acc + parseFloat(row[11]), 0);
    const totalInputTax = processedData.reduce((acc, row)=>acc + parseFloat(row[12]), 0);
    const creditableInputTax = totalInputTax - nonCreditableInputTax;
    const headerRow = [
        'H',
        'P',
        quoteIfNotEmpty(tin),
        quoteIfNotEmpty(profile.companyName),
        quoteIfNotEmpty(profile.lastName),
        quoteIfNotEmpty(profile.firstName),
        quoteIfNotEmpty(profile.middleName),
        quoteIfNotEmpty(profile.tradeName),
        quoteIfNotEmpty(address1),
        quoteIfNotEmpty(address2),
        totalExempt.toFixed(2),
        totalZeroRated.toFixed(2),
        totalServices.toFixed(2),
        totalCapitalGoods.toFixed(2),
        totalOtherGoods.toFixed(2),
        totalInputTax.toFixed(2),
        creditableInputTax.toFixed(2),
        nonCreditableInputTax.toFixed(2),
        profile.rdoCode,
        lastDayDate,
        profile.monthSelect
    ].join(',');
    const datContent = `${headerRow}\n${detailRows}`;
    // Non-blocking upload
    (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["uploadFileToDrive"])(datFileName, datContent, folderId, drivePath, overwrite).catch(console.error);
    return {
        success: true,
        datContent,
        fileName: datFileName,
        totalExempt,
        totalZeroRated,
        totalServices,
        totalCapitalGoods,
        totalOtherGoods,
        totalInputTax,
        error: null,
        errors: null,
        totalTaxableSales: null,
        totalOutputTax: null,
        processedData: null
    };
}
async function createPurchasesDatFile(formData) {
    const processedDataString = formData.get('processedData');
    const profileString = formData.get('profile');
    const month = formData.get('month');
    const year = formData.get('year');
    const nonCreditableInputTaxString = formData.get('nonCreditableInputTax');
    const folderId = formData.get('folderId');
    const defaultErrorResult = {
        success: false,
        datContent: null,
        fileName: null,
        errors: null,
        error: null,
        totalExempt: null,
        totalZeroRated: null,
        totalTaxableSales: null,
        totalOutputTax: null,
        totalServices: null,
        totalCapitalGoods: null,
        totalOtherGoods: null,
        totalInputTax: null,
        processedData: null
    };
    if (!processedDataString || !profileString || !month || !year || nonCreditableInputTaxString === null || !folderId) {
        return {
            ...defaultErrorResult,
            error: 'Missing required parameters for purchase file creation.'
        };
    }
    try {
        const processedData = JSON.parse(processedDataString);
        const profile = JSON.parse(profileString);
        const nonCreditableInputTax = parseFloat(nonCreditableInputTaxString);
        return await generatePurchasesDatFile(processedData, profile, month, year, nonCreditableInputTax, folderId, false);
    } catch (e) {
        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred during DAT file creation.';
        console.error('[createPurchasesDatFile] CRITICAL ERROR:', e);
        return {
            ...defaultErrorResult,
            error: `Creation failed: ${errorMessage}`
        };
    }
}
const DatFileListingResultSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].object({
    success: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].boolean(),
    files: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].array(__TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$schemas$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["DatFileSchema"]).nullable(),
    error: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["z"].string().nullable()
});
async function getDatFiles(folderId) {
    if (!folderId) {
        return {
            success: false,
            files: null,
            error: 'User folder ID is missing.'
        };
    }
    try {
        const files = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$drive$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["listDatFiles"])(folderId);
        return {
            success: true,
            files,
            error: null
        };
    } catch (e) {
        console.error('[getDatFiles] CRITICAL ERROR:', e);
        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';
        return {
            success: false,
            files: null,
            error: `Failed to retrieve DAT files: ${errorMessage}`
        };
    }
}
;
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["ensureServerEntryExports"])([
    analyzeExcelFile,
    signUpUser,
    loginUser,
    getUserHeaderData,
    addTaxProfile,
    updateTaxProfile,
    deleteTaxProfile,
    convertExcelToDat,
    overwriteDatFile,
    validateExcelForPurchases,
    createPurchasesDatFile,
    getDatFiles
]);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerServerReference"])(analyzeExcelFile, "40eadca5c4f32c710e73aff0bf3f9fa61fc3c2f4cb", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerServerReference"])(signUpUser, "40098fdfbbb36170895d26f1c11d82363ee9a1b214", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerServerReference"])(loginUser, "40684f4520a7c51a570d419ba1c98670ab6ba52b14", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerServerReference"])(getUserHeaderData, "40b2e571cd0cb75ab827e90db3316b90dd461882f2", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerServerReference"])(addTaxProfile, "6043bcb009bc6aa9b83327467834f75494fa1f00b7", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerServerReference"])(updateTaxProfile, "60c03a02cedce74d6fc9664d1879a50f2ea48706fa", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerServerReference"])(deleteTaxProfile, "600d25a2a512748645b2ab9e08d882195aee5baea8", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerServerReference"])(convertExcelToDat, "40895842e07ef2f9872e21c8c7ad22133d33c8c849", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerServerReference"])(overwriteDatFile, "401ce1a9d271208095f87042b1ec2b335fce067d9a", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerServerReference"])(validateExcelForPurchases, "405640ada876955278e1ad2e9d85009c459c46777d", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerServerReference"])(createPurchasesDatFile, "405c07508d183d72b5368850183fd267f67971612c", null);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerServerReference"])(getDatFiles, "40e37ac9324786da7f1b62b630be8993e4441f6a02", null);
}}),
"[project]/.next-internal/server/app/login/page/actions.js { ACTIONS_MODULE0 => \"[project]/src/lib/actions.ts [app-rsc] (ecmascript)\" } [app-rsc] (server actions loader, ecmascript) <locals>": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({});
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$actions$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/actions.ts [app-rsc] (ecmascript)");
;
}}),
"[project]/.next-internal/server/app/login/page/actions.js { ACTIONS_MODULE0 => \"[project]/src/lib/actions.ts [app-rsc] (ecmascript)\" } [app-rsc] (server actions loader, ecmascript) <module evaluation>": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({});
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$actions$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/actions.ts [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f2e$next$2d$internal$2f$server$2f$app$2f$login$2f$page$2f$actions$2e$js__$7b$__ACTIONS_MODULE0__$3d3e$__$225b$project$5d2f$src$2f$lib$2f$actions$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$2922$__$7d$__$5b$app$2d$rsc$5d$__$28$server__actions__loader$2c$__ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i('[project]/.next-internal/server/app/login/page/actions.js { ACTIONS_MODULE0 => "[project]/src/lib/actions.ts [app-rsc] (ecmascript)" } [app-rsc] (server actions loader, ecmascript) <locals>');
}}),
"[project]/.next-internal/server/app/login/page/actions.js { ACTIONS_MODULE0 => \"[project]/src/lib/actions.ts [app-rsc] (ecmascript)\" } [app-rsc] (server actions loader, ecmascript) <exports>": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "40684f4520a7c51a570d419ba1c98670ab6ba52b14": (()=>__TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$actions$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["loginUser"])
});
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$actions$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/actions.ts [app-rsc] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f2e$next$2d$internal$2f$server$2f$app$2f$login$2f$page$2f$actions$2e$js__$7b$__ACTIONS_MODULE0__$3d3e$__$225b$project$5d2f$src$2f$lib$2f$actions$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$2922$__$7d$__$5b$app$2d$rsc$5d$__$28$server__actions__loader$2c$__ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i('[project]/.next-internal/server/app/login/page/actions.js { ACTIONS_MODULE0 => "[project]/src/lib/actions.ts [app-rsc] (ecmascript)" } [app-rsc] (server actions loader, ecmascript) <locals>');
}}),
"[project]/.next-internal/server/app/login/page/actions.js { ACTIONS_MODULE0 => \"[project]/src/lib/actions.ts [app-rsc] (ecmascript)\" } [app-rsc] (server actions loader, ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "40684f4520a7c51a570d419ba1c98670ab6ba52b14": (()=>__TURBOPACK__imported__module__$5b$project$5d2f2e$next$2d$internal$2f$server$2f$app$2f$login$2f$page$2f$actions$2e$js__$7b$__ACTIONS_MODULE0__$3d3e$__$225b$project$5d2f$src$2f$lib$2f$actions$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$2922$__$7d$__$5b$app$2d$rsc$5d$__$28$server__actions__loader$2c$__ecmascript$29$__$3c$exports$3e$__["40684f4520a7c51a570d419ba1c98670ab6ba52b14"])
});
var __TURBOPACK__imported__module__$5b$project$5d2f2e$next$2d$internal$2f$server$2f$app$2f$login$2f$page$2f$actions$2e$js__$7b$__ACTIONS_MODULE0__$3d3e$__$225b$project$5d2f$src$2f$lib$2f$actions$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$2922$__$7d$__$5b$app$2d$rsc$5d$__$28$server__actions__loader$2c$__ecmascript$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i('[project]/.next-internal/server/app/login/page/actions.js { ACTIONS_MODULE0 => "[project]/src/lib/actions.ts [app-rsc] (ecmascript)" } [app-rsc] (server actions loader, ecmascript) <module evaluation>');
var __TURBOPACK__imported__module__$5b$project$5d2f2e$next$2d$internal$2f$server$2f$app$2f$login$2f$page$2f$actions$2e$js__$7b$__ACTIONS_MODULE0__$3d3e$__$225b$project$5d2f$src$2f$lib$2f$actions$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$2922$__$7d$__$5b$app$2d$rsc$5d$__$28$server__actions__loader$2c$__ecmascript$29$__$3c$exports$3e$__ = __turbopack_context__.i('[project]/.next-internal/server/app/login/page/actions.js { ACTIONS_MODULE0 => "[project]/src/lib/actions.ts [app-rsc] (ecmascript)" } [app-rsc] (server actions loader, ecmascript) <exports>');
}}),
"[project]/src/app/favicon.ico.mjs { IMAGE => \"[project]/src/app/favicon.ico (static in ecmascript)\" } [app-rsc] (structured image object, ecmascript, Next.js server component)": ((__turbopack_context__) => {

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.n(__turbopack_context__.i("[project]/src/app/favicon.ico.mjs { IMAGE => \"[project]/src/app/favicon.ico (static in ecmascript)\" } [app-rsc] (structured image object, ecmascript)"));
}}),
"[project]/src/app/layout.tsx [app-rsc] (ecmascript, Next.js server component)": ((__turbopack_context__) => {

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.n(__turbopack_context__.i("[project]/src/app/layout.tsx [app-rsc] (ecmascript)"));
}}),
"[project]/src/app/login/page.tsx (client reference/proxy) <module evaluation>": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "default": (()=>__TURBOPACK__default__export__)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2d$edge$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-edge.js [app-rsc] (ecmascript)");
;
const __TURBOPACK__default__export__ = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2d$edge$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerClientReference"])(function() {
    throw new Error("Attempted to call the default export of [project]/src/app/login/page.tsx <module evaluation> from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.");
}, "[project]/src/app/login/page.tsx <module evaluation>", "default");
}}),
"[project]/src/app/login/page.tsx (client reference/proxy)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "default": (()=>__TURBOPACK__default__export__)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2d$edge$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-edge.js [app-rsc] (ecmascript)");
;
const __TURBOPACK__default__export__ = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$server$2f$route$2d$modules$2f$app$2d$page$2f$vendored$2f$rsc$2f$react$2d$server$2d$dom$2d$turbopack$2d$server$2d$edge$2e$js__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__["registerClientReference"])(function() {
    throw new Error("Attempted to call the default export of [project]/src/app/login/page.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.");
}, "[project]/src/app/login/page.tsx", "default");
}}),
"[project]/src/app/login/page.tsx [app-rsc] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$app$2f$login$2f$page$2e$tsx__$28$client__reference$2f$proxy$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/src/app/login/page.tsx (client reference/proxy) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$app$2f$login$2f$page$2e$tsx__$28$client__reference$2f$proxy$29$__ = __turbopack_context__.i("[project]/src/app/login/page.tsx (client reference/proxy)");
;
__turbopack_context__.n(__TURBOPACK__imported__module__$5b$project$5d2f$src$2f$app$2f$login$2f$page$2e$tsx__$28$client__reference$2f$proxy$29$__);
}}),
"[project]/src/app/login/page.tsx [app-rsc] (ecmascript, Next.js server component)": ((__turbopack_context__) => {

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.n(__turbopack_context__.i("[project]/src/app/login/page.tsx [app-rsc] (ecmascript)"));
}}),

};

//# sourceMappingURL=%5Broot-of-the-server%5D__55b00d45._.js.map
{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 183, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/drive-oauth.ts"],"sourcesContent":["\nimport { google } from 'googleapis';\n\nconst {\n  GOOGLE_OAUTH_CLIENT_ID,\n  GOOGLE_OAUTH_CLIENT_SECRET,\n  GOOGLE_OAUTH_REFRESH_TOKEN,\n} = process.env;\n\nif (!GOOGLE_OAUTH_CLIENT_ID || !GOOGLE_OAUTH_CLIENT_SECRET || !GOOGLE_OAUTH_REFRESH_TOKEN) {\n  // This check is important but shouldn't throw an error that crashes the server on startup,\n  // as the credentials might not be used on every page load.\n  // We will let the functions that use it handle the error.\n  console.warn('Google OAuth credentials are not fully configured in .env. Some Drive/Sheets features may not work.');\n}\n\n// This is a fixed value for web applications\nconst GOOGLE_OAUTH_REDIRECT_URI = 'https://developers.google.com/oauthplayground';\n\nlet oauth2Client: import('google-auth-library').OAuth2Client | null = null;\n\nexport async function getOAuth2Client() {\n  // Add the check here to provide a clear error when the credentials are used.\n  if (!GOOGLE_OAUTH_CLIENT_ID || !GOOGLE_OAUTH_CLIENT_SECRET || !GOOGLE_OAUTH_REFRESH_TOKEN) {\n    throw new Error('Google OAuth credentials (CLIENT_ID, CLIENT_SECRET, REFRESH_TOKEN) must be configured in your .env file.');\n  }\n  \n  if (oauth2Client) {\n    // Check if the token is about to expire (within 60 seconds) and refresh if needed\n    if (oauth2Client.credentials.expiry_date && oauth2Client.credentials.expiry_date < (Date.now() + 60 * 1000)) {\n        console.log('[OAuth] Access token expiring soon, refreshing...');\n        await oauth2Client.refreshAccessToken();\n        console.log('[OAuth] Access token refreshed.');\n    }\n    return oauth2Client;\n  }\n\n  const client = new google.auth.OAuth2(\n    GOOGLE_OAUTH_CLIENT_ID,\n    GOOGLE_OAUTH_CLIENT_SECRET,\n    GOOGLE_OAUTH_REDIRECT_URI\n  );\n\n  client.setCredentials({\n    refresh_token: GOOGLE_OAUTH_REFRESH_TOKEN,\n  });\n\n  // Do an initial token refresh to get the access token\n  try {\n    console.log('[OAuth] Initializing and refreshing access token...');\n    await client.refreshAccessToken();\n    console.log('[OAuth] Initial token refreshed successfully.');\n  } catch (error) {\n    console.error('[OAuth] Failed to refresh access token:', error);\n    throw new Error('Failed to refresh access token. Check your refresh token and credentials.');\n  }\n\n  oauth2Client = client;\n  return oauth2Client;\n}\n\nexport async function getSheetsClient() {\n    const oauth2Client = await getOAuth2Client();\n    return google.sheets({ version: 'v4', auth: oauth2Client });\n}\n"],"names":[],"mappings":";;;;AACA;;AAEA,MAAM,EACJ,sBAAsB,EACtB,0BAA0B,EAC1B,0BAA0B,EAC3B,GAAG,QAAQ,GAAG;AAEf,IAAI,CAAC,0BAA0B,CAAC,8BAA8B,CAAC,4BAA4B;IACzF,2FAA2F;IAC3F,2DAA2D;IAC3D,0DAA0D;IAC1D,QAAQ,IAAI,CAAC;AACf;AAEA,6CAA6C;AAC7C,MAAM,4BAA4B;AAElC,IAAI,eAAkE;AAE/D,eAAe;IACpB,6EAA6E;IAC7E,IAAI,CAAC,0BAA0B,CAAC,8BAA8B,CAAC,4BAA4B;QACzF,MAAM,IAAI,MAAM;IAClB;IAEA,IAAI,cAAc;QAChB,kFAAkF;QAClF,IAAI,aAAa,WAAW,CAAC,WAAW,IAAI,aAAa,WAAW,CAAC,WAAW,GAAI,KAAK,GAAG,KAAK,KAAK,MAAO;YACzG,QAAQ,GAAG,CAAC;YACZ,MAAM,aAAa,kBAAkB;YACrC,QAAQ,GAAG,CAAC;QAChB;QACA,OAAO;IACT;IAEA,MAAM,SAAS,IAAI,mJAAA,CAAA,SAAM,CAAC,IAAI,CAAC,MAAM,CACnC,wBACA,4BACA;IAGF,OAAO,cAAc,CAAC;QACpB,eAAe;IACjB;IAEA,sDAAsD;IACtD,IAAI;QACF,QAAQ,GAAG,CAAC;QACZ,MAAM,OAAO,kBAAkB;QAC/B,QAAQ,GAAG,CAAC;IACd,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2CAA2C;QACzD,MAAM,IAAI,MAAM;IAClB;IAEA,eAAe;IACf,OAAO;AACT;AAEO,eAAe;IAClB,MAAM,eAAe,MAAM;IAC3B,OAAO,mJAAA,CAAA,SAAM,CAAC,MAAM,CAAC;QAAE,SAAS;QAAM,MAAM;IAAa;AAC7D","debugId":null}},
    {"offset": {"line": 242, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/googlesheets.ts"],"sourcesContent":["\nimport { z } from 'zod';\nimport type { TaxProfile, UserUpdateData, SessionInfo } from './schemas';\nimport { getSheetsClient } from './drive-oauth';\nimport { headers } from 'next/headers';\n\nconst signupSchema = z.object({\n  userName: z.string(),\n  email: z.string().email(),\n  password: z.string(),\n  folderId: z.string(),\n});\n\nconst loginSchema = z.object({\n  userName: z.string(),\n  password: z.string(),\n});\n\nexport type SignupData = z.infer<typeof signupSchema>;\nexport type LoginData = z.infer<typeof loginSchema>;\n\n\nconst {\n  GOOGLE_SHEETS_SHEET_ID,\n} = process.env;\n\nif (!GOOGLE_SHEETS_SHEET_ID) {\n  throw new Error('GOOGLE_SHEETS_SHEET_ID is not configured in .env');\n}\n\nconst SPREADSHEET_ID = GOOGLE_SHEETS_SHEET_ID;\nconst CREDENTIALS_SHEET_NAME = 'credentials';\nconst SESSIONS_SHEET_NAME = 'ActiveSessions';\n\nexport async function appendUserToSheet(userData: SignupData) {\n  const { email, userName, password, folderId } = userData;\n  const timestamp = new Date().toISOString();\n  const sheets = await getSheetsClient();\n\n  const values = [[email, userName, password, '', folderId, 'active', timestamp, '']];\n\n  const request = {\n    spreadsheetId: SPREADSHEET_ID,\n    range: `${CREDENTIALS_SHEET_NAME}!A1`, \n    valueInputOption: 'USER_ENTERED',\n    resource: {\n      values,\n    },\n  };\n\n  try {\n    const response = await sheets.spreadsheets.values.append(request);\n    console.log('Appended to sheet:', response.data);\n    return response.data;\n  } catch (err) {\n    console.error('The API returned an error: ' + err);\n    throw new Error('Failed to append data to Google Sheet.');\n  }\n}\n\nexport async function getAllUsers() {\n    try {\n        const sheets = await getSheetsClient();\n        const response = await sheets.spreadsheets.values.get({\n            spreadsheetId: SPREADSHEET_ID,\n            range: CREDENTIALS_SHEET_NAME,\n        });\n\n        const rows = response.data.values;\n        if (!rows || rows.length === 0) {\n            return [];\n        }\n\n        const header = rows[0];\n        const emailIndex = header.indexOf('emailAddress');\n        const userNameIndex = header.indexOf('userName');\n        const pwdIndex = header.indexOf('pwd');\n        const databaseIdIndex = header.indexOf('databaseID');\n        const folderIdIndex = header.indexOf('folderID');\n\n        if (userNameIndex === -1 || pwdIndex === -1 || emailIndex === -1 || databaseIdIndex === -1 || folderIdIndex === -1) {\n            throw new Error('Could not find required columns in the credentials sheet.');\n        }\n\n        return rows.slice(1).map(row => ({\n            emailAddress: row[emailIndex] || '',\n            userName: row[userNameIndex] || '',\n            pwd: row[pwdIndex] || '',\n            databaseId: row[databaseIdIndex] || '',\n            folderId: row[folderIdIndex] || '',\n        }));\n\n    } catch (err) {\n        console.error('The API returned an error: ' + err);\n        throw new Error('Failed to retrieve data from Google Sheet.');\n    }\n}\n\nexport async function updateUserFolderId(userName: string, folderId: string) {\n    const sheets = await getSheetsClient();\n    const range = `${CREDENTIALS_SHEET_NAME}!A:H`; \n    const response = await sheets.spreadsheets.values.get({\n        spreadsheetId: SPREADSHEET_ID,\n        range,\n    });\n\n    const rows = response.data.values;\n    if (!rows || rows.length === 0) {\n        throw new Error('No users found in credentials sheet.');\n    }\n\n    const header = rows[0];\n    const userNameIndex = header.indexOf('userName');\n    const folderIdIndex = header.indexOf('folderID');\n\n    if (userNameIndex === -1 || folderIdIndex === -1) {\n        throw new Error('userName or folderID column not found.');\n    }\n\n    const userRowIndex = rows.findIndex(row => row[userNameIndex] === userName);\n    if (userRowIndex === -1) {\n        throw new Error(`User ${userName} not found.`);\n    }\n\n    const rowToUpdate = userRowIndex + 1;\n    const columnToUpdate = String.fromCharCode('A'.charCodeAt(0) + folderIdIndex);\n\n    await sheets.spreadsheets.values.update({\n        spreadsheetId: SPREADSHEET_ID,\n        range: `${CREDENTIALS_SHEET_NAME}!${columnToUpdate}${rowToUpdate}`,\n        valueInputOption: 'RAW',\n        resource: {\n            values: [[folderId]],\n        },\n    });\n}\n\n\nexport async function getAllHeaderDataFromSheet(databaseId: string): Promise<TaxProfile[]> {\n  try {\n    const sheets = await getSheetsClient();\n    const response = await sheets.spreadsheets.values.get({\n      spreadsheetId: databaseId,\n      range: 'tpList!A:Q',\n    });\n\n    const rows = response.data.values;\n    if (!rows || rows.length < 2) {\n      return [];\n    }\n\n    const header = rows[0];\n    const dataRows = rows.slice(1);\n    \n    const objects = dataRows\n        .map(row => {\n            const rowData: { [key: string]: any } = {};\n            header.forEach((key, headerIndex) => {\n                rowData[key] = row[headerIndex] || '';\n            });\n            return rowData as TaxProfile;\n        })\n        .filter(profile => profile.tpTIN && typeof profile.tpTIN === 'string' && profile.tpTIN.trim() !== '');\n\n    return objects;\n\n  } catch (err) {\n    console.error(`The API returned an error for spreadsheet ${databaseId}: ` + err);\n    throw new Error('Failed to retrieve header data from Google Sheet.');\n  }\n}\n\nexport async function appendHeaderDataToSheet(profileData: TaxProfile, databaseId: string) {\n  const sheets = await getSheetsClient();\n  const headerResponse = await sheets.spreadsheets.values.get({\n    spreadsheetId: databaseId,\n    range: 'tpList!A1:Q1',\n  });\n  \n  const headers = headerResponse.data.values?.[0];\n  if (!headers) {\n    throw new Error('Could not retrieve headers from tpList sheet.');\n  }\n\n  const values = [headers.map(header => profileData[header as keyof TaxProfile] || '')];\n\n  const request = {\n    spreadsheetId: databaseId,\n    range: `tpList!A1`,\n    valueInputOption: 'USER_ENTERED',\n    resource: {\n      values,\n    },\n  };\n\n  try {\n    const response = await sheets.spreadsheets.values.append(request);\n    console.log('Appended to sheet:', response.data);\n    return response.data;\n  } catch (err) {\n    console.error('The API returned an error: ' + err);\n    throw new Error('Failed to append data to Google Sheet.');\n  }\n}\n\nexport async function updateHeaderDataInSheet(profileData: TaxProfile, databaseId: string) {\n  const sheets = await getSheetsClient();\n  const range = 'tpList!A:Q';\n  const getResponse = await sheets.spreadsheets.values.get({\n    spreadsheetId: databaseId,\n    range,\n  });\n\n  const rows = getResponse.data.values;\n  if (!rows || rows.length === 0) {\n    throw new Error('No data found in the sheet.');\n  }\n\n  const headers = rows[0];\n  const tinIndex = headers.indexOf('tpTIN');\n  if (tinIndex === -1) {\n    throw new Error('TIN column not found in the sheet.');\n  }\n  \n  const rowIndex = rows.findIndex(row => row[tinIndex] === profileData.tpTIN);\n\n  if (rowIndex === -1) {\n    throw new Error('Profile with the specified TIN not found.');\n  }\n  \n  const rowToUpdate = rowIndex + 1;\n  const values = [headers.map(header => profileData[header as keyof TaxProfile] || '')];\n\n  const request = {\n    spreadsheetId: databaseId,\n    range: `tpList!A${rowToUpdate}`,\n    valueInputOption: 'USER_ENTERED',\n    resource: {\n      values,\n    },\n  };\n\n  try {\n    const response = await sheets.spreadsheets.values.update(request);\n    console.log('Updated sheet:', response.data);\n    return response.data;\n  } catch (err) {\n    console.error('The API returned an error: ' + err);\n    throw new Error('Failed to update data in Google Sheet.');\n  }\n}\n\nasync function getSheetId(spreadsheetId: string, sheetName: string): Promise<number | null> {\n    const sheets = await getSheetsClient();\n    const response = await sheets.spreadsheets.get({\n        spreadsheetId,\n    });\n    const sheet = response.data.sheets?.find(s => s.properties?.title === sheetName);\n    return sheet?.properties?.sheetId ?? null;\n}\n\nexport async function deleteHeaderDataRowInSheet(tpTIN: string, databaseId: string) {\n  const sheets = await getSheetsClient();\n  const sheetName = 'tpList';\n  const range = `${sheetName}!A:Q`;\n\n  const getResponse = await sheets.spreadsheets.values.get({\n    spreadsheetId: databaseId,\n    range,\n  });\n\n  const rows = getResponse.data.values;\n  if (!rows || rows.length === 0) {\n    console.log('No data found in the sheet to delete.');\n    return;\n  }\n\n  const headers = rows[0];\n  const tinIndex = headers.indexOf('tpTIN');\n  if (tinIndex === -1) {\n    throw new Error('TIN column not found in the sheet.');\n  }\n\n  const rowIndex = rows.findIndex(row => row[tinIndex] === tpTIN);\n\n  if (rowIndex === -1) {\n    console.log(`Profile with TIN ${tpTIN} not found for deletion.`);\n    return;\n  }\n\n  const sheetId = await getSheetId(databaseId, sheetName);\n  if (sheetId === null) {\n      throw new Error(`Sheet with name \"${sheetName}\" not found.`);\n  }\n\n  const batchUpdateRequest = {\n    spreadsheetId: databaseId,\n    resource: {\n      requests: [\n        {\n          deleteDimension: {\n            range: {\n              sheetId: sheetId,\n              dimension: 'ROWS',\n              startIndex: rowIndex, \n              endIndex: rowIndex + 1\n            }\n          }\n        },\n        {\n          appendDimension: {\n            sheetId: sheetId,\n            dimension: \"ROWS\",\n            length: 1\n          }\n        }\n      ]\n    }\n  };\n\n  try {\n    await sheets.spreadsheets.batchUpdate(batchUpdateRequest);\n    console.log(`Successfully deleted row at index ${rowIndex} and added a new one.`);\n  } catch (err) {\n    console.error('The API returned an error during batch update: ' + err);\n    throw new Error('Failed to delete row from Google Sheet.');\n  }\n}\n\n\nexport async function updateUserDataInSheet(currentUserName: string, updates: UserUpdateData) {\n    const sheets = await getSheetsClient();\n    const range = `${CREDENTIALS_SHEET_NAME}!A:H`; \n    const response = await sheets.spreadsheets.values.get({\n        spreadsheetId: SPREADSHEET_ID,\n        range,\n    });\n\n    const rows = response.data.values;\n    if (!rows || rows.length === 0) {\n        throw new Error('No users found in credentials sheet.');\n    }\n\n    const header = rows[0];\n    const userNameIndex = header.indexOf('userName');\n    const pwdIndex = header.indexOf('pwd');\n\n    if (userNameIndex === -1 || pwdIndex === -1) {\n        throw new Error('Required columns (userName, pwd) not found.');\n    }\n\n    const userRowIndex = rows.findIndex(row => row[userNameIndex] === currentUserName);\n    if (userRowIndex === -1) {\n        throw new Error(`User '${currentUserName}' not found.`);\n    }\n\n    const rowToUpdate = userRowIndex + 1;\n    const userRow = [...rows[userRowIndex]];\n\n    if (updates.newPassword) {\n        if (!updates.currentPassword) {\n            throw new Error(\"Current password is required to change password.\");\n        }\n        if (userRow[pwdIndex] !== updates.currentPassword) {\n            throw new Error(\"Incorrect current password.\");\n        }\n        userRow[pwdIndex] = updates.newPassword;\n    }\n\n    if (updates.newUserName) {\n         const isUserNameTaken = rows.slice(1).some((row, index) => index !== userRowIndex -1 && row[userNameIndex] === updates.newUserName);\n         if (isUserNameTaken) {\n            throw new Error(`Username '${updates.newUserName}' is already taken.`);\n         }\n        userRow[userNameIndex] = updates.newUserName;\n    }\n\n    const updateRequest = {\n        spreadsheetId: SPREADSHEET_ID,\n        range: `${CREDENTIALS_SHEET_NAME}!A${rowToUpdate}:H${rowToUpdate}`,\n        valueInputOption: 'RAW',\n        resource: {\n            values: [userRow],\n        },\n    };\n\n    await sheets.spreadsheets.values.update(updateRequest);\n    console.log(`Successfully updated user data for '${currentUserName}'. New username: '${updates.newUserName || currentUserName}'`);\n}\n\n// ============== ActiveSessions Sheet Functions ==============\n\nexport async function addSessionToSheet(sessionData: {\n  userName: string;\n  sessionToken: string;\n  ipAddress: string;\n  deviceInfo: string;\n}) {\n  const { userName, sessionToken, ipAddress, deviceInfo } = sessionData;\n  const loginTime = new Date().toISOString();\n  const sheets = await getSheetsClient();\n  const sheetName = SESSIONS_SHEET_NAME;\n\n  // First, find and delete any existing session for the same user on the same device\n  const getResponse = await sheets.spreadsheets.values.get({\n    spreadsheetId: SPREADSHEET_ID,\n    range: `${sheetName}!A:E`,\n  });\n\n  const rows = getResponse.data.values;\n  if (rows && rows.length > 1) { // Check if there's more than a header\n    const header = rows[0];\n    const userNameIndex = header.indexOf('userName');\n    const deviceInfoIndex = header.indexOf('deviceInfo');\n\n    const existingSessionRowIndex = rows.findIndex(\n      (row, index) => index > 0 && row[userNameIndex] === userName && row[deviceInfoIndex] === deviceInfo\n    );\n\n    if (existingSessionRowIndex !== -1) {\n      console.log(`[Sessions] Found existing session for ${userName} on device. Removing before adding new one.`);\n      const sheetId = await getSheetId(SPREADSHEET_ID, sheetName);\n      if (sheetId === null) {\n        throw new Error(`Sheet with name \"${sheetName}\" not found.`);\n      }\n\n      await sheets.spreadsheets.batchUpdate({\n        spreadsheetId: SPREADSHEET_ID,\n        resource: {\n          requests: [{\n            deleteDimension: {\n              range: {\n                sheetId,\n                dimension: 'ROWS',\n                startIndex: existingSessionRowIndex,\n                endIndex: existingSessionRowIndex + 1,\n              },\n            },\n          }],\n        },\n      });\n    }\n  }\n\n  // Now, append the new session\n  const values = [[userName, sessionToken, loginTime, ipAddress, deviceInfo]];\n  const appendRequest = {\n    spreadsheetId: SPREADSHEET_ID,\n    range: `${sheetName}!A1`,\n    valueInputOption: 'USER_ENTERED',\n    resource: {\n      values,\n    },\n  };\n\n  try {\n    await sheets.spreadsheets.values.append(appendRequest);\n    console.log(`[Sessions] Added new session for user ${userName}`);\n  } catch (err) {\n    console.error('The API returned an error while adding a session: ' + err);\n    throw new Error('Failed to add session to Google Sheet.');\n  }\n}\n\nexport async function getSessionsByUserName(userName: string): Promise<SessionInfo[]> {\n    const sheets = await getSheetsClient();\n    const response = await sheets.spreadsheets.values.get({\n        spreadsheetId: SPREADSHEET_ID,\n        range: SESSIONS_SHEET_NAME,\n    });\n\n    const rows = response.data.values;\n    if (!rows || rows.length < 2) return [];\n\n    const header = rows[0];\n    const userNameIndex = header.indexOf('userName');\n    const tokenIndex = header.indexOf('sessionToken');\n    const timeIndex = header.indexOf('loginTime');\n    const ipIndex = header.indexOf('ipAddress');\n    const deviceIndex = header.indexOf('deviceInfo');\n\n    return rows.slice(1)\n        .filter(row => row[userNameIndex] === userName)\n        .map(row => ({\n            token: row[tokenIndex],\n            loginTime: row[timeIndex],\n            ipAddress: row[ipIndex],\n            deviceInfo: row[deviceIndex],\n        }));\n}\n\nasync function findRowIndexByToken(token: string): Promise<{ sheetId: number, rowIndex: number }> {\n    const sheets = await getSheetsClient();\n    const sheetName = SESSIONS_SHEET_NAME;\n\n    const response = await sheets.spreadsheets.values.get({\n        spreadsheetId: SPREADSHEET_ID,\n        range: `${sheetName}!B:B`, // Only need to check the token column\n    });\n\n    const rows = response.data.values;\n    if (!rows) throw new Error('Could not find session.');\n\n    const rowIndex = rows.findIndex(row => row[0] === token);\n    if (rowIndex === -1) throw new Error('Session token not found.');\n\n    const sheetId = await getSheetId(SPREADSHEET_ID, sheetName);\n    if (sheetId === null) throw new Error('Could not find sheet ID for sessions.');\n    \n    return { sheetId, rowIndex };\n}\n\nexport async function findUserByTokenFromSheet(token: string): Promise<{ userName: string } | null> {\n    const sheets = await getSheetsClient();\n    const range = `${SESSIONS_SHEET_NAME}!A:B`; // userName and sessionToken columns\n    const response = await sheets.spreadsheets.values.get({\n        spreadsheetId: SPREADSHEET_ID,\n        range,\n    });\n\n    const rows = response.data.values;\n    if (!rows || rows.length < 2) return null;\n\n    const header = rows[0];\n    const userNameIndex = header.indexOf('userName');\n    const tokenIndex = header.indexOf('sessionToken');\n\n    const sessionRow = rows.slice(1).find(row => row[tokenIndex] === token);\n\n    if (sessionRow) {\n        return { userName: sessionRow[userNameIndex] };\n    }\n    return null;\n}\n\n\nexport async function deleteSessionByToken(token: string) {\n    const { sheetId, rowIndex } = await findRowIndexByToken(token);\n    \n    const sheets = await getSheetsClient();\n    await sheets.spreadsheets.batchUpdate({\n        spreadsheetId: SPREADSHEET_ID,\n        resource: {\n            requests: [{\n                deleteDimension: {\n                    range: {\n                        sheetId,\n                        dimension: 'ROWS',\n                        startIndex: rowIndex,\n                        endIndex: rowIndex + 1,\n                    },\n                },\n            }],\n        },\n    });\n    console.log(`[Sessions] Deleted session with token ending in ...${token.slice(-4)}`);\n}\n\nexport async function deleteAllOtherSessionsByToken(currentToken: string) {\n    const sheets = await getSheetsClient();\n    const range = `${SESSIONS_SHEET_NAME}!A:E`;\n    const response = await sheets.spreadsheets.values.get({\n        spreadsheetId: SPREADSHEET_ID,\n        range,\n    });\n\n    const rows = response.data.values;\n    if (!rows || rows.length < 2) return;\n\n    const header = rows[0];\n    const tokenIndex = header.indexOf('sessionToken');\n    const userNameIndex = header.indexOf('userName');\n    \n    const currentUserRow = rows.find(row => row[tokenIndex] === currentToken);\n    if (!currentUserRow) return; // Current session not found, do nothing.\n\n    const currentUserName = currentUserRow[userNameIndex];\n\n    const sheetId = await getSheetId(SPREADSHEET_ID, SESSIONS_SHEET_NAME);\n    if (sheetId === null) throw new Error('Could not find sheet ID.');\n\n    const deleteRequests = rows\n        .map((row, index) => ({ row, index }))\n        .filter(({ row }) => row[userNameIndex] === currentUserName && row[tokenIndex] !== currentToken)\n        .map(({ index }) => ({\n            deleteDimension: {\n                range: {\n                    sheetId,\n                    dimension: 'ROWS',\n                    startIndex: index,\n                    endIndex: index + 1,\n                },\n            },\n        }))\n        // We need to process deletions from bottom to top to avoid shifting indices.\n        .reverse(); \n\n    if (deleteRequests.length > 0) {\n        await sheets.spreadsheets.batchUpdate({\n            spreadsheetId: SPREADSHEET_ID,\n            resource: { requests: deleteRequests },\n        });\n        console.log(`[Sessions] Deleted ${deleteRequests.length} other session(s) for user ${currentUserName}`);\n    }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 792, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/drive.ts"],"sourcesContent":["\n'use server';\n\nimport { google } from 'googleapis';\nimport type { drive_v3 } from 'googleapis';\nimport { getOAuth2Client } from './drive-oauth';\nimport type { DatFile } from './schemas';\n\n\nasync function getDriveClient(): Promise<drive_v3.Drive> {\n    const oauth2Client = await getOAuth2Client();\n    return google.drive({ version: 'v3', auth: oauth2Client });\n}\n\n/**\n * Creates a root folder for a user.\n * @param name The name of the folder to create.\n * @returns The ID of the created folder.\n */\nexport async function createFolderInDrive(name: string): Promise<string> {\n    const drive = await getDriveClient();\n    const fileMetadata = {\n        name,\n        mimeType: 'application/vnd.google-apps.folder',\n    };\n    try {\n        const file = await drive.files.create({\n            resource: fileMetadata,\n            fields: 'id',\n        });\n        console.log(`[Drive] Created root folder \"${name}\" with ID: ${file.data.id}`);\n        return file.data.id!;\n    } catch (error) {\n        console.error(`[Drive] Error creating root folder \"${name}\":`, error);\n        throw error;\n    }\n}\n\nasync function findFolder(drive: drive_v3.Drive, name: string, parentId: string): Promise<string | null> {\n    const query = `mimeType='application/vnd.google-apps.folder' and name='${name.replace(/'/g, \"\\\\'\")}' and '${parentId}' in parents and trashed=false`;\n    try {\n        const res = await drive.files.list({\n            q: query,\n            fields: 'files(id)',\n            spaces: 'drive',\n            pageSize: 1,\n        });\n        if (res.data.files && res.data.files.length > 0 && res.data.files[0].id) {\n            return res.data.files[0].id;\n        }\n        return null;\n    } catch (error) {\n        console.error(`[Drive] Error finding folder \"${name}\" in parent \"${parentId}\":`, error);\n        return null;\n    }\n}\n\nasync function createFolder(drive: drive_v3.Drive, name: string, parentId: string): Promise<string> {\n    const fileMetadata = {\n        name: name,\n        mimeType: 'application/vnd.google-apps.folder',\n        parents: [parentId],\n    };\n    const folder = await drive.files.create({\n        resource: fileMetadata,\n        fields: 'id',\n    });\n    if (!folder.data.id) throw new Error(`Failed to create folder \"${name}\"`);\n    console.log(`[Drive] Created folder \"${name}\" with ID: ${folder.data.id}.`);\n    return folder.data.id;\n}\n\n\nasync function getOrCreateFolderByPath(drive: drive_v3.Drive, rootFolderId: string, path: string[]): Promise<string> {\n    let currentParentId = rootFolderId;\n    \n    const datFilesFolderName = 'DATFiles';\n    let datFilesFolderId = await findFolder(drive, datFilesFolderName, currentParentId);\n    if (!datFilesFolderId) {\n        datFilesFolderId = await createFolder(drive, datFilesFolderName, currentParentId);\n    }\n    currentParentId = datFilesFolderId;\n\n    for (const folderName of path) {\n        let nextFolderId = await findFolder(drive, folderName, currentParentId);\n        if (!nextFolderId) {\n            nextFolderId = await createFolder(drive, folderName, currentParentId);\n        }\n        currentParentId = nextFolderId;\n    }\n    return currentParentId;\n}\n\nexport async function checkFileExists(fileName: string, rootFolderId: string, path: string[]): Promise<boolean> {\n    try {\n        const drive = await getDriveClient();\n        const finalFolderId = await getOrCreateFolderByPath(drive, rootFolderId, path);\n        const query = `name='${fileName.replace(/'/g, \"\\\\'\")}' and '${finalFolderId}' in parents and trashed=false`;\n        \n        const res = await drive.files.list({\n            q: query,\n            fields: 'files(id)',\n            pageSize: 1,\n        });\n\n        return !!(res.data.files && res.data.files.length > 0);\n    } catch (error) {\n        console.error(`[Drive] Error checking if file '${fileName}' exists:`, error);\n        return false;\n    }\n}\n\n/**\n * Uploads or updates a file in a specific Google Drive folder path.\n * @param fileName The name of the file.\n * @param fileContent The content of the file.\n * @param rootFolderId The ID of the user's root folder in Drive.\n * @param path An array representing the folder path inside \"DATFiles\".\n * @param overwrite If true, will update the existing file. If false, will not upload if file exists.\n * @returns The DatFile object for the created/updated file.\n */\nexport async function uploadFileToDrive(fileName: string, fileContent: string, rootFolderId: string, path: string[], overwrite: boolean = false): Promise<DatFile> {\n  try {\n    const drive = await getDriveClient();\n    const finalFolderId = await getOrCreateFolderByPath(drive, rootFolderId, path);\n    console.log(`[Drive] Final folder for upload is '${finalFolderId}'.`);\n\n    const media = {\n        mimeType: 'text/plain',\n        body: fileContent,\n    };\n    \n    const fileFields = 'id, name, modifiedTime';\n\n    if (overwrite) {\n        const query = `name='${fileName.replace(/'/g, \"\\\\'\")}' and '${finalFolderId}' in parents and trashed=false`;\n        const res = await drive.files.list({ q: query, fields: 'files(id)', pageSize: 1 });\n\n        if (res.data.files && res.data.files.length > 0 && res.data.files[0].id) {\n            const fileId = res.data.files[0].id;\n            console.log(`[Drive] Overwriting existing file '${fileName}' with ID: ${fileId}`);\n            const updatedFile = await drive.files.update({\n                fileId: fileId,\n                media: media,\n                fields: fileFields,\n            });\n            if (!updatedFile.data.id || !updatedFile.data.name || !updatedFile.data.modifiedTime) {\n                throw new Error('File update did not return complete data.');\n            }\n             return { id: updatedFile.data.id, name: updatedFile.data.name, path: path.join(' / '), modifiedTime: updatedFile.data.modifiedTime };\n        }\n    }\n    \n    // If not overwriting or file doesn't exist, create a new one.\n    const fileMetadata = {\n      name: fileName,\n      parents: [finalFolderId],\n    };\n\n    const file = await drive.files.create({\n      requestBody: fileMetadata,\n      media: media,\n      fields: fileFields,\n    });\n\n    if (!file.data.id || !file.data.name || !file.data.modifiedTime) {\n        throw new Error('File creation did not return complete data.');\n    }\n    console.log(`[Drive] Successfully uploaded new file '${fileName}', File ID: ${file.data.id}`);\n    return { id: file.data.id, name: file.data.name, path: path.join(' / '), modifiedTime: file.data.modifiedTime };\n\n  } catch (error) {\n    const errorMessage = error instanceof Error ? error.message : 'An unknown error occurred.';\n    console.error(`[Drive] Failed to upload file '${fileName}':`, errorMessage);\n    throw new Error(`Failed to upload file to Google Drive: ${errorMessage}`);\n  }\n}\n\n/**\n * Lists all .DAT files within a user's DATFiles directory structure and all subfolder IDs.\n * @param rootFolderId The root folder ID for the user.\n * @returns A list of file details and a list of all folder IDs within the DATFiles structure.\n */\nexport async function listDatFiles(rootFolderId: string): Promise<{ files: DatFile[]; folderIds: string[] }> {\n    const drive = await getDriveClient();\n\n    const datFilesFolderId = await findFolder(drive, \"DATFiles\", rootFolderId);\n    if (!datFilesFolderId) {\n        console.log('[Drive] \"DATFiles\" folder not found, returning empty list.');\n        return { files: [], folderIds: [] };\n    }\n\n    const folderMap = new Map<string, { name: string; parentId: string }>();\n    const allFiles: DatFile[] = [];\n    const allFolderIds = new Set<string>([datFilesFolderId]);\n\n    async function walkFolders(folderId: string): Promise<void> {\n        let pageToken: string | undefined = undefined;\n        do {\n            const res = await drive.files.list({\n                q: `'${folderId}' in parents and trashed=false`,\n                fields: \"nextPageToken, files(id, name, mimeType, modifiedTime, parents)\",\n                spaces: \"drive\",\n                pageToken,\n                pageSize: 1000,\n            });\n\n            const folderPromises: Promise<void>[] = [];\n\n            if (res.data.files) {\n                for (const file of res.data.files) {\n                    if (file.mimeType === \"application/vnd.google-apps.folder\") {\n                        if (file.id) {\n                            allFolderIds.add(file.id);\n                            if (file.parents && file.parents.length > 0) {\n                                folderMap.set(file.id, { name: file.name!, parentId: file.parents[0] });\n                            }\n                            folderPromises.push(walkFolders(file.id));\n                        }\n                    } else if (file.name?.endsWith(\".DAT\")) {\n                        let pathParts: string[] = [];\n                        let currentParentId = file.parents?.[0];\n\n                        while (currentParentId && currentParentId !== datFilesFolderId) {\n                            const parentFolder = folderMap.get(currentParentId);\n                            if (parentFolder) {\n                                pathParts.unshift(parentFolder.name);\n                                currentParentId = parentFolder.parentId;\n                            } else {\n                                break;\n                            }\n                        }\n\n                        allFiles.push({\n                            id: file.id!,\n                            name: file.name!,\n                            path: pathParts.join(\" / \"),\n                            modifiedTime: file.modifiedTime!,\n                        });\n                    }\n                }\n            }\n            await Promise.all(folderPromises);\n            pageToken = res.data.nextPageToken;\n        } while (pageToken);\n    }\n\n    folderMap.set(datFilesFolderId, { name: \"DATFiles\", parentId: rootFolderId });\n    await walkFolders(datFilesFolderId);\n\n    return { files: allFiles, folderIds: Array.from(allFolderIds) };\n}\n\n\n\n/**\n * Downloads the content of a file from Google Drive.\n * @param fileId The ID of the file to download.\n * @returns The content of the file as a string.\n */\nexport async function downloadFileFromDrive(fileId: string): Promise<string> {\n    const drive = await getDriveClient();\n    try {\n        const response = await drive.files.get(\n            { fileId: fileId, alt: 'media' },\n            { responseType: 'stream' }\n        );\n\n        return new Promise((resolve, reject) => {\n            let buf: any[] = [];\n            response.data\n                .on('data', (chunk) => buf.push(chunk))\n                .on('end', () => {\n                    const content = Buffer.concat(buf).toString();\n                    resolve(content);\n                })\n                .on('error', (err) => {\n                    console.error(`[Drive] Error downloading file ${fileId}:`, err);\n                    reject(err);\n                });\n        });\n\n    } catch (error: any) {\n        if (error.code === 404) {\n            throw new Error('File not found.');\n        }\n        console.error(`[Drive] API error on download for file ${fileId}:`, error);\n        throw error;\n    }\n}\n\n\n/**\n * Deletes a file from Google Drive permanently.\n * @param fileId The ID of the file to delete.\n */\nexport async function deleteFileFromDrive(fileId: string): Promise<void> {\n    const drive = await getDriveClient();\n    try {\n        await drive.files.delete({\n            fileId: fileId,\n        });\n        console.log(`[Drive] Successfully deleted file with ID: ${fileId}`);\n    } catch (error: any) {\n        if (error.code === 404) {\n            throw new Error('File not found.');\n        }\n        console.error(`[Drive] Error deleting file ${fileId}:`, error);\n        throw error;\n    }\n}\n\n/**\n * Gets the starting page token for the changes feed for the entire user's Drive.\n * @returns The starting page token.\n */\nexport async function getInitialPageTokenForDrive(): Promise<string> {\n    const drive = await getDriveClient();\n    try {\n        const response = await drive.changes.getStartPageToken({\n             supportsAllDrives: true,\n        });\n        if (!response.data.startPageToken) {\n            throw new Error('Failed to get a start page token.');\n        }\n        return response.data.startPageToken;\n    } catch (error) {\n        console.error('[Drive] Error getting initial page token:', error);\n        throw error;\n    }\n}\n\n/**\n * Lists changes for a user's account and checks if they are relevant to the user's folder structure.\n * @param allFolderIds An array of all folder IDs that belong to the user's DAT file structure.\n * @param pageToken The page token from which to retrieve changes.\n * @returns An object with hasChanges boolean and the new page token.\n */\nexport async function listChangesSincePageToken(\n    allFolderIds: string[],\n    pageToken: string\n): Promise<{ hasChanges: boolean; newPageToken: string }> {\n    const drive = await getDriveClient();\n    let newPageToken = pageToken;\n    let hasRelevantChanges = false;\n    let lastResponse: any;\n\n    try {\n        const folderIdSet = new Set(allFolderIds);\n\n        do {\n            lastResponse = await drive.changes.list({\n                pageToken: newPageToken,\n                spaces: \"drive\",\n                fields: \"nextPageToken, newStartPageToken, changes(fileId, removed, file(name, parents, mimeType))\",\n                includeItemsFromAllDrives: true,\n                supportsAllDrives: true,\n            });\n\n            const changes = lastResponse.data.changes || [];\n\n            if (changes.length > 0) {\n                const relevantChange = changes.some((c: any) => {\n                    // A file was deleted. We can't know its parent, so we must refresh.\n                    if (c.removed) return true; \n\n                    if (c.file && c.file.parents) {\n                        // Check if the file's parent is one of our tracked folders.\n                        const parentIsTracked = c.file.parents.some((p: string) => folderIdSet.has(p));\n                        if (parentIsTracked) {\n                            // It's a folder or a .DAT file within our structure\n                            if (c.file.mimeType === 'application/vnd.google-apps.folder' || c.file.name?.toUpperCase().endsWith(\".DAT\")) {\n                                return true;\n                            }\n                        }\n                    }\n                    return false;\n                });\n\n                if (relevantChange) {\n                    hasRelevantChanges = true;\n                    break; \n                }\n            }\n\n            if (lastResponse.data.nextPageToken) {\n                newPageToken = lastResponse.data.nextPageToken;\n            } else {\n                break;\n            }\n        } while (lastResponse.data.nextPageToken);\n\n        const finalToken = lastResponse.data.newStartPageToken || newPageToken;\n\n        return { hasChanges: hasRelevantChanges, newPageToken: finalToken };\n    } catch (error) {\n        console.error(\"[Drive] Error listing changes:\", error);\n        return { hasChanges: false, newPageToken: pageToken };\n    }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1179, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/actions/auth.ts"],"sourcesContent":["\n'use server';\n\nimport { \n    appendUserToSheet, \n    getAllUsers, \n    type SignupData, \n    type LoginData, \n    updateUserFolderId, \n    getAllHeaderDataFromSheet,\n    addSessionToSheet,\n    deleteSessionByToken,\n} from '../googlesheets';\nimport { createFolderInDrive } from '../drive';\nimport { z } from 'zod';\nimport { headers, cookies } from 'next/headers';\nimport { randomUUID } from 'crypto';\n\n\nconst AuthResultSchema = z.object({\n    success: z.boolean(),\n    error: z.string().nullable(),\n    user: z.object({\n        userName: z.string(),\n        email: z.string().optional(),\n        databaseId: z.string().optional(),\n        folderId: z.string().optional(),\n    }).nullable(),\n});\n\ntype AuthResult = z.infer<typeof AuthResultSchema>;\n\nexport async function signUpUser(userData: SignupData): Promise<AuthResult> {\n  try {\n    const folderId = await createFolderInDrive(`DATGenie_${userData.userName}`);\n    await appendUserToSheet({ ...userData, folderId });\n    return { success: true, error: null, user: null };\n  } catch (e) {\n    console.error('Error signing up user:', e);\n    const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';\n    return { success: false, error: `Failed to sign up: ${errorMessage}`, user: null };\n  }\n}\n\nexport async function loginUser(credentials: LoginData): Promise<AuthResult> {\n    try {\n        const users = await getAllUsers();\n        const user = users.find(u => u.userName === credentials.userName && u.pwd === credentials.password);\n\n        if (user) {\n            let folderId = user.folderId;\n            if (!folderId) {\n                console.log(`User ${user.userName} does not have a folderId. Creating one now.`);\n                folderId = await createFolderInDrive(`DATGenie_${user.userName}`);\n                await updateUserFolderId(user.userName, folderId);\n                console.log(`Successfully created and assigned folderId ${folderId} to user ${user.userName}.`);\n            }\n            const sheetId = process.env.GOOGLE_SHEETS_SHEET_ID;\n            if (!sheetId) {\n                 return { success: false, error: 'Google Sheet ID is not configured in the environment.', user: null };\n            }\n\n            if (user.databaseId) {\n                 try {\n                    await getAllHeaderDataFromSheet(user.databaseId);\n                } catch(sheetError) {\n                    console.error(`Failed to access sheet with ID ${user.databaseId}`, sheetError);\n                    return { success: false, error: 'Failed to retrieve data from Google Sheet. Check Sheet ID and permissions.', user: null };\n                }\n            }\n            \n            const sessionToken = randomUUID();\n            const headersList = headers();\n            const ipAddress = headersList.get('x-forwarded-for') || 'Unknown';\n            const deviceInfo = headersList.get('user-agent') || 'Unknown';\n\n            await addSessionToSheet({\n                userName: user.userName,\n                sessionToken,\n                ipAddress,\n                deviceInfo,\n            });\n            \n            cookies().set('sessionToken', sessionToken, {\n                httpOnly: true,\n                secure: process.env.NODE_ENV === 'production',\n                maxAge: 60 * 60 * 24 * 7, // One week\n                path: '/',\n            });\n\n            return { \n                success: true, \n                error: null, \n                user: { \n                    userName: user.userName, \n                    email: user.emailAddress, \n                    databaseId: user.databaseId, \n                    folderId: folderId,\n                } \n            };\n        } else {\n            return { success: false, error: 'Invalid username or password.', user: null };\n        }\n    } catch (e) {\n        console.error('Error logging in user:', e);\n        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';\n        return { success: false, error: `Failed to login: ${errorMessage}`, user: null };\n    }\n}\n\nconst LogoutResultSchema = z.object({ success: z.boolean() });\ntype LogoutResult = z.infer<typeof LogoutResultSchema>;\n\nexport async function logoutUser(): Promise<LogoutResult> {\n    const sessionToken = cookies().get('sessionToken')?.value;\n    if (sessionToken) {\n        await deleteSessionByToken(sessionToken);\n        cookies().delete('sessionToken');\n    }\n    return { success: true };\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1334, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/schemas.ts"],"sourcesContent":["\nimport { z } from 'zod';\n\nconst alphanumericWithSpaces = (name: string, length: number, required = true) => {\n  const schema = z.string()\n   .max(length, `${name} must be ${length} characters or less.`)\n   .regex(/^[a-zA-Z0-9\\s]*$/, `${name} must only contain letters, numbers, and spaces.`);\n  \n  if (required) {\n    return schema.min(1, `${name} is required.`);\n  }\n  return schema.optional().or(z.literal(''));\n};\n\nexport const TaxProfileSchema = z.object({\n  tpTIN: z.string().regex(/^[0-9]{9}$/, 'TIN must be 9 digits.'),\n  branchCode: z.string().regex(/^[0-9]{4}$/, 'Branch code must be 4 digits.'),\n  rdoCode: z.string().min(1, 'RDO Code is required.'),\n  entityType: z.string(),\n  cycleType: z.string(),\n  monthSelect: z.string().min(1, 'Month is required.'),\n  companyName: alphanumericWithSpaces('Company Name', 50, false),\n  lastName: alphanumericWithSpaces('Last Name', 30, false),\n  firstName: alphanumericWithSpaces('First Name', 30, false),\n  middleName: alphanumericWithSpaces('Middle Name', 30, false),\n  tradeName: alphanumericWithSpaces('Trade Name', 50),\n  subStreet: z.string().max(30, 'Unit/Floor/Substreet must be 30 characters or less.').optional().or(z.literal('')),\n  street: z.string().max(30, 'Street must be 30 characters or less.').min(1, 'Street is required.'),\n  barangay: z.string().max(30, 'Barangay must be 30 characters or less.').min(1, 'Barangay is required.'),\n  cityMunicipality: z.string().max(30, 'City/Municipality must be 30 characters or less.').min(1, 'City/Municipality is required.'),\n  province: z.string().max(30, 'Province must be 30 characters or less.').min(1, 'Province is required.'),\n  zipCode: z.string().regex(/^[0-9]{4}$/, 'Zip code must be 4 digits.'),\n}).passthrough().refine(data => {\n    if (data.entityType === 'Individual') {\n        return !!data.lastName && !!data.firstName && !!data.middleName;\n    }\n    return true;\n}, {\n    message: \"First, Middle, and Last name are required for individuals.\",\n    path: [\"lastName\"], \n}).refine(data => {\n    if (data.entityType === 'Non-Individual') {\n        return !!data.companyName;\n    }\n    return true;\n}, {\n    message: \"Company name is required for non-individuals.\",\n    path: [\"companyName\"],\n});\n\n\nexport type TaxProfile = z.infer<typeof TaxProfileSchema>;\n\n\nexport const MutationResultSchema = z.object({\n    success: z.boolean(),\n    error: z.string().nullable(),\n    data: TaxProfileSchema.nullable(),\n});\n\nexport const DatFileSchema = z.object({\n  id: z.string(),\n  name: z.string(),\n  path: z.string(),\n  modifiedTime: z.string(),\n});\nexport type DatFile = z.infer<typeof DatFileSchema>;\n\n\nexport const UserDetailsSchema = z.object({\n    userName: z.string(),\n    email: z.string().email(),\n});\nexport type UserDetails = z.infer<typeof UserDetailsSchema>;\n\nexport const UserUpdateDataSchema = z.object({\n    newUserName: z.string().optional(),\n    currentPassword: z.string().optional(),\n    newPassword: z.string().optional(),\n});\nexport type UserUpdateData = z.infer<typeof UserUpdateDataSchema>;\n\nexport const SessionInfoSchema = z.object({\n    token: z.string(),\n    loginTime: z.string(),\n    ipAddress: z.string(),\n    deviceInfo: z.string(),\n});\nexport type SessionInfo = z.infer<typeof SessionInfoSchema>;\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1422, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/actions/profiles.ts"],"sourcesContent":["'use server';\n\nimport type { TaxProfile } from '@/lib/schemas';\nimport { TaxProfileSchema, MutationResultSchema } from '@/lib/schemas';\nimport { getAllHeaderDataFromSheet, appendHeaderDataToSheet, updateHeaderDataInSheet, deleteHeaderDataRowInSheet } from '../googlesheets';\nimport { z } from 'zod';\n\nconst TaxProfileResultSchema = z.object({\n  success: z.boolean(),\n  data: z.array(TaxProfileSchema).nullable(),\n  error: z.string().nullable(),\n});\ntype TaxProfileResult = z.infer<typeof TaxProfileResultSchema>;\n\nexport async function getUserHeaderData(databaseId: string): Promise<TaxProfileResult> {\n  try {\n    if (!databaseId) {\n      return { success: false, data: null, error: 'Database ID is required.' };\n    }\n    const headerData = await getAllHeaderDataFromSheet(databaseId);\n    return { success: true, data: headerData, error: null };\n  } catch (error) {\n    console.error('Error fetching header data:', error);\n    const errorMessage = error instanceof Error ? error.message : 'An unknown error occurred.';\n    return { success: false, data: null, error: `Failed to fetch header data: ${errorMessage}` };\n  }\n}\n\n\ntype MutationResult = z.infer<typeof MutationResultSchema>;\n\nfunction transformToUppercase(data: TaxProfile): TaxProfile {\n  const uppercasedData: { [key: string]: any } = {};\n  for (const key in data) {\n    const value = data[key as keyof TaxProfile];\n    if (typeof value === 'string' && key !== 'entityType' && key !== 'cycleType' && key !== 'monthSelect' && key !== 'rdoCode') {\n      uppercasedData[key] = value.toUpperCase();\n    } else {\n      uppercasedData[key] = value;\n    }\n  }\n  return uppercasedData as TaxProfile;\n}\n\nexport async function addTaxProfile(profileData: TaxProfile, databaseId: string): Promise<MutationResult> {\n  try {\n    const validatedData = TaxProfileSchema.parse(profileData);\n\n    const existingProfiles = await getAllHeaderDataFromSheet(databaseId);\n    const tinExists = existingProfiles.some(p => p.tpTIN === validatedData.tpTIN);\n\n    if (tinExists) {\n        return { \n            success: false, \n            error: 'This TIN already has a profile. Please check your data or refresh the page.', \n            data: null \n        };\n    }\n\n    const uppercasedData = transformToUppercase(validatedData);\n    await appendHeaderDataToSheet(uppercasedData, databaseId);\n    return { success: true, error: null, data: uppercasedData };\n  } catch (e) {\n    console.error('Error adding tax profile:', e);\n    const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';\n    return { success: false, error: `Failed to add profile: ${errorMessage}`, data: null };\n  }\n}\n\n\nexport async function updateTaxProfile(profileData: TaxProfile, databaseId: string): Promise<MutationResult> {\n  try {\n    const validatedData = TaxProfileSchema.parse(profileData);\n    const uppercasedData = transformToUppercase(validatedData);\n    await updateHeaderDataInSheet(uppercasedData, databaseId);\n    return { success: true, error: null, data: uppercasedData };\n  } catch (e) {\n    console.error('Error updating tax profile:', e);\n    const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';\n    return { success: false, error: `Failed to update profile: ${errorMessage}`, data: null };\n  }\n}\n\nconst SimpleResultSchema = z.object({\n    success: z.boolean(),\n    error: z.string().nullable(),\n});\ntype SimpleResult = z.infer<typeof SimpleResultSchema>;\n\nexport async function deleteTaxProfile(tpTIN: string, databaseId: string): Promise<SimpleResult> {\n    try {\n        await deleteHeaderDataRowInSheet(tpTIN, databaseId);\n        return { success: true, error: null };\n    } catch (e) {\n        console.error('Error deleting tax profile:', e);\n        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';\n        return { success: false, error: `Failed to delete profile: ${errorMessage}` };\n    }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1567, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/actions/drive.ts"],"sourcesContent":["\n'use server';\n\nimport { listDatFiles, downloadFileFromDrive, deleteFileFromDrive, getInitialPageTokenForDrive, listChangesSincePageToken } from '../drive';\nimport type { DatFile } from '@/lib/schemas';\nimport { DatFileSchema } from '@/lib/schemas';\nimport { z } from 'zod';\n\n\nconst DatFileListingResultSchema = z.object({\n  success: z.boolean(),\n  files: z.array(DatFileSchema).nullable(),\n  folderIds: z.array(z.string()).nullable(),\n  error: z.string().nullable(),\n});\ntype DatFileListingResult = z.infer<typeof DatFileListingResultSchema>;\n\nexport async function getDatFiles(folderId: string): Promise<DatFileListingResult> {\n    if (!folderId) {\n        return { success: false, files: null, folderIds: null, error: 'User folder ID is missing.' };\n    }\n    try {\n        const { files, folderIds } = await listDatFiles(folderId);\n        return { success: true, files, folderIds, error: null };\n    } catch (e) {\n        console.error('[getDatFiles] CRITICAL ERROR:', e);\n        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';\n        return { success: false, files: null, folderIds: null, error: `Failed to retrieve DAT files: ${errorMessage}` };\n    }\n}\n\nconst DatFileContentResultSchema = z.object({\n    success: z.boolean(),\n    content: z.string().nullable(),\n    error: z.string().nullable(),\n});\ntype DatFileContentResult = z.infer<typeof DatFileContentResultSchema>;\n\nexport async function getDatFileContent(fileId: string): Promise<DatFileContentResult> {\n    try {\n        if (!fileId) {\n            return { success: false, content: null, error: 'File ID is required.' };\n        }\n        const content = await downloadFileFromDrive(fileId);\n        return { success: true, content: content, error: null };\n    } catch (error: any) {\n        if (error.code === 404) {\n            return { success: false, content: null, error: 'File not found.' };\n        }\n        console.error(`[getDatFileContent] CRITICAL ERROR for fileId ${fileId}:`, error);\n        const errorMessage = error instanceof Error ? error.message : 'An unknown error occurred.';\n        return { success: false, content: null, error: `Failed to retrieve file content: ${errorMessage}` };\n    }\n}\n\n\nconst SimpleResultSchema = z.object({\n    success: z.boolean(),\n    error: z.string().nullable(),\n});\ntype SimpleResult = z.infer<typeof SimpleResultSchema>;\n\n\nexport async function deleteDatFile(fileId: string): Promise<SimpleResult> {\n    try {\n        if (!fileId) {\n            return { success: false, error: 'File ID is required.' };\n        }\n        await deleteFileFromDrive(fileId);\n        return { success: true, error: null };\n    } catch (error: any) {\n        if (error.code === 404) {\n            return { success: false, error: 'File not found.' };\n        }\n        console.error(`[deleteDatFile] CRITICAL ERROR for fileId ${fileId}:`, error);\n        const errorMessage = error instanceof Error ? error.message : 'An unknown error occurred.';\n        return { success: false, error: `Failed to delete file: ${errorMessage}` };\n    }\n}\n\nconst PageTokenResultSchema = z.object({\n  success: z.boolean(),\n  token: z.string().nullable(),\n  error: z.string().nullable(),\n});\ntype PageTokenResult = z.infer<typeof PageTokenResultSchema>;\n\nexport async function getInitialPageToken(): Promise<PageTokenResult> {\n    try {\n        const token = await getInitialPageTokenForDrive();\n        return { success: true, token, error: null };\n    } catch (e) {\n        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';\n        return { success: false, token: null, error: `Failed to get initial page token: ${errorMessage}` };\n    }\n}\n\nconst ChangesResultSchema = z.object({\n  success: z.boolean(),\n  hasChanges: z.boolean(),\n  newToken: z.string().nullable(),\n  error: z.string().nullable(),\n});\ntype ChangesResult = z.infer<typeof ChangesResultSchema>;\n\nexport async function checkForDatFileChanges(allFolderIds: string[], pageToken: string): Promise<ChangesResult> {\n    if (!allFolderIds || allFolderIds.length === 0 || !pageToken) {\n        return { success: false, hasChanges: false, newToken: null, error: 'Folder IDs and page token are required.' };\n    }\n    try {\n        const { hasChanges, newPageToken } = await listChangesSincePageToken(allFolderIds, pageToken);\n        return { success: true, hasChanges, newToken: newPageToken, error: null };\n    } catch (e) {\n        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';\n        return { success: false, hasChanges: false, newToken: pageToken, error: `Failed to check for changes: ${errorMessage}` };\n    }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1762, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/actions/users.ts"],"sourcesContent":["\n'use server';\n\nimport { z } from 'zod';\nimport { getAllUsers, updateUserDataInSheet, getSessionsByUserName, deleteSessionByToken, deleteAllOtherSessionsByToken, findUserByTokenFromSheet } from '../googlesheets';\nimport type { UserDetails, UserUpdateData, SessionInfo } from '../schemas';\nimport { SessionInfoSchema } from '../schemas';\nimport { cookies } from 'next/headers';\n\nconst UserDetailsResultSchema = z.object({\n    success: z.boolean(),\n    data: z.object({\n        userName: z.string(),\n        email: z.string().email(),\n    }).nullable(),\n    error: z.string().nullable(),\n});\ntype UserDetailsResult = z.infer<typeof UserDetailsResultSchema>;\n\n\nexport async function getUserDetails(userName: string): Promise<UserDetailsResult> {\n    try {\n        const users = await getAllUsers();\n        const user = users.find(u => u.userName === userName);\n\n        if (user) {\n            return {\n                success: true,\n                data: {\n                    userName: user.userName,\n                    email: user.emailAddress,\n                },\n                error: null,\n            };\n        } else {\n            return { success: false, data: null, error: 'User not found.' };\n        }\n    } catch(e) {\n        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';\n        return { success: false, data: null, error: `Failed to fetch user details: ${errorMessage}` };\n    }\n}\n\nconst SimpleResultSchema = z.object({\n    success: z.boolean(),\n    error: z.string().nullable(),\n});\ntype SimpleResult = z.infer<typeof SimpleResultSchema>;\n\nexport async function updateUserDetails(currentUserName: string, updates: UserUpdateData): Promise<SimpleResult> {\n    try {\n        if (!currentUserName) {\n            return { success: false, error: \"Current username is required to identify the user.\" };\n        }\n        \n        await updateUserDataInSheet(currentUserName, updates);\n\n        return { success: true, error: null };\n    } catch (e) {\n        console.error(`Error updating user details for ${currentUserName}:`, e);\n        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';\n        return { success: false, error: errorMessage };\n    }\n}\n\nconst ActiveSessionsResultSchema = z.object({\n    success: z.boolean(),\n    sessions: z.array(SessionInfoSchema).nullable(),\n    currentSessionToken: z.string().nullable(),\n    error: z.string().nullable(),\n});\ntype ActiveSessionsResult = z.infer<typeof ActiveSessionsResultSchema>;\n\n\nexport async function getActiveSessions(): Promise<ActiveSessionsResult> {\n    try {\n        const currentSessionToken = cookies().get('sessionToken')?.value;\n        if (!currentSessionToken) {\n            return { success: false, sessions: null, currentSessionToken: null, error: 'User not logged in.' };\n        }\n        \n        const user = await findUserByTokenFromSheet(currentSessionToken);\n        if (!user) {\n            return { success: false, sessions: null, currentSessionToken: null, error: 'Session is invalid.' };\n        }\n        \n        const sessions = await getSessionsByUserName(user.userName);\n        return { success: true, sessions, currentSessionToken, error: null };\n\n    } catch(e) {\n         const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';\n        return { success: false, sessions: null, currentSessionToken: null, error: `Failed to fetch sessions: ${errorMessage}` };\n    }\n}\n\nexport async function logoutSession(sessionToken: string, logoutAll: boolean = false): Promise<SimpleResult> {\n    try {\n        if (!sessionToken) {\n            return { success: false, error: 'Session token is required.'};\n        }\n        \n        if (logoutAll) {\n            await deleteAllOtherSessionsByToken(sessionToken);\n        } else {\n            await deleteSessionByToken(sessionToken);\n        }\n        \n        return { success: true, error: null };\n\n    } catch (e) {\n         const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred.';\n        return { success: false, error: `Failed to logout session: ${errorMessage}` };\n    }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1929, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/actions/dat/common.ts"],"sourcesContent":["'use server';\n\nimport * as xlsx from 'xlsx';\n\nexport async function processExcelFile(file: File, sheetName: string): Promise<{ data: any[][], validationErrors: string[] }> {\n    const bytes = await file.arrayBuffer();\n    const workbook = xlsx.read(bytes, { type: 'array' });\n\n    if (!workbook.SheetNames.includes(sheetName)) {\n        return { data: [], validationErrors: [`Sheet \"${sheetName}\" not found in the uploaded file.`] };\n    }\n\n    const worksheet = workbook.Sheets[sheetName];\n    const data: any[][] = xlsx.utils.sheet_to_json(worksheet, {\n        header: 1,\n        defval: '',\n        raw: false,\n    });\n\n    if (data.length <= 1) {\n        return { data: [], validationErrors: [] };\n    }\n\n    return { data: data.slice(1), validationErrors: [] };\n}\n"],"names":[],"mappings":";;;;;AAEA;;;;;AAEO,eAAe,iBAAiB,IAAU,EAAE,SAAiB;IAChE,MAAM,QAAQ,MAAM,KAAK,WAAW;IACpC,MAAM,WAAW,CAAA,GAAA,6HAAA,CAAA,OAAS,AAAD,EAAE,OAAO;QAAE,MAAM;IAAQ;IAElD,IAAI,CAAC,SAAS,UAAU,CAAC,QAAQ,CAAC,YAAY;QAC1C,OAAO;YAAE,MAAM,EAAE;YAAE,kBAAkB;gBAAC,CAAC,OAAO,EAAE,UAAU,iCAAiC,CAAC;aAAC;QAAC;IAClG;IAEA,MAAM,YAAY,SAAS,MAAM,CAAC,UAAU;IAC5C,MAAM,OAAgB,6HAAA,CAAA,QAAU,CAAC,aAAa,CAAC,WAAW;QACtD,QAAQ;QACR,QAAQ;QACR,KAAK;IACT;IAEA,IAAI,KAAK,MAAM,IAAI,GAAG;QAClB,OAAO;YAAE,MAAM,EAAE;YAAE,kBAAkB,EAAE;QAAC;IAC5C;IAEA,OAAO;QAAE,MAAM,KAAK,KAAK,CAAC;QAAI,kBAAkB,EAAE;IAAC;AACvD;;;IApBsB;;AAAA,+OAAA","debugId":null}},
    {"offset": {"line": 1980, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/dat-utils.ts"],"sourcesContent":["\nimport { z } from 'zod';\nimport type { DatFile } from '@/lib/schemas';\nimport { DatFileSchema } from '@/lib/schemas';\n\nexport const DatFileResultSchema = z.object({\n    success: z.boolean(),\n    datContent: z.string().nullable(),\n    fileName: z.string().nullable(),\n    error: z.string().nullable(),\n    errors: z.array(z.string()).nullable(),\n    fileExists: z.boolean().optional(),\n    datFile: DatFileSchema.nullable(),\n    // Sales Totals\n    totalExempt: z.number().nullable(),\n    totalZeroRated: z.number().nullable(),\n    totalTaxableSales: z.number().nullable(),\n    totalOutputTax: z.number().nullable(),\n    // Purchase Totals\n    totalServices: z.number().nullable(),\n    totalCapitalGoods: z.number().nullable(),\n    totalOtherGoods: z.number().nullable(),\n    totalInputTax: z.number().nullable(),\n    // 1601-EQ and SAWT Totals\n    totalTaxableIncomePayment: z.number().nullable(),\n    totalExemptIncomePayment: z.number().nullable(),\n    totalWithholdingTax: z.number().nullable(),\n    processedData: z.any().nullable(),\n});\nexport type DatFileResult = z.infer<typeof DatFileResultSchema>;\n\nexport function sanitizeAndValidateString(input: any, fieldName: string, maxLength: number, isRequired: boolean = false, errorPrefix?: string): { value: string, error: string | null } {\n    let value = (input === null || input === undefined) ? '' : String(input).trim();\n    const fullFieldName = errorPrefix ? `${errorPrefix}: ${fieldName}` : fieldName;\n\n    if (!value) {\n        if (isRequired) {\n            return { value: '', error: `${fullFieldName} is missing.` };\n        }\n        return { value: '', error: null };\n    }\n\n    let processedString = value\n        .toUpperCase()\n        .replace(/&/g, 'AND')\n        .replace(//g, 'N')\n        .replace(/\\s\\s+/g, ' ')\n        .trim()\n        .replace(/[^A-Z0-9\\s-]/g, '')\n        .replace(/\\s\\s+/g, ' ')\n        .trim();\n\n    if (processedString.length > maxLength) {\n        return { value: processedString, error: `${fullFieldName} must be ${maxLength} characters or less.` };\n    }\n\n    return { value: processedString, error: null };\n}\n\nexport function sanitizeAndValidateNumber(input: any, fieldName: string): { value: string, error: string | null } {\n    if (input === null || input === undefined || String(input).trim() === '') {\n        return { value: '0', error: null };\n    }\n    \n    const valueAsString = String(input).replace(/,/g, '');\n    const num = parseFloat(valueAsString);\n\n    if (isNaN(num)) {\n        return { value: String(input), error: `${fieldName} contains an invalid number.` };\n    }\n    \n    const roundedNum = Math.round(num * 100) / 100;\n    \n    if (roundedNum === 0) {\n        return { value: '0', error: null };\n    }\n\n    return { value: roundedNum.toFixed(2), error: null };\n}\n\nexport function getFormattedLastDay(year: number, month: number): string {\n    // Get the last day of the month. This correctly handles leap years.\n    const day = new Date(year, month, 0).getDate();\n    \n    const date = new Date(year, month - 1, day);\n    const mm = String(date.getMonth() + 1).padStart(2, '0');\n    const dd = String(date.getDate()).padStart(2, '0');\n    const yyyy = date.getFullYear();\n\n    return `${mm}/${dd}/${yyyy}`;\n}\n\nexport const quoteIfNotEmpty = (value: string | undefined | null) => {\n  const str = String(value || '').trim();\n  return str ? `\"${str}\"` : '';\n};\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2088, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/actions/dat/sales.ts"],"sourcesContent":["\n'use server';\n\nimport type { TaxProfile } from '@/lib/schemas';\nimport { uploadFileToDrive, checkFileExists } from '@/lib/drive';\nimport { processExcelFile } from './common';\nimport type { DatFileResult } from '@/lib/dat-utils';\nimport { sanitizeAndValidateString, sanitizeAndValidateNumber, getFormattedLastDay, quoteIfNotEmpty } from '@/lib/dat-utils';\n\nexport async function generateSalesDatFile(file: File, profile: TaxProfile, month: string, year: string, folderId: string, overwrite: boolean = false): Promise<DatFileResult> {\n    const { tpTIN: tin } = profile;\n    \n    const { data: dataRows, validationErrors: fileErrors } = await processExcelFile(file, \"vat_sales\");\n    if (fileErrors.length > 0) {\n        return { \n            success: false, \n            errors: fileErrors, \n            datContent: null, fileName: null, error: null, datFile: null,\n            totalExempt: null, totalZeroRated: null, totalTaxableSales: null, totalOutputTax: null,\n            totalServices: null, totalCapitalGoods: null, totalOtherGoods: null, totalInputTax: null,\n            totalTaxableIncomePayment: null, totalExemptIncomePayment: null, totalWithholdingTax: null,\n            processedData: null\n        };\n    }\n\n    const validationErrors: string[] = [];\n    const processedData = dataRows.map((row, index) => {\n        const originalRowNumber = index + 2;\n        const errorPrefix = `Row ${originalRowNumber}`;\n        const processedRow = [...row];\n        if (processedRow.length > 0 && String(processedRow[0]).trim()) {\n            const originalTin = String(processedRow[0]);\n            const sanitizedTin = originalTin.replace(/[^0-9]/g, '');\n            if (sanitizedTin.substring(0, 9) === tin) validationErrors.push(`${errorPrefix}: The TIN matches the selected profile's TIN. A company cannot make a sale to itself.`);\n            if (sanitizedTin.length < 9) validationErrors.push(`${errorPrefix}: TIN '${originalTin}' is too short. It must be at least 9 digits.`);\n            processedRow[0] = sanitizedTin.substring(0, 9);\n        } else {\n            validationErrors.push(`${errorPrefix}: TIN is missing.`);\n        }\n        \n        const nameFieldsInfo = [\n            { name: 'Registered Name', index: 1, maxLength: 50, required: true },\n            { name: 'Last Name', index: 2, maxLength: 30, required: false },\n            { name: 'First Name', index: 3, maxLength: 30, required: false },\n            { name: 'Middle Name', index: 4, maxLength: 30, required: false },\n            { name: 'Address 1', index: 5, maxLength: 30, required: true },\n            { name: 'Address 2', index: 6, maxLength: 30, required: true },\n        ];\n\n        nameFieldsInfo.forEach(field => {\n            const result = sanitizeAndValidateString(processedRow[field.index], field.name, field.maxLength, field.required, errorPrefix);\n            if (result.error) validationErrors.push(result.error);\n            processedRow[field.index] = result.value;\n        });\n\n        const hasFirstName = String(processedRow[3]).trim().length > 0;\n        const hasLastName = String(processedRow[2]).trim().length > 0;\n        const hasMiddleName = String(processedRow[4]).trim().length > 0;\n        if ((hasFirstName && !hasLastName) || (!hasFirstName && hasLastName)) validationErrors.push(`${errorPrefix}: First Name and Last Name must be provided together.`);\n        if (hasMiddleName && (!hasFirstName || !hasLastName)) validationErrors.push(`${errorPrefix}: If Middle Name is provided, First Name and Last Name are also required.`);\n        \n        const numericFields = [\n            { name: 'Exempt Sales', index: 7 }, { name: 'Zero-Rated Sales', index: 8 },\n            { name: 'Taxable Sales', index: 9 }, { name: 'Output Tax', index: 10 },\n        ];\n        numericFields.forEach(field => {\n            const result = sanitizeAndValidateNumber(processedRow[field.index], `${errorPrefix}: ${field.name}`);\n            if (result.error) validationErrors.push(result.error);\n            processedRow[field.index] = result.value;\n        });\n        if (parseFloat(processedRow[7]) === 0 && parseFloat(processedRow[8]) === 0 && parseFloat(processedRow[9]) === 0) {\n            validationErrors.push(`${errorPrefix}: At least one sales amount (Exempt, Zero-Rated, or Taxable) must be greater than zero.`);\n        }\n        return processedRow;\n    });\n\n    if (validationErrors.length > 0) {\n        return {\n            success: false, errors: validationErrors, error: \"Validation failed.\", datFile: null,\n            datContent: null, fileName: null,\n            totalExempt: null, totalZeroRated: null, totalTaxableSales: null, totalOutputTax: null,\n            totalServices: null, totalCapitalGoods: null, totalOtherGoods: null, totalInputTax: null,\n            totalTaxableIncomePayment: null, totalExemptIncomePayment: null, totalWithholdingTax: null,\n            processedData: null\n        };\n    }\n    \n    processedData.sort((a, b) => String(a[1]).localeCompare(String(b[1])));\n    \n    const datFileName = `${tin}S${month}${year}.DAT`;\n    const reportTypeShort = \"Sales\";\n    const drivePath = [tin, reportTypeShort, year];\n\n    if (!overwrite) {\n        const fileExists = await checkFileExists(datFileName, folderId, drivePath);\n        if (fileExists) {\n            return {\n                success: false, fileExists: true, fileName: datFileName, datFile: null,\n                datContent: null, error: null, errors: null,\n                totalExempt: null, totalZeroRated: null, totalTaxableSales: null, totalOutputTax: null,\n                totalServices: null, totalCapitalGoods: null, totalOtherGoods: null, totalInputTax: null,\n                totalTaxableIncomePayment: null, totalExemptIncomePayment: null, totalWithholdingTax: null,\n                processedData: null,\n            };\n        }\n    }\n\n    const lastDayDate = getFormattedLastDay(parseInt(year), parseInt(month));\n    const address1 = [profile.subStreet, profile.street, profile.barangay].filter(Boolean).join(' ');\n    const address2 = [profile.cityMunicipality, profile.province, profile.zipCode].filter(Boolean).join(' ');\n\n    const detailRows = processedData.map(row => ['D', 'S', quoteIfNotEmpty(row[0]), quoteIfNotEmpty(row[1]), quoteIfNotEmpty(row[2]), quoteIfNotEmpty(row[3]), quoteIfNotEmpty(row[4]), quoteIfNotEmpty(row[5]), quoteIfNotEmpty(row[6]), row[7], row[8], row[9], row[10], tin, lastDayDate].join(',')).join('\\n');\n    const totalExempt = processedData.reduce((acc, row) => acc + parseFloat(row[7]), 0);\n    const totalZeroRated = processedData.reduce((acc, row) => acc + parseFloat(row[8]), 0);\n    const totalTaxableSales = processedData.reduce((acc, row) => acc + parseFloat(row[9]), 0);\n    const totalOutputTax = processedData.reduce((acc, row) => acc + parseFloat(row[10]), 0);\n    const headerRow = ['H', 'S', quoteIfNotEmpty(tin), quoteIfNotEmpty(profile.companyName), quoteIfNotEmpty(profile.lastName), quoteIfNotEmpty(profile.firstName), quoteIfNotEmpty(profile.middleName), quoteIfNotEmpty(profile.tradeName), quoteIfNotEmpty(address1), quoteIfNotEmpty(address2), totalExempt.toFixed(2), totalZeroRated.toFixed(2), totalTaxableSales.toFixed(2), totalOutputTax.toFixed(2), profile.rdoCode, lastDayDate, profile.monthSelect].join(',');\n    const datContent = `${headerRow}\\n${detailRows}`;\n    \n    // Fire and forget\n    uploadFileToDrive(datFileName, datContent, folderId, drivePath, overwrite).then(uploadedFile => {\n        console.log(`[Action:generateSalesDatFile] Background upload finished for ${uploadedFile.name}`);\n    }).catch(err => {\n        console.error(`[Action:generateSalesDatFile] Background upload failed for ${datFileName}:`, err);\n    });\n            \n    return { \n        success: true, datContent, fileName: datFileName, datFile: null, // Return null for datFile initially\n        totalExempt, totalZeroRated, totalTaxableSales, totalOutputTax,\n        error: null, errors: null, totalServices: null, totalCapitalGoods: null, totalOtherGoods: null, totalInputTax: null,\n        totalTaxableIncomePayment: null, totalExemptIncomePayment: null, totalWithholdingTax: null,\n        processedData: null\n    };\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2365, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/actions/dat/purchases.ts"],"sourcesContent":["\n'use server';\n\nimport type { TaxProfile } from '@/lib/schemas';\nimport { uploadFileToDrive, checkFileExists } from '@/lib/drive';\nimport { processExcelFile } from './common';\nimport type { DatFileResult } from '@/lib/dat-utils';\nimport { sanitizeAndValidateString, sanitizeAndValidateNumber, getFormattedLastDay, quoteIfNotEmpty } from '@/lib/dat-utils';\n\nexport async function validateExcelForPurchases(formData: FormData): Promise<DatFileResult> {\n    const file = formData.get('file') as File;\n    const profileString = formData.get('profile') as string;\n    const profile: TaxProfile = JSON.parse(profileString);\n    const { tpTIN: tin } = profile;\n\n    const defaultErrorResult: DatFileResult = {\n        success: false, datContent: null, fileName: null, errors: null, error: null, datFile: null,\n        totalExempt: null, totalZeroRated: null, totalTaxableSales: null, totalOutputTax: null,\n        totalServices: null, totalCapitalGoods: null, totalOtherGoods: null, totalInputTax: null,\n        totalTaxableIncomePayment: null, totalExemptIncomePayment: null, totalWithholdingTax: null,\n        processedData: null\n    };\n\n    const { data: dataRows, validationErrors: fileErrors } = await processExcelFile(file, \"vat_purchases\");\n    if (fileErrors.length > 0) {\n        return { ...defaultErrorResult, success: false, errors: fileErrors };\n    }\n\n    const validationErrors: string[] = [];\n    const processedData = dataRows.map((row, index) => {\n        const originalRowNumber = index + 2;\n        const errorPrefix = `Row ${originalRowNumber}`;\n        const processedRow = [...row];\n\n        if (String(processedRow[0] || '').trim()) {\n            const originalTin = String(processedRow[0]);\n            const sanitizedTin = originalTin.replace(/[^0-9]/g, '');\n            if (sanitizedTin.substring(0, 9) === tin) validationErrors.push(`${errorPrefix}: The TIN matches the selected profile's TIN. A company cannot have a purchase from itself.`);\n            if (sanitizedTin.length < 9) validationErrors.push(`${errorPrefix}: TIN '${originalTin}' is too short. It must be at least 9 digits.`);\n            processedRow[0] = sanitizedTin.substring(0, 9);\n        } else {\n            validationErrors.push(`${errorPrefix}: TIN is missing.`);\n        }\n\n        const nameFieldsInfo = [\n            { name: 'Registered Name', index: 1, maxLength: 50, required: true },\n            { name: 'Last Name', index: 2, maxLength: 30, required: false },\n            { name: 'First Name', index: 3, maxLength: 30, required: false },\n            { name: 'Middle Name', index: 4, maxLength: 30, required: false },\n            { name: 'Address 1', index: 5, maxLength: 30, required: true },\n            { name: 'Address 2', index: 6, maxLength: 30, required: true },\n        ];\n        nameFieldsInfo.forEach(field => {\n            const result = sanitizeAndValidateString(processedRow[field.index], field.name, field.maxLength, field.required, errorPrefix);\n            if (result.error) validationErrors.push(result.error);\n            processedRow[field.index] = result.value;\n        });\n\n        const hasFirstName = String(processedRow[3]).trim().length > 0;\n        const hasLastName = String(processedRow[2]).trim().length > 0;\n        const hasMiddleName = String(processedRow[4]).trim().length > 0;\n        if ((hasFirstName && !hasLastName) || (!hasFirstName && hasLastName)) validationErrors.push(`${errorPrefix}: First Name and Last Name must be provided together.`);\n        if (hasMiddleName && (!hasFirstName || !hasLastName)) validationErrors.push(`${errorPrefix}: If Middle Name is provided, First Name and Last Name are also required.`);\n\n        const numericFields = [\n            { name: 'Exempt Purchases', index: 7 }, { name: 'Zero-Rated Purchases', index: 8 },\n            { name: 'Purchases of Services', index: 9 }, { name: 'Purchases of Capital Goods', index: 10 },\n            { name: 'Purchases of Other Goods', index: 11 }, { name: 'Input Tax', index: 12 },\n        ];\n        numericFields.forEach(field => {\n            const result = sanitizeAndValidateNumber(processedRow[field.index], `${errorPrefix}: ${field.name}`);\n            if (result.error) validationErrors.push(result.error);\n            processedRow[field.index] = result.value;\n        });\n\n        if (parseFloat(processedRow[7]) === 0 && parseFloat(processedRow[8]) === 0 && parseFloat(processedRow[9]) === 0 && parseFloat(processedRow[10]) === 0 && parseFloat(processedRow[11]) === 0) {\n            validationErrors.push(`${errorPrefix}: At least one purchase amount must be greater than zero.`);\n        }\n\n        return processedRow;\n    });\n\n    if (validationErrors.length > 0) {\n        return { ...defaultErrorResult, success: false, errors: validationErrors };\n    }\n    \n    processedData.sort((a, b) => String(a[1]).localeCompare(String(b[1])));\n\n    const totalInputTax = processedData.reduce((acc, row) => acc + parseFloat(row[12]), 0);\n\n    return { ...defaultErrorResult, success: true, totalInputTax, processedData };\n}\n\nexport async function generatePurchasesDatFile(\n    processedData: any[][],\n    profile: TaxProfile,\n    month: string,\n    year: string,\n    nonCreditableInputTax: number,\n    folderId: string,\n    overwrite: boolean = false\n): Promise<DatFileResult> {\n     const { tpTIN: tin } = profile;\n    const datFileName = `${tin}P${month}${year}.DAT`;\n    const reportTypeShort = \"Purchases\";\n    const drivePath = [tin, reportTypeShort, year];\n    \n    if (!overwrite) {\n        const fileExists = await checkFileExists(datFileName, folderId, drivePath);\n        if (fileExists) {\n            return {\n                success: false, fileExists: true, fileName: datFileName, datFile: null,\n                datContent: null, error: null, errors: null, totalExempt: null, totalZeroRated: null,\n                totalTaxableSales: null, totalOutputTax: null, totalServices: null, totalCapitalGoods: null,\n                totalOtherGoods: null, totalInputTax: null,\n                totalTaxableIncomePayment: null, totalExemptIncomePayment: null, totalWithholdingTax: null,\n                processedData: null\n            };\n        }\n    }\n\n    const lastDayDate = getFormattedLastDay(parseInt(year), parseInt(month));\n    const address1 = [profile.subStreet, profile.street, profile.barangay].filter(Boolean).join(' ');\n    const address2 = [profile.cityMunicipality, profile.province, profile.zipCode].filter(Boolean).join(' ');\n\n    const detailRows = processedData.map(row => ['D', 'P', quoteIfNotEmpty(row[0]), quoteIfNotEmpty(row[1]), quoteIfNotEmpty(row[2]), quoteIfNotEmpty(row[3]), quoteIfNotEmpty(row[4]), quoteIfNotEmpty(row[5]), quoteIfNotEmpty(row[6]), row[7], row[8], row[9], row[10], row[11], row[12], tin, lastDayDate].join(',')).join('\\n');\n    const totalExempt = processedData.reduce((acc, row) => acc + parseFloat(row[7]), 0);\n    const totalZeroRated = processedData.reduce((acc, row) => acc + parseFloat(row[8]), 0);\n    const totalServices = processedData.reduce((acc, row) => acc + parseFloat(row[9]), 0);\n    const totalCapitalGoods = processedData.reduce((acc, row) => acc + parseFloat(row[10]), 0);\n    const totalOtherGoods = processedData.reduce((acc, row) => acc + parseFloat(row[11]), 0);\n    const totalInputTax = processedData.reduce((acc, row) => acc + parseFloat(row[12]), 0);\n    const creditableInputTax = totalInputTax - nonCreditableInputTax;\n\n    const headerRow = ['H', 'P', quoteIfNotEmpty(tin), quoteIfNotEmpty(profile.companyName), quoteIfNotEmpty(profile.lastName), quoteIfNotEmpty(profile.firstName), quoteIfNotEmpty(profile.middleName), quoteIfNotEmpty(profile.tradeName), quoteIfNotEmpty(address1), quoteIfNotEmpty(address2), totalExempt.toFixed(2), totalZeroRated.toFixed(2), totalServices.toFixed(2), totalCapitalGoods.toFixed(2), totalOtherGoods.toFixed(2), totalInputTax.toFixed(2), creditableInputTax.toFixed(2), nonCreditableInputTax.toFixed(2), profile.rdoCode, lastDayDate, profile.monthSelect].join(',');\n    const datContent = `${headerRow}\\n${detailRows}`;\n    \n    // Fire and forget\n    uploadFileToDrive(datFileName, datContent, folderId, drivePath, overwrite).then(uploadedFile => {\n        console.log(`[Action:generatePurchasesDatFile] Background upload finished for ${uploadedFile.name}`);\n    }).catch(err => {\n        console.error(`[Action:generatePurchasesDatFile] Background upload failed for ${datFileName}:`, err);\n    });\n\n    return { \n        success: true, datContent, fileName: datFileName, datFile: null,\n        totalExempt, totalZeroRated,\n        totalServices, totalCapitalGoods, totalOtherGoods, totalInputTax,\n        error: null, errors: null, totalTaxableSales: null, totalOutputTax: null,\n        totalTaxableIncomePayment: null, totalExemptIncomePayment: null, totalWithholdingTax: null,\n        processedData: null\n    };\n}\n\n\nexport async function createPurchasesDatFile(formData: FormData): Promise<DatFileResult> {\n    const processedDataString = formData.get('processedData') as string | null;\n    const profileString = formData.get('profile') as string | null;\n    const month = formData.get('month') as string | null;\n    const year = formData.get('year') as string | null;\n    const nonCreditableInputTaxString = formData.get('nonCreditableInputTax') as string | null;\n    const folderId = formData.get('folderId') as string | null;\n\n    const defaultErrorResult: DatFileResult = {\n        success: false, datContent: null, fileName: null, errors: null, error: null, datFile: null,\n        totalExempt: null, totalZeroRated: null, totalTaxableSales: null, totalOutputTax: null,\n        totalServices: null, totalCapitalGoods: null, totalOtherGoods: null, totalInputTax: null,\n        totalTaxableIncomePayment: null, totalExemptIncomePayment: null, totalWithholdingTax: null,\n        processedData: null\n    };\n    \n    if (!processedDataString || !profileString || !month || !year || nonCreditableInputTaxString === null || !folderId) {\n        return { ...defaultErrorResult, error: 'Missing required parameters for purchase file creation.' };\n    }\n    \n    try {\n        const processedData = JSON.parse(processedDataString);\n        const profile: TaxProfile = JSON.parse(profileString);\n        const nonCreditableInputTax = parseFloat(nonCreditableInputTaxString);\n\n        return await generatePurchasesDatFile(processedData, profile, month, year, nonCreditableInputTax, folderId, false);\n\n    } catch (e) {\n        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred during DAT file creation.';\n        console.error('[createPurchasesDatFile] CRITICAL ERROR:', e);\n        return { ...defaultErrorResult, error: `Creation failed: ${errorMessage}` };\n    }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2715, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/schedules.ts"],"sourcesContent":["\n\nexport interface AtcScheduleItem {\n    atc: string;\n    rate: number;\n    description: string;\n}\n\nexport const atcWE: AtcScheduleItem[] = [\n    { atc: 'WI010', rate: 5, description: 'Professionals (Lawyers, CPAs, Engineers, etc.)- If gross income for the current year did not exceed P3M' },\n    { atc: 'WI011', rate: 10, description: 'Professional (Lawyers, CPAs, Engineers, etc) - If gross Income is more than P3M or VAT Registered regardless of amount' },\n    { atc: 'WI020', rate: 5, description: 'Professional entertainers, such as, but not limited to, actors and actresses, singers, lyricist, composers, emcees - If gross income for the current year did not exceed P3M' },\n    { atc: 'WI021', rate: 10, description: 'Professional entertainers such as, but not limited to actors & actresses, singers, lyricists, composers, emcees - If gross Income is more than P3M or VAT Registered regardless of amount' },\n    { atc: 'WI030', rate: 5, description: 'Professional athletes, including basketball players, pelotaris and jockeys - If gross income for the current year did not exceed P3M' },\n    { atc: 'WI031', rate: 10, description: 'Professional athletes including basketball players, pelotaris and jockeys - If gross income is more than P3M of VAT Registered regardless of amount' },\n    { atc: 'WI040', rate: 5, description: 'All directors and producers involved in movies, stage, radio, television and musical productions - If gross income for the current year did not exceed P3M' },\n    { atc: 'WI041', rate: 10, description: 'All directors and producers involved in movies, stage, radio, television and musical productions - If gross income is more than P3M of VAT Registered regardless of amount' },\n    { atc: 'WI050', rate: 5, description: 'Management and technical consultants - If gross income for the current year did not exceed P3M' },\n    { atc: 'WI051', rate: 10, description: 'Management and technical consultants - If gross income is more than P3M of VAT Registered regardless of amount' },\n    { atc: 'WI060', rate: 5, description: 'Business and bookkeeping agents and agencies - If gross income for the current year did not exceed P3M' },\n    { atc: 'WI061', rate: 10, description: 'Business and bookkeeping agents and agencies - If gross income is more that P3M of VAT Registered regardless of amount' },\n    { atc: 'WI070', rate: 5, description: 'Insurance agents and insurance adjusters - If gross income for the current year did not exceed P3M' },\n    { atc: 'WI071', rate: 10, description: 'Insurance agents and insurance adjusters - If gross income is more than P3M of VAT Registered regardless of amount' },\n    { atc: 'WI080', rate: 5, description: 'Other recipients of talent fees - If gross income for the current year did not exceed P3M' },\n    { atc: 'WI081', rate: 10, description: 'Other recipients of talent fees - If gross income is more than P3M or VAT Registered regardless of amount' },\n    { atc: 'WI090', rate: 5, description: 'Fees of directors who are not employees of the company - If gross income for the current year did not exceed P3M' },\n    { atc: 'WI091', rate: 10, description: 'Fees of directors who are not employees of the company - If gross income is more than P3M of VAT Registered regardless of amount' },\n    { atc: 'WI100', rate: 5, description: 'Rentals- real/personal properties, poles, satellites & transmission facilities, billboards - Individual' },\n    { atc: 'WI110', rate: 5, description: 'Cinematographic film rentals - Individual' },\n    { atc: 'WI120', rate: 2, description: 'Income payments to prime contractors/sub-contractors - Individual' },\n    { atc: 'WI130', rate: 15, description: 'Income distribution to beneficiaries of estates and trusts' },\n    { atc: 'WI139', rate: 5, description: 'Gross commission or service fees of custom, insurance, stock, real estate, immigration and commercial brokers & fees of agents of professional entertainers - If gross income for the current year did not exceed P3M' },\n    { atc: 'WI140', rate: 10, description: 'Gross commission or service fees of custom, insurance, stock, real estate, immigration and commercial brokers & fees of agents of professional entertainers - If gross income is more than P3M or VAT Registered regardless of amount' },\n    { atc: 'WI151', rate: 5, description: 'Payments for medical/dental/veterinary services thru Hospitals/ Clinics/Health Maintenance Organizations, including direct payments to service providers - If gross income for the current year did not exceed P3M' },\n    { atc: 'WI150', rate: 10, description: 'Payments for medical/dental/veterinary services thru Hospitals/ Clinics/Health Maintenance Organizations, including direct payments to service providers - If gross income > P3M of VAT Registered regardless of amount' },\n    { atc: 'WI152', rate: 10, description: 'Payment by the general professional partnerships (GPP) to its partners - If gross income for the current year did not exceed P720,000' },\n    { atc: 'WI153', rate: 15, description: 'Payment by the General Professional Partnerships (GPPs) to its partners - If gross income exceeds P720,000' },\n    { atc: 'WI156', rate: 0.5, description: 'Payments made by credit card companies - Individual' },\n    { atc: 'WI159', rate: 15, description: 'Additional payments to government personnel from importers, shipping and airline companies or their agents for overtime services' },\n    { atc: 'WI640', rate: 1, description: 'Income payments made by the government to its local/resident suppliers of goods - Individual' },\n    { atc: 'WI157', rate: 2, description: 'Income payments made by the government to its local/resident suppliers of service - Individual' },\n    { atc: 'WI158', rate: 1, description: 'Income payment made by top withholding agents to their local/resident supplier of goods other than those covered by other rates of withholding tax - Individual' },\n    { atc: 'WI160', rate: 2, description: 'Income payment made by top withholding agents to their local/resident supplier of services other than those covered by other rates of withholding tax - Individual' },\n    { atc: 'WI515', rate: 5, description: 'Commission, rebates, discounts & other similar considerations pd/granted to indepndnt & exclusive sales reps & mkting agents & sub-agents of multi-level marketing co. inc. multilevel mrkting co.- If gross income for the current yr did not exceed P3M' },\n    { atc: 'WI516', rate: 10, description: 'Commission, rebates, discounts & other similar considerations pd/granted to indepndnt & exclusive sales reps & mkting agents & sub-agents of multi-level mktng co. inc. multilevel mrkting co.-if gross income > P3M or VAT Registered regardless of amt' },\n    { atc: 'WI530', rate: 1, description: 'Gross payments to embalmers by funeral parlors' },\n    { atc: 'WI535', rate: 1, description: 'Payments made by pre-need companies to funeral parlors - Individual' },\n    { atc: 'WI540', rate: 5, description: 'Tolling fee paid to refineries - Individual' },\n    { atc: 'WI610', rate: 1, description: 'Income payments made to suppliers of Agricultural products - Individual' },\n    { atc: 'WI630', rate: 5, description: 'Income payments on purchases of minerals, mineral products & quarry resources - Individual' },\n    { atc: 'WI632', rate: 1, description: 'Income payments on purchases of gold by Bangko Sentral ng Pilipinas (BSP) from gold miners/suppliers under PD 1899, as amended by R.A. No. 7076- Individual' },\n    { atc: 'WI650', rate: 15, description: 'On gross amount of refund given by Meralco to customers with active contracts as classified by Meralco - Individual' },\n    { atc: 'WI651', rate: 15, description: 'On gross amount of refund given by Meralco to customers with terminated contracts as classified by Meralco - Individual' },\n    { atc: 'WI660', rate: 10, description: \"WITHHOLDING ON GROSS AMOUNT OF INTEREST ON THE REFUND OF METER DEPOSIT WHETHER PAID DIRECTLY TO THE CUSTOMERS OR APPLIED AGAINST CUSTOMER'S BILLING - RESIDENTIAL AND GENERAL SERVICE CUSTOMERS WHOSE MONTHLY ELECTRICITY CONSUMPTION EXCEEDS 200 KWH AS C\" },\n    { atc: 'WI661', rate: 15, description: \"WITHHOLDING ON GROSS AMOUNT OF INTERST ONT HE REFIND OF METER DEPOSIT WHETER PAID DIRECTLY TO THE CUSTOMERS OR APPLIED AGAINST CUSTOMER'S BILLING - RESIDENTIAL AND GENERA; SERVICE CUSTOMERS WHOSE MONTLY ELECTRICITY CONSUMPTION EXCEEDS200 KWH AS CLASS\" },\n    { atc: 'WI662', rate: 10, description: \"WITHHOLDING ON GROSS AMOUNT OF INTERESTO N THE REFUND OF METER DEPOSIT WHETHEER PAID DIRECTLY TO THE CUSTOMERS OR APPLIED AGAINST CUSTOMER'S BILLING - RESIDENTIAL AND GENERAL SERVICE CUSTOMERS WHOSE MONTLY ELECTRICITY CONSUMPTION EXCEEDS 200 KWH AS CL\" },\n    { atc: 'WI663', rate: 15, description: \"WITHHOLDING ON GROSS AMOUNT OF INTEREST ON THE REFUND OF METER DEPOSIT WHETHER PAID DIRECTLY TO THE CUSTOMERS OR APPLIED CUSTOMER'S BILLING - NON - RESIDENTIAL CUSTOMERS WHOSE MONTLY ELECTRICITY CONSUMPTION EXCEEDS 200 KWH AS CLASSIFIED BY OTH\" },\n    { atc: 'WI680', rate: 5, description: 'INCOME PAYMENTS MADE BY POLITICAL PARTIES AND CANDIDATES OF LOCAL AND NATIONAL ELECTIONS OF ALL THEIR CAMPAIGN EXPENDITURES, AND INCOME PAYMENTS MADE BY INDIVIDUALS OR JURIDICAL PERSONS FOR THEIR PURCHASES OF GOODS AND SERVICES INTENDED TO BE GIVEN A' },\n    { atc: 'WI710', rate: 15, description: 'INTEREST INCOME DERIVED FROM ANY OTHER DEBT INSTRUMENTS NOT WITHIN THE COVERAGE OF DEPOSIT SUBSTITUTES' },\n    { atc: 'WI720', rate: 1, description: 'Income payments on locally produced raw sugar - Individual' },\n    { atc: 'WI770', rate: 1, description: 'Income payments made by joint ventures, whether incorporated or not, taxable or non-taxable, to their local/resident supplier of goods' },\n    { atc: 'WI780', rate: 2, description: 'Income payments made by joint ventures, whether incorporated or not, taxable or non-taxable, to their local/resident supplier of services' },\n    { atc: 'WI820', rate: 0.5, description: 'On the gross remittances by e-marketplace operators to the sellers/merchants for the goods or services sold/paid through their platform/facility' },\n    { atc: 'WI830', rate: 0.5, description: 'On the gross remittances by digital financial services providers to the sellers/merchants for the goods or services sold/paid through their platform/facility' },\n    { atc: 'WC010', rate: 10, description: 'Professionals/ talent fees paid to juridical persons - If the current years gross income is P720,000 and below' },\n    { atc: 'WC011', rate: 15, description: 'Professionals/ talent fees paid to juridical persons - If the current years gross income exceeds P 720,000' },\n    { atc: 'WC020', rate: 10, description: 'Professional entertainers such as, but not limited to actors and actresses, singers, lyricists, composers, emcees - If gross income for the current year did not exceed P 720,000' },\n    { atc: 'WC021', rate: 15, description: 'Professional entertainers such as, but not limited to actors and actresses, singers, lyricists, composers, emcees - - If gross income exceeds P 720,000' },\n    { atc: 'WC030', rate: 10, description: 'Professional athletes including basketball players, pelotaris and jockeys - If gross income for the current year did not exceed P 720,000' },\n    { atc: 'WC031', rate: 15, description: 'Professional athletes including basketball players, pelotaris and jockeys -  - If gross income exceeds P 720,000' },\n    { atc: 'WC040', rate: 10, description: 'All directors and producers involved in movies, stage, radio, television and musical productions - If gross income for the current year did not exceed P 720,000' },\n    { atc: 'WC041', rate: 15, description: 'All directors and producers involved in movies, stage, radio, television and musical productions - If gross income exceeds P 720,000' },\n    { atc: 'WC050', rate: 10, description: 'Management and technical consultants paid to juridical person - If the current years gross income is P 720,000 and below' },\n    { atc: 'WC051', rate: 15, description: 'Management and technical consultants paid to juridical person - If the currents years gross income exceeds P720,000' },\n    { atc: 'WC060', rate: 10, description: 'Business and bookkeeping agents and agencies - If gross income for the current year did not exceed P 720,000' },\n    { atc: 'WC061', rate: 15, description: 'Business and bookkeeping agents and agencies - If gross income exceeds P 720,000' },\n    { atc: 'WC070', rate: 10, description: 'Insurance agents and insurance adjusters - If gross income for the current year did not exceed P 720,000' },\n    { atc: 'WC071', rate: 15, description: 'Insurance agents and insurance adjusters - If gross income exceeds P 720,000' },\n    { atc: 'WC080', rate: 10, description: 'Other recipients of talent fees - If gross income for the current year did not exceed P 720,000' },\n    { atc: 'WC081', rate: 15, description: 'Other recipients of talent fees - If gross income exceeds P 720,000' },\n    { atc: 'WC100', rate: 5, description: 'Rentals- real/personal properties, poles, satellites & transmission facilities, billiboards - Corporate' },\n    { atc: 'WC110', rate: 5, description: 'Cinematographic film rentals - Corporate' },\n    { atc: 'WC120', rate: 2, description: 'Income payments to prime contractors/sub-contractors - Corporate' },\n    { atc: 'WC139', rate: 10, description: 'Gross commission or service fees of custom, insurance, stock, real estate, immigration and commercial brokers & fees of agents of professional entertainers - if gross income did not exceed 720,000- Corporate' },\n    { atc: 'WC140', rate: 15, description: 'Gross commission or service fees of custom, insurance, stock, real estate, immigration and commercial brokers & fees of agents of professional entertainers - if gross income exceeds 720,000- Corporate' },\n    { atc: 'WC151', rate: 10, description: 'Professional fees paid to medical practitioners (inc.doctors of medicine doctors of veterinary sciences & dentists) by hospitals & clinics or paid directly by Health Maintenance Org (HMOs) &/or similar est - If gross income for the current yr < P720K' },\n    { atc: 'WC150', rate: 15, description: 'Professional fees paid to medical practitioners (inc.doctors of medicine doctors of veterinary sciences & dentists) by hospitals & clinics or paid directly by Health Maintenance Org (HMOs) &/or similar est - If gross income exceeds P720K' },\n    { atc: 'WC156', rate: 0.5, description: 'Payments made by credit card companies - Corporate' },\n    { atc: 'WC640', rate: 1, description: 'Income payments made by the government to its local/resident suppliers of goods - Corporate' },\n    { atc: 'WC157', rate: 2, description: 'Income payments made by the government to its local/resident suppliers of services - Corporate' },\n    { atc: 'WC158', rate: 1, description: 'Income payment made by top withholding agents to their local/resident supplier of goods other than those covered by other rates of withholding tax - Corporate' },\n    { atc: 'WC160', rate: 2, description: 'Income payment made by top withholding agents to their local/resident supplier of services other than those covered by other rates of withholding tax - Corporate' },\n    { atc: 'WC535', rate: 1, description: 'Payments made by pre-need companies to funeral parlors - Corporate' },\n    { atc: 'WC540', rate: 5, description: 'Tolling fee paid to refineries - Corporate' },\n    { atc: 'WC610', rate: 1, description: 'Income payments made to suppliers of Agricultural products - Corporate' },\n    { atc: 'WC630', rate: 5, description: 'Income payments on purchases of minerals, mineral products & quarry resources - Corporate' },\n    { atc: 'WC632', rate: 1, description: 'Income payments on purchases of gold by Bangko Sentral ng Pilipinas (BSP) from gold miners/suppliers under PD 1899, as amended by R.A. No. 7076- Corporate' },\n    { atc: 'WC650', rate: 15, description: 'On gross amount of refund given by Meralco to customers with active contracts as classified by Meralco - Corporate' },\n    { atc: 'WC651', rate: 15, description: 'On gross amount of refund given by Meralco to customers with terminated contracts as classified by Meralco - Corporate' },\n    { atc: 'WC660', rate: 10, description: \"WITHHOLDING ON GROSS AMOUNT OF INTEREST ON THE REFUND OF METER DEPOSIT WHETHER PAID DIRECTLY TO THE CUSTOMERS OR APPLIED AGAINST CUSTOMER'S BILLING - RESIDENTIAL AND GENERAL SERVICE CUSTOMERS WHOSE MONTHLY ELECTRICITY CONSUMPTION EXCEEDS 200 KWH AS C\" },\n    { atc: 'WC661', rate: 15, description: \"WITHHOLDING ON GROSS AMOUNT OF INTEREST ON THE REFUND OF METER DEPOSIT WHETHER PAID DIRECTLY TO THE CUSTOMERS OR APPLIED AGAINST CUSTOMER'S BILLING - NON - RESIDENTIAL CUSTOMERS WHOSE MONTLY ELECTRICITY CONSUMPTION EXCEEDS 200 KWH AS CLASSIFIED BY ME\" },\n    { atc: 'WC662', rate: 10, description: \"WITHHOLDING ON GROSS AMOUNT OF INTEREST ON THE REFUND OF METER DEPOSIT WHETHEER PAID DIRECTLY TO THE CUSTOMERS OR APPLIED AGAINST CUSTOMER'S BILLING - RESIDENTIAL AND GENERAL SERVICE CUSTOMERS WHOSE MONTLY ELECTRICITY CONSUMPTION EXCEEDS 200 KWH AS C\" },\n    { atc: 'WC663', rate: 15, description: \"WITHHOLDING ON GROSS AMOUNT OF INTEREST ON THE REFUND OF METER DEPOSIT WHETHER PAID DIRECTLY TO THE CUSTOMERS OR APPLIED CUSTOMER'S BILLING - NON - RESIDENTIAL CUSTOMERS WHOSE MONTLY ELECTRICITY CONSUMPTION EXCEEDS 200 KWH AS CLASSIFIED BY OTHER ELEC\" },\n    { atc: 'WC680', rate: 5, description: 'INCOME PAYMENTS MADE BY POLITICAL PARTIES AND CANDIDATES OF LOCAL AND NATIONAL ELECTIONS OF ALL THEIR CAMPAIGN EXPENDITURES, AND INCOME PAYMENTS MADE BY INDIVIDUALS OR JURIDICAL PERSONS FOR THEIR PURCHASES OF GOODS AND SERVICES INTENDED TO BE GIVEN A' },\n    { atc: 'WC690', rate: 1, description: 'Income payments received by Real Estate Investment Trust (REIT)' },\n    { atc: 'WC710', rate: 15, description: 'INTEREST INCOME DERIVED FROM ANY OTHER DEBT INSTRUMENTS NOT WITHIN THE COVERAGE OF DEPOSIT SUBSTITUTES' },\n    { atc: 'WC720', rate: 1, description: 'Income payments on locally produced raw sugar - Corporation' },\n    { atc: 'WC770', rate: 1, description: 'Income payments made by joint ventures, whether incorporated or not, taxable or non-taxable, to their local/resident supplier of goods' },\n    { atc: 'WC780', rate: 2, description: 'Income payments made by joint ventures, whether incorporated or not, taxable or non-taxable, to their local/resident supplier of services' },\n    { atc: 'WC790', rate: 15, description: 'On the share of each co-venturer/member from the net income of the joint venture/consortium not taxable as corporation prior to actual or constructive distribution thereof' },\n    { atc: 'WC820', rate: 0.5, description: 'On the gross remittances by e-marketplace operators to the sellers/merchants for the goods or services sold/paid through their platform/facility' },\n    { atc: 'WC830', rate: 0.5, description: 'On the gross remittances by digital financial services providers to the sellers/merchants for the goods or services sold/paid through their platform/facility' },\n];\n\nexport const atcExempt: AtcScheduleItem[] = [\n    { atc: 'MC040', rate: 0, description: 'INCOME FROM FORFEITED PROPERTIES' },\n    { atc: 'MC030', rate: 0, description: 'COMP. PYMTS ON DELQNT. ACCOUNTS & DISP. ASSESSMENTS' },\n    { atc: 'MC021', rate: 0, description: 'CORPORATE TAXPAYERS' },\n    { atc: 'MC020', rate: 0, description: 'TAX AMNESTY ON INCOME (CORPORATE)' },\n    { atc: 'MC011', rate: 0, description: 'INDIVIDUAL TAXPAYERS' },\n    { atc: 'MC010', rate: 0, description: 'TAX AMNESTY ON INCOME (INDIVIDUAL)' },\n    { atc: 'II420', rate: 0, description: 'CGT ON SALE OF REAL PROPERTY (CAPITAL ASSETS) FOR INDIV' },\n    { atc: 'II130', rate: 0, description: 'PARTNERS DISTRIB SHARE OF NET INC OF GEN PARTNERSHIP' },\n    { atc: 'II120', rate: 0, description: 'PRIZES AMOUNTING TO: 10,000 OR LESS' },\n    { atc: 'II110', rate: 0, description: 'INTEREST - (INDIVIDUAL PAYEES)' },\n    { atc: 'II090', rate: 0, description: 'TRANSPO CONTR (INDIVIDUAL)  CARRIAGE OF GOODS AND MERCHDSE BELOW 2,000' },\n    { atc: 'II080', rate: 0, description: 'OTHERS (SPECIFY) - (INDIVIDUAL PAYEES)' },\n    { atc: 'II070', rate: 0, description: 'PENSIONS' },\n    { atc: 'II060', rate: 0, description: 'PREMIUM AND ANNUITY - (INDIVIDUAL PAYEES)' },\n    { atc: 'II051', rate: 0, description: 'RENT - PERSONAL PROPERTY REGARDLESS OF  AMOUNT (INDIVIDUAL)' },\n    { atc: 'II050', rate: 0, description: 'RENT FOR REAL PROPERTY BELOW P500 MONTH (USED IN BUSINESS)' },\n    { atc: 'II020', rate: 0, description: 'NRC INCOME' },\n    { atc: 'II013', rate: 0, description: 'ESTATES AND TRUST -MIXED INCOME' },\n    { atc: 'II012', rate: 0, description: 'RESIDENT ALIEN - PURE BUSINESS' },\n    { atc: 'II011', rate: 0, description: 'PURE COMPENSATION INCOME -CITIZENS' },\n    { atc: 'II010', rate: 0, description: 'INCOME FROM COMP. ANDBUS./PROF' },\n    { atc: 'IC370', rate: 0, description: 'ON IMPROPERLY ACCUMULATED EARNINGS TAX' },\n    { atc: 'IC191', rate: 0, description: 'FOREIGN CURRENCY DEPOSIT UNITS (FCDUS)' },\n    { atc: 'IC190', rate: 0, description: 'OFFSHORE BANKING UNITS (OBUS)' },\n    { atc: 'IC170', rate: 0, description: 'INTEREST - (CORPORATE PAYEES)' },\n    { atc: 'IC160', rate: 0, description: 'TRANSPO CONTR (CORPORATE) CARRIAGE OF GOODS AND MERCHDSE BELOW P2000' },\n    { atc: 'IC150', rate: 0, description: 'OTHERS (SPECIFY) - (CORPORATE PAYEES)' },\n    { atc: 'IC140', rate: 0, description: 'PREMIUM AND ANNUITY - (CORPORATE PAYEES)' },\n    { atc: 'IC130', rate: 0, description: 'RENT - PERSONAL PROPERTY REGARDLESS OF AMOUNT (CORPORATE)' },\n    { atc: 'IC120', rate: 0, description: 'PRIZES REGARDLESS OF AMOUNT' },\n    { atc: 'IC101', rate: 0, description: 'REGIONAL OPERATING HEADQUARTERS OF MULTINATIONAL COMP' },\n    { atc: 'IC100', rate: 0, description: 'FOREIGN OBU/FCDU' },\n    { atc: 'IC090', rate: 0, description: 'FOREIGN MUTUAL LIFE INSURANCE CO.' },\n    { atc: 'IC080', rate: 0, description: 'RFC -INTERNATIONAL CARRIERS' },\n    { atc: 'IC070', rate: 0, description: 'ORDINARY RESIDENT FOREIGN CORP.' },\n    { atc: 'IC060', rate: 0, description: 'INCOME TAX -FCDU' },\n    { atc: 'IC055', rate: 0, description: 'MINIMUM CORPORATE INCOME TAX' },\n    { atc: 'IC050', rate: 0, description: 'INCOME TAX - MUTUAL LIFE INSURANCE COMPANIES' },\n    { atc: 'IC041', rate: 0, description: 'NATL & LOC GOVT UNITS (FOR PROPRIETARY ACTVTIES) EXCEPT PUBS' },\n    { atc: 'IC040', rate: 0, description: 'GOVT OWNED OR CONTROLLED CORP' },\n    { atc: 'IC031', rate: 0, description: 'NON STOCK, NON PROFIT HOSPITALS' },\n    { atc: 'IC030', rate: 0, description: 'PRIVATE EDUC INST, STOCK OR NON STOCK' },\n    { atc: 'IC021', rate: 0, description: 'PROFNL FEES PAID TO GEN PROF PARTNRSHIPS (EXCEPT TO PARTNRSHP OF MED)' },\n    { atc: 'IC020', rate: 0, description: 'PARTNERSHIP IN TRADE INCOME TAX' },\n    { atc: 'IC011', rate: 0, description: 'NON-STOCK NON-PROFIT ORGANIZATION' },\n    { atc: 'IC010', rate: 0, description: 'INCOME TAX- ORDINARY DOMESTIC CORP.' },\n    { atc: 'FP010', rate: 0, description: 'FINES & PEN.- ON TAX ON INCOME' },\n    { atc: 'EI900', rate: 0, description: 'EXCESS INCOME TAX' },\n    { atc: 'DI900', rate: 0, description: 'DEFAULT INCOME TAX' },\n];\n\nexport const atcWG: AtcScheduleItem[] = [\n    { atc: 'WV010', rate: 5, description: 'FWVAT on payments for purchases of Goods' },\n    { atc: 'WV020', rate: 5, description: 'FWVAT on payments for purchases of Services' },\n    { atc: 'WV040', rate: 12, description: 'Lease or use of properties or property rights owned by non-residents (Government Withholding Agent)' },\n    { atc: 'WV050', rate: 12, description: 'Lease or use of properties or property rights owned by non-residents (Private Withholding Agent)' },\n    { atc: 'WV060', rate: 12, description: 'Other services rendered in the Philippines by non-residents (Government Withholding Agent)' },\n    { atc: 'WV070', rate: 12, description: 'Other services rendered in the Philippines by non-residents (Private Withholding Agent)' },\n    { atc: 'WB030', rate: 3, description: 'Tax on carriers and keepers of garages' },\n    { atc: 'WB040', rate: 2, description: 'Franchise Tax on Gas and Water Utilities' },\n    { atc: 'WB050', rate: 3, description: 'Franchise Tax on radio & TV broadcasting companies whose annual gross receipts does not exceed P10M & who are not VAT registered taxpayers' },\n    { atc: 'WB070', rate: 2, description: 'Tax on life insurance premiums' },\n    { atc: 'WB080', rate: 3, description: 'Persons exempt from VAT under Sec. 109(v) (creditable)-Government Withholding Agent' },\n    { atc: 'WB090', rate: 10, description: 'Tax on overseas dispatch, message or conversation originating from the Philippines' },\n    { atc: 'WB301', rate: 5, description: 'Tax on Banks and Non-Bank Financial Internediaries Performing Quasi-Banking Functions. On interest, commissions and discounts from lending activities as well as income from financial leasing, on the basis of remaining maturities of instruments fr' },\n    { atc: 'WB303', rate: 1, description: 'Tax on Banks and Non-Bank Financial Intermediaries Performing Quasi-Banking Functions. On interest, commissions and discounts from lending activities as well as income from financial leasing, on the basis of remaining maturities of instruments f' },\n    { atc: 'WB102', rate: 0, description: 'Tax on Banks and Non-Bank Financial Intermediaries Performing Quasi-Banking Functions. On dividends and equity shares and net income of subsidiaries' },\n    { atc: 'WB103', rate: 7, description: 'Tax on Banks and Non-Bank Financial Intermediaries Performing Quasi-Banking Functions. On royalties, rentals of property, real or personal, profits from exchange and all other items treated as gross income under the Code' },\n    { atc: 'WB104', rate: 7, description: 'Tax on Banks and Non-Bank Financial Intermediaries Perfoming Quasi-Banking Functions. On the net trading gains within the taxable year on foreign currency, debt securities, derivatives, and other similar financial instruments' },\n    { atc: 'WB108', rate: 5, description: 'Tax on Other Non-Banks Financial Intermediaries Not Performing Quasi-Banking Functions. On interest, commissions and discounts from lending activities as well as income from financial leasing, on the basis of the remaining maturities of instrument f' },\n    { atc: 'WB109', rate: 1, description: 'Tax on Other Non-Banks Financial Intermediaries Not Performing Quasi-Banking Functions. On interest, commissions and discounts from lending activities as well as income from financial leasing, on the basis of the remaining maturities of instrument f' },\n    { atc: 'WB110', rate: 5, description: 'Tax on Other Non-Banks Financial Intermediaries Not Performing Quasi-Banking Functions. On all other items treated as gross income under the Code' },\n    { atc: 'WB120', rate: 4, description: 'Business Tax on Agents of foreign insurance co. - insurance agents' },\n    { atc: 'WB121', rate: 5, description: 'Business Tax on Agents of foreign insurance co. - owner of the property' },\n    { atc: 'WB130', rate: 3, description: 'Tax on International Carriers' },\n    { atc: 'WB140', rate: 18, description: 'Tax on cockpits' },\n    { atc: 'WB150', rate: 18, description: 'Tax on cabarets, night and day clubs' },\n    { atc: 'WB160', rate: 10, description: 'Tax on boxing exhibitions' },\n    { atc: 'WB170', rate: 15, description: 'Tax on professional basketball games' },\n    { atc: 'WB180', rate: 30, description: 'Tax on jai-alai & race tracks' },\n    { atc: 'WB200', rate: 0.6, description: 'Tax on sale, barter or exchange of shares of stocks listed and traded through the Local Stock Exchange' },\n    { atc: 'WB201', rate: 4, description: 'Tax on shares of stock sold or exchanged through initial and secondary public offering - Not over 25%' },\n    { atc: 'WB202', rate: 2, description: 'Tax on shares of stock sold or exchanged through initial and secondary public offering - Over 25% but not exceeding 33 1/3%' },\n    { atc: 'WB203', rate: 1, description: 'Tax on shares of stock sold or exchanged through initial and secondary public offering - Over 33 1/3%' },\n    { atc: 'WV012', rate: 12, description: 'VAT Withholding on Purchase of Goods (with waiver of privilege to claim input tax credit (creditable)' },\n    { atc: 'WV014', rate: 12, description: 'Vat Withholding on Purchase of Goods (with waiver of privilege to claim input tax credit (final)' },\n    { atc: 'WV022', rate: 12, description: 'VAT Withholding on Purchase of Services (with waiver of privilege to claim input tax credit (creditable)' },\n    { atc: 'WV024', rate: 12, description: 'VAT Withholding on Purchase of Services (with waiver of privilege to claim input tax credit (final)' },\n    { atc: 'WB082', rate: 3, description: 'Persons exempt from VAT under Section 109v (creditable) - Private Withholding Agent' },\n    { atc: 'WB084', rate: 3, description: 'Persons exempt from VAT under Section 109v (final)' },\n    { atc: 'PT320', rate: 5, description: 'Gaming Tax' },\n];\n\nexport const atcWF: AtcScheduleItem[] = [\n    { atc: 'WC180', rate: 20, description: 'Interest on foreign loans payable to non-resident foreign corporations (NRFCs)' },\n    { atc: 'WC190', rate: 10, description: 'Interest and other income payments on foreign currency transactions/loans payable to OBUs' },\n    { atc: 'WC191', rate: 10, description: 'Interest and other income payments on foreign currency transactions/loans payable to FCDUs' },\n    { atc: 'WI202', rate: 10, description: 'Cash dividend payments by domestic corporation to citizens and resident aliens' },\n    { atc: 'WI203', rate: 10, description: 'Property dividend payments by domestic corporation to citizens and resident aliens' },\n    { atc: 'WC212', rate: 25, description: 'Cash dividend payment by domestic corporation to Non-Resident Foreign Corporations' },\n    { atc: 'WC213', rate: 25, description: 'Property dividend payment by domestic corporation to Non-Resident Foreign Corporations' },\n    { atc: 'WC222', rate: 15, description: 'Cash dividend payment by domestic corporation to Non-Resident Foreign Corporations whose countries allowed tax deemed paid credit (subject to tax sparing rule)' },\n    { atc: 'WC223', rate: 15, description: 'Property dividend payment by domestic corporation to Non-Resident Foreign Corporations whose countries allowed tax deemed paid credit (subject to tax sparing rule)' },\n    { atc: 'WI224', rate: 20, description: 'Cash dividend payment by domestic corporation to non-resident alien engaged in trade or business (NRAETB)' },\n    { atc: 'WI225', rate: 20, description: 'Property  dividend payment by domestic corporation to non-resident alien engaged in trade or business (NRAETB)' },\n    { atc: 'WI226', rate: 20, description: 'Share of a NRAETB in the distributable net income after tax of a partnership (except GPP) of which he is a partner, or share in the net income after tax of an association,  joint account, or a joint venture taxable as a corporation of which he is a m' },\n    { atc: 'WC230', rate: 25, description: 'On other payments to non-resident foreign  corporations (NRFCs)' },\n    { atc: 'WI240', rate: 10, description: 'Distributive share of individual partners in a taxable partnerships, association,  joint account, or joint venture or consortium' },\n    { atc: 'WI250', rate: 20, description: 'All kinds of royalty payments to citizens, resident aliens and non-resident aliens engaged in trade or business (other than WI 380 and WI 341)' },\n    { atc: 'WC250', rate: 20, description: 'All kinds of royalty payments to domestic and resident foreign corporation' },\n    { atc: 'WI260', rate: 20, description: 'On prizes exceeding P10,000 and other winnings paid to individuals' },\n    { atc: 'WC280', rate: 15, description: 'Branch profit remittances by all  corporations except PEZA/SBMA/CDA registered' },\n    { atc: 'WC290', rate: 4.5, description: 'On gross rentals, lease and charter fees derived by non-resident owner or lessor of foreign vessels' },\n    { atc: 'WC300', rate: 7.5, description: 'On the gross rentals, lease and charter fees derived by non-resident lessor of aircraft, machineries and other equipment' },\n    { atc: 'WI310', rate: 8, description: 'On payments to oil exploration service contractors and subcontractors (OESS) - Individual (NRAETB)' },\n    { atc: 'WC310', rate: 8, description: 'On payments to oil exploration service contractors and subcontractors (OESS) - Corporate (non-resident foreign corporation engage in trade or business)' },\n    { atc: 'WI320', rate: 0, description: 'Payments to Filipinos or alien individuals employed by Foreign Petroleum Service Contractors/Subcontractors, Offshore Banking Units and Regional or Area Headquarters and Regional Operating Headquarters of Multinational Companies occupying executive/m' },\n    { atc: 'WI330', rate: 25, description: 'Payments to NRANETB except on sale of shares in domestic corporation and real property' },\n    { atc: 'WI340', rate: 25, description: 'On payments to non-resident individual  cinematographic film  owners, lessors or distributors' },\n    { atc: 'WC340', rate: 25, description: 'On payments to foreign corporate cinematographic film  owners, lessors or distributors' },\n    { atc: 'WI341', rate: 25, description: 'Royalties paid to NRAETB on cinematographic films and similar works' },\n    { atc: 'WI350', rate: 30, description: 'Final tax on interest or other  payments  upon tax-free covenant bonds, mortgages,  deeds of trust or other obligations under Sec. 57C of the NIRC of 1997' },\n    { atc: 'WI380', rate: 10, description: 'Royalties paid to citizens, resident aliens and NRAETB on books, other literary works and musical composition' },\n    { atc: 'WI410', rate: 10, description: 'Informer\\'s cash reward paid to individuals' },\n    { atc: 'WC410', rate: 10, description: 'Informer\\'s cash reward paid to juridical persons' },\n    { atc: 'WF330', rate: 25, description: 'Payment of fringe benefits to Non-Resident Alien Not Engaged in Trade or Business (NRAETB)' },\n    { atc: 'WF360', rate: 35, description: 'Employees other than rank and file (Fringe Benefit Tax)  based on the grossed up monetary value' },\n    { atc: 'WC700', rate: 10, description: 'Cash or property dividend paid by a Real Estate Investment Trust (REIT) - Corporate' },\n    { atc: 'WI700', rate: 10, description: 'Cash or property dividend paid by a Real Estate Investment Trust (REIT) - Individual' },\n    { atc: 'WI740', rate: 25, description: 'Final Withholding Tax on Foreign Nationals Employed by POGO Entities' },\n    { atc: 'WI750', rate: 0, description: 'On gross income earned by foreign nationals or non-Filipino citizens, regardless of their residency, who are employed and assigned in the Philippines by Offshore Gaming Licensee or its Accredited Service Provider' },\n];\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3875, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/actions/dat/1601eq.ts"],"sourcesContent":["\n'use server';\n\nimport type { TaxProfile } from '@/lib/schemas';\nimport { uploadFileToDrive, checkFileExists } from '@/lib/drive';\nimport { atcWE, atcExempt } from '@/lib/schedules';\nimport { processExcelFile } from './common';\nimport type { DatFileResult } from '@/lib/dat-utils';\nimport { sanitizeAndValidateString, sanitizeAndValidateNumber, quoteIfNotEmpty } from '@/lib/dat-utils';\n\nexport async function generate1601EQDatFile(file: File, profile: TaxProfile, month: string, year: string, folderId: string, overwrite: boolean = false): Promise<DatFileResult> {\n    const { tpTIN: tin, branchCode } = profile;\n    const defaultErrorResult = {\n        success: false, datContent: null, fileName: null, errors: null, error: null, datFile: null,\n        totalExempt: null, totalZeroRated: null, totalTaxableSales: null, totalOutputTax: null,\n        totalServices: null, totalCapitalGoods: null, totalOtherGoods: null, totalInputTax: null,\n        totalTaxableIncomePayment: null, totalExemptIncomePayment: null, totalWithholdingTax: null,\n        processedData: null\n    };\n    \n    const { data: sched1DataRows, validationErrors: sched1FileErrors } = await processExcelFile(file, \"1601EQ_sched1\");\n    if (sched1FileErrors.length > 0) return { ...defaultErrorResult, errors: sched1FileErrors };\n\n    const { data: sched2DataRows, validationErrors: sched2FileErrors } = await processExcelFile(file, \"1601EQ_sched2\");\n    if (sched2FileErrors.length > 0) return { ...defaultErrorResult, errors: sched2FileErrors };\n\n    const sched1HasData = sched1DataRows.some(row => row.some(cell => String(cell).trim() !== ''));\n    const sched2HasData = sched2DataRows.some(row => row.some(cell => String(cell).trim() !== ''));\n\n    if (!sched1HasData && !sched2HasData) {\n        return { ...defaultErrorResult, errors: [\"No data found in Schedule 1 or Schedule 2 sheets.\"] };\n    }\n\n    const validationErrors: string[] = [];\n\n    // Process Schedule 1 (Taxable)\n    const processedSched1Data = sched1DataRows\n        .filter(row => row.some(cell => String(cell).trim() !== ''))\n        .map((row, index) => {\n            const originalRowNumber = index + 2;\n            const errorPrefix = `Schedule 1 Row ${originalRowNumber}`;\n            const processedRow = [...row];\n            \n            if (String(processedRow[0] || '').trim()) {\n                const originalTin = String(processedRow[0]);\n                const sanitizedTin = originalTin.replace(/[^0-9]/g, '').substring(0, 9);\n                if (sanitizedTin.length > 0 && sanitizedTin.length < 9) validationErrors.push(`${errorPrefix}: TIN '${originalTin}' is too short. It must be 9 digits if provided.`);\n                processedRow[0] = sanitizedTin;\n            } else {\n                 processedRow[0] = '';\n            }\n            \n            let branchCode = String(processedRow[1] || '').replace(/[^0-9]/g, '');\n            processedRow[1] = branchCode ? branchCode.slice(-4).padStart(4, '0') : \"0000\";\n            \n            const nameFieldsInfo = [\n                { name: 'Registered Name', index: 2, maxLength: 50, required: true },\n                { name: 'Last Name', index: 3, maxLength: 30, required: false },\n                { name: 'First Name', index: 4, maxLength: 30, required: false },\n                { name: 'Middle Name', index: 5, maxLength: 30, required: false },\n            ];\n            nameFieldsInfo.forEach(field => {\n                const result = sanitizeAndValidateString(processedRow[field.index], field.name, field.maxLength, field.required, errorPrefix);\n                if (result.error) validationErrors.push(result.error);\n                processedRow[field.index] = result.value;\n            });\n            \n            const hasFirstName = String(processedRow[4]).trim().length > 0;\n            const hasLastName = String(processedRow[3]).trim().length > 0;\n            const hasMiddleName = String(processedRow[5]).trim().length > 0;\n            if ((hasFirstName && !hasLastName) || (!hasFirstName && hasLastName)) validationErrors.push(`${errorPrefix}: First Name and Last Name must be provided together.`);\n            if (hasMiddleName && (!hasFirstName || !hasLastName)) validationErrors.push(`${errorPrefix}: If Middle Name is provided, First Name and Last Name are also required.`);\n\n            const atc = String(processedRow[6] || '').toUpperCase().replace(/[^A-Z0-9]/g, '');\n            processedRow[6] = atc;\n            \n            const numericFields = [{ name: 'Rate', index: 7 }, { name: 'Income Payment', index: 8 }, { name: 'Withholding Tax', index: 9 }];\n            numericFields.forEach(field => {\n                const result = sanitizeAndValidateNumber(processedRow[field.index], field.name, errorPrefix);\n                if (result.error) validationErrors.push(result.error);\n                processedRow[field.index] = result.value;\n            });\n\n            if (parseFloat(processedRow[8]) <= 0) {\n                validationErrors.push(`${errorPrefix}: Income Payment must be greater than 0.`);\n            }\n\n            if (atc) {\n                const atcData = atcWE.find(item => item.atc === atc);\n                if (atcData) {\n                    if (parseFloat(processedRow[7]) !== atcData.rate) {\n                        validationErrors.push(`${errorPrefix}: Invalid rate for ATC ${atc}. Expected ${atcData.rate}%, but got ${parseFloat(processedRow[7])}%.`);\n                    }\n                } else {\n                    validationErrors.push(`${errorPrefix}: ATC code '${atc}' is not valid for Schedule 1.`);\n                }\n            } else validationErrors.push(`${errorPrefix}: ATC code is missing.`);\n            \n            return processedRow;\n        });\n\n    // Process Schedule 2 (Exempt)\n    const processedSched2Data = sched2DataRows\n        .filter(row => row.some(cell => String(cell).trim() !== ''))\n        .map((row, index) => {\n            const originalRowNumber = index + 2;\n            const errorPrefix = `Schedule 2 Row ${originalRowNumber}`;\n            const processedRow = [...row];\n\n            if (String(processedRow[0] || '').trim()) {\n                const originalTin = String(processedRow[0]);\n                const sanitizedTin = originalTin.replace(/[^0-9]/g, '').substring(0, 9);\n                if (sanitizedTin.length > 0 && sanitizedTin.length < 9) validationErrors.push(`${errorPrefix}: TIN '${originalTin}' is too short. It must be 9 digits if provided.`);\n                processedRow[0] = sanitizedTin;\n            } else {\n                 processedRow[0] = '';\n            }\n            \n            let branchCode = String(processedRow[1] || '').replace(/[^0-9]/g, '');\n            processedRow[1] = branchCode ? branchCode.slice(-4).padStart(4, '0') : \"0000\";\n\n            const nameFieldsInfo = [\n                { name: 'Registered Name', index: 2, maxLength: 50, required: true },\n                { name: 'Last Name', index: 3, maxLength: 30, required: false },\n                { name: 'First Name', index: 4, maxLength: 30, required: false },\n                { name: 'Middle Name', index: 5, maxLength: 30, required: false },\n            ];\n            nameFieldsInfo.forEach(field => {\n                const result = sanitizeAndValidateString(processedRow[field.index], field.name, field.maxLength, field.required, errorPrefix);\n                if (result.error) validationErrors.push(result.error);\n                processedRow[field.index] = result.value;\n            });\n            \n            const hasFirstName = String(processedRow[4]).trim().length > 0;\n            const hasLastName = String(processedRow[3]).trim().length > 0;\n            const hasMiddleName = String(processedRow[5]).trim().length > 0;\n            if ((hasFirstName && !hasLastName) || (!hasFirstName && hasLastName)) validationErrors.push(`${errorPrefix}: First Name and Last Name must be provided together.`);\n            if (hasMiddleName && (!hasFirstName || !hasLastName)) validationErrors.push(`${errorPrefix}: If Middle Name is provided, First Name and Last Name are also required.`);\n\n            const atc = String(processedRow[6] || '').toUpperCase().replace(/[^A-Z0-9]/g, '');\n            processedRow[6] = atc;\n            \n            const result = sanitizeAndValidateNumber(processedRow[7], 'Income Payment', errorPrefix);\n            if (result.error) validationErrors.push(result.error);\n            processedRow[7] = result.value;\n            \n            if (parseFloat(processedRow[7]) <= 0) {\n                validationErrors.push(`${errorPrefix}: Income Payment must be greater than 0.`);\n            }\n\n            if (atc) {\n                const atcData = atcExempt.find(item => item.atc === atc);\n                if (!atcData) validationErrors.push(`${errorPrefix}: ATC code '${atc}' is not valid for Schedule 2.`);\n            } else validationErrors.push(`${errorPrefix}: ATC code is missing.`);\n            \n            return processedRow;\n        });\n\n    if (validationErrors.length > 0) return { ...defaultErrorResult, errors: validationErrors };\n    \n    // All validations passed, now check for existing file\n    const datFileName = `${tin}${branchCode}${month.padStart(2, '0')}${year}1601EQ.DAT`;\n    const reportTypeShort = \"1601EQ\";\n    const drivePath = [tin, reportTypeShort, year];\n    \n    if (!overwrite) {\n        const fileExists = await checkFileExists(datFileName, folderId, drivePath);\n        if (fileExists) {\n            return {\n                ...defaultErrorResult,\n                success: false,\n                fileExists: true,\n                fileName: datFileName,\n            };\n        }\n    }\n\n    processedSched1Data.sort((a, b) => String(a[2]).localeCompare(String(b[2])));\n    processedSched2Data.sort((a, b) => String(a[2]).localeCompare(String(b[2])));\n\n    const reportingPeriod = `${month.padStart(2, '0')}/${year}`;\n    let datContentParts: string[] = [];\n    \n    // Header Row\n    const taxpayerName = profile.entityType === 'Individual'\n        ? `${profile.lastName} ${profile.firstName} ${profile.middleName}`\n        : profile.companyName;\n\n    const mainHeader = ['HQAP', 'H1601EQ', profile.tpTIN, profile.branchCode, quoteIfNotEmpty(taxpayerName), reportingPeriod, profile.rdoCode].join(',');\n    datContentParts.push(mainHeader);\n\n    let totalTaxableIncomePayment = 0;\n    let totalWithholdingTax = 0;\n    let totalExemptIncomePayment = 0;\n\n    // Schedule 1 Content\n    if (processedSched1Data.length > 0) {\n        const detailRows1 = processedSched1Data.map((row, index) => ['D1', '1601EQ', index + 1, row[0], row[1], quoteIfNotEmpty(row[2]), quoteIfNotEmpty(row[3]), quoteIfNotEmpty(row[4]), quoteIfNotEmpty(row[5]), reportingPeriod, row[6], row[7], row[8], row[9]].join(',')).join('\\n');\n        totalTaxableIncomePayment = processedSched1Data.reduce((acc, row) => acc + parseFloat(row[8]), 0);\n        totalWithholdingTax = processedSched1Data.reduce((acc, row) => acc + parseFloat(row[9]), 0);\n        const footerRow1 = ['C1', '1601EQ', profile.tpTIN, profile.branchCode, reportingPeriod, totalTaxableIncomePayment.toFixed(2), totalWithholdingTax.toFixed(2)].join(',');\n        datContentParts.push(detailRows1, footerRow1);\n    }\n\n    // Schedule 2 Content\n    if (processedSched2Data.length > 0) {\n        const detailRows2 = processedSched2Data.map((row, index) => ['D2', '1601EQ', index + 1, row[0], row[1], quoteIfNotEmpty(row[2]), quoteIfNotEmpty(row[3]), quoteIfNotEmpty(row[4]), quoteIfNotEmpty(row[5]), reportingPeriod, row[6], row[7]].join(',')).join('\\n');\n        totalExemptIncomePayment = processedSched2Data.reduce((acc, row) => acc + parseFloat(row[7]), 0);\n        const footerRow2 = ['C2', '1601EQ', profile.tpTIN, profile.branchCode, reportingPeriod, totalExemptIncomePayment.toFixed(2)].join(',');\n        datContentParts.push(detailRows2, footerRow2);\n    }\n\n    const datContent = datContentParts.join('\\n');\n    \n    // Fire and forget\n    uploadFileToDrive(datFileName, datContent, folderId, drivePath, overwrite).then(uploadedFile => {\n        console.log(`[Action:generate1601EQDatFile] Background upload finished for ${uploadedFile.name}`);\n    }).catch(err => {\n        console.error(`[Action:generate1601EQDatFile] Background upload failed for ${datFileName}:`, err);\n    });\n\n    return {\n        ...defaultErrorResult,\n        success: true,\n        datContent,\n        fileName: datFileName,\n        datFile: null,\n        totalTaxableIncomePayment,\n        totalExemptIncomePayment,\n        totalWithholdingTax,\n    };\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 4219, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/actions/dat/1601fq.ts"],"sourcesContent":["\n'use server';\n\nimport type { TaxProfile } from '@/lib/schemas';\nimport { uploadFileToDrive, checkFileExists } from '@/lib/drive';\nimport { atcWF } from '@/lib/schedules';\nimport { processExcelFile } from './common';\nimport type { DatFileResult } from '@/lib/dat-utils';\nimport { sanitizeAndValidateString, sanitizeAndValidateNumber, quoteIfNotEmpty } from '@/lib/dat-utils';\n\n\nexport async function generate1601FQDatFile(file: File, profile: TaxProfile, month: string, year: string, folderId: string, overwrite: boolean = false): Promise<DatFileResult> {\n    const { tpTIN: tin, branchCode } = profile;\n    const defaultErrorResult = {\n        success: false, datContent: null, fileName: null, errors: null, error: null, datFile: null,\n        totalExempt: null, totalZeroRated: null, totalTaxableSales: null, totalOutputTax: null,\n        totalServices: null, totalCapitalGoods: null, totalOtherGoods: null, totalInputTax: null,\n        totalTaxableIncomePayment: null, totalExemptIncomePayment: null, totalWithholdingTax: null,\n        processedData: null\n    };\n\n    // Process schedule 1\n    const { data: sched1DataRows, validationErrors: sched1FileErrors } = await processExcelFile(file, \"1601FQ_sched1\");\n    if (sched1FileErrors.length > 0) return { ...defaultErrorResult, errors: sched1FileErrors };\n\n    // Process schedule 2\n    const { data: sched2DataRows, validationErrors: sched2FileErrors } = await processExcelFile(file, \"1601FQ_sched2\");\n    if (sched2FileErrors.length > 0) return { ...defaultErrorResult, errors: sched2FileErrors };\n    \n    // Process schedule 3\n    const { data: sched3DataRows, validationErrors: sched3FileErrors } = await processExcelFile(file, \"1601FQ_sched3\");\n    if (sched3FileErrors.length > 0) return { ...defaultErrorResult, errors: sched3FileErrors };\n\n    const sched1HasData = sched1DataRows.some(row => row.some(cell => String(cell).trim() !== ''));\n    const sched2HasData = sched2DataRows.some(row => row.some(cell => String(cell).trim() !== ''));\n    const sched3HasData = sched3DataRows.some(row => row.some(cell => String(cell).trim() !== ''));\n\n    if (!sched1HasData && !sched2HasData && !sched3HasData) {\n        return { ...defaultErrorResult, errors: [\"No data found in 1601FQ_sched1, 1601FQ_sched2 or 1601FQ_sched3 sheets.\"] };\n    }\n\n    const validationErrors: string[] = [];\n    const reportingPeriod = `${month.padStart(2, '0')}/${year}`;\n\n    // Process Schedule 1\n    const processedSched1Data = sched1DataRows\n        .filter(row => row.some(cell => String(cell).trim() !== ''))\n        .map((row, index) => {\n            const originalRowNumber = index + 2;\n            const errorPrefix = `Schedule 1 Row ${originalRowNumber}`;\n            const processedRow = [...row];\n            \n            const tinResult = sanitizeAndValidateString(processedRow[0], 'TIN', 9, true, errorPrefix);\n            if(tinResult.error) validationErrors.push(tinResult.error);\n            processedRow[0] = tinResult.value.replace(/[^0-9]/g, '').substring(0, 9);\n            if (processedRow[0].length > 0 && processedRow[0].length < 9) validationErrors.push(`${errorPrefix}: TIN is too short. It must be 9 digits if provided.`);\n            \n            let branchCode = String(processedRow[1] || '').replace(/[^0-9]/g, '');\n            processedRow[1] = branchCode ? branchCode.slice(-4).padStart(4, '0') : \"0000\";\n            \n            const nameFieldsInfo = [\n                { name: 'Registered Name', index: 2, maxLength: 50, required: true },\n                { name: 'Last Name', index: 3, maxLength: 30, required: false },\n                { name: 'First Name', index: 4, maxLength: 30, required: false },\n                { name: 'Middle Name', index: 5, maxLength: 30, required: false },\n            ];\n            nameFieldsInfo.forEach(field => {\n                const result = sanitizeAndValidateString(processedRow[field.index], field.name, field.maxLength, field.required, errorPrefix);\n                if (result.error) validationErrors.push(result.error);\n                processedRow[field.index] = result.value;\n            });\n            const atc = String(processedRow[6] || '').toUpperCase().replace(/[^A-Z0-9]/g, '');\n            processedRow[6] = atc;\n            \n            const numericFields = [{ name: 'Rate', index: 7 }, { name: 'Income Payment', index: 8 }, { name: 'Withholding Tax', index: 9 }];\n            numericFields.forEach(field => {\n                const result = sanitizeAndValidateNumber(processedRow[field.index], field.name, errorPrefix);\n                if (result.error) validationErrors.push(result.error);\n                processedRow[field.index] = result.value;\n            });\n            \n            if (parseFloat(processedRow[8]) <= 0) {\n                validationErrors.push(`${errorPrefix}: Income Payment must be greater than 0.`);\n            }\n\n            if (atc) {\n                const atcData = atcWF.find(item => item.atc === atc);\n                if (atcData) {\n                    if (parseFloat(processedRow[7]) !== atcData.rate) {\n                        validationErrors.push(`${errorPrefix}: Invalid rate for ATC ${atc}. Expected ${atcData.rate}%, but got ${parseFloat(processedRow[7])}%.`);\n                    }\n                } else {\n                    validationErrors.push(`${errorPrefix}: ATC code '${atc}' is not valid for Schedule 1.`);\n                }\n            } else validationErrors.push(`${errorPrefix}: ATC code is missing.`);\n            \n            return processedRow;\n        });\n        \n    // Process Schedule 2\n    const processedSched2Data = sched2DataRows\n        .filter(row => row.some(cell => String(cell).trim() !== ''))\n        .map((row, index) => {\n            const originalRowNumber = index + 2;\n            const errorPrefix = `Schedule 2 Row ${originalRowNumber}`;\n            const processedRow = [...row];\n\n            const tinResult = sanitizeAndValidateString(processedRow[0], 'TIN', 9, true, errorPrefix);\n            if(tinResult.error) validationErrors.push(tinResult.error);\n            processedRow[0] = tinResult.value.replace(/[^0-9]/g, '').substring(0, 9);\n            if (processedRow[0].length > 0 && processedRow[0].length < 9) validationErrors.push(`${errorPrefix}: TIN is too short. It must be 9 digits if provided.`);\n            \n            let branchCode = String(processedRow[1] || '').replace(/[^0-9]/g, '');\n            processedRow[1] = branchCode ? branchCode.slice(-4).padStart(4, '0') : \"0000\";\n            \n            const nameFieldsInfo = [\n                { name: 'Last Name', index: 2, maxLength: 30, required: true },\n                { name: 'First Name', index: 3, maxLength: 30, required: true },\n                { name: 'Middle Name', index: 4, maxLength: 30, required: false },\n            ];\n             nameFieldsInfo.forEach(field => {\n                const result = sanitizeAndValidateString(processedRow[field.index], field.name, field.maxLength, field.required, errorPrefix);\n                if (result.error) validationErrors.push(result.error);\n                processedRow[field.index] = result.value;\n            });\n            const atc = String(processedRow[5] || '').toUpperCase().replace(/[^A-Z0-9]/g, '');\n            processedRow[5] = atc;\n            \n            const numericFields = [\n                { name: 'Fringe Benefit', index: 6 },\n                { name: 'Grossed-up Value', index: 7 },\n                { name: 'Withholding Tax', index: 8 }\n            ];\n            numericFields.forEach(field => {\n                const result = sanitizeAndValidateNumber(processedRow[field.index], field.name, errorPrefix);\n                if (result.error) validationErrors.push(result.error);\n                processedRow[field.index] = result.value;\n            });\n\n            if (parseFloat(processedRow[6]) <= 0) validationErrors.push(`${errorPrefix}: Fringe Benefit must be greater than 0.`);\n            if (parseFloat(processedRow[7]) <= 0) validationErrors.push(`${errorPrefix}: Grossed-up Value must be greater than 0.`);\n            if (parseFloat(processedRow[8]) <= 0) validationErrors.push(`${errorPrefix}: Withholding Tax must be greater than 0.`);\n\n            const allowedAtcs = [\"WF360\", \"WF330\"];\n            if (atc && !allowedAtcs.includes(atc)) {\n                 validationErrors.push(`${errorPrefix}: ATC code '${atc}' is not valid for Schedule 2. Allowed codes are ${allowedAtcs.join(', ')}.`);\n            } else if (!atc) {\n                validationErrors.push(`${errorPrefix}: ATC code is missing.`);\n            }\n            \n            return processedRow;\n        });\n\n    // Process Schedule 3\n    const processedSched3Data = sched3DataRows\n        .filter(row => row.some(cell => String(cell).trim() !== ''))\n        .map((row, index) => {\n            const originalRowNumber = index + 2;\n            const errorPrefix = `Schedule 3 Row ${originalRowNumber}`;\n            const processedRow = [...row];\n\n            const tinResult = sanitizeAndValidateString(processedRow[0], 'TIN', 9, true, errorPrefix);\n            if(tinResult.error) validationErrors.push(tinResult.error);\n            processedRow[0] = tinResult.value.replace(/[^0-9]/g, '').substring(0, 9);\n            if (processedRow[0].length > 0 && processedRow[0].length < 9) validationErrors.push(`${errorPrefix}: TIN is too short. It must be 9 digits if provided.`);\n            \n            let branchCode = String(processedRow[1] || '').replace(/[^0-9]/g, '');\n            processedRow[1] = branchCode ? branchCode.slice(-4).padStart(4, '0') : \"0000\";\n\n            const nameFieldsInfo = [\n                { name: 'Registered Name', index: 2, maxLength: 50, required: true },\n                { name: 'Last Name', index: 3, maxLength: 30, required: false },\n                { name: 'First Name', index: 4, maxLength: 30, required: false },\n                { name: 'Middle Name', index: 5, maxLength: 30, required: false },\n            ];\n            nameFieldsInfo.forEach(field => {\n                const result = sanitizeAndValidateString(processedRow[field.index], field.name, field.maxLength, field.required, errorPrefix);\n                if (result.error) validationErrors.push(result.error);\n                processedRow[field.index] = result.value;\n            });\n            \n            const classificationCode = String(processedRow[6] || '').toUpperCase().replace(/\\s/g, '');\n            processedRow[6] = classificationCode;\n            const allowedClassifications = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];\n            if (classificationCode && !allowedClassifications.includes(classificationCode)) {\n                validationErrors.push(`${errorPrefix}: Classification Code '${classificationCode}' is not valid. Must be one of ${allowedClassifications.join(', ')}.`);\n            } else if (!classificationCode) {\n                validationErrors.push(`${errorPrefix}: Classification Code is missing.`);\n            }\n\n            const atc = String(processedRow[7] || '').toUpperCase().replace(/[^A-Z0-9]/g, '');\n            processedRow[7] = atc;\n            \n            const result = sanitizeAndValidateNumber(processedRow[8], 'Income Payment', errorPrefix);\n            if (result.error) validationErrors.push(result.error);\n            processedRow[8] = result.value;\n\n            if (parseFloat(processedRow[8]) <= 0) {\n                validationErrors.push(`${errorPrefix}: Income Payment must be greater than 0.`);\n            }\n\n            if (atc) {\n                const atcData = atcWF.find(item => item.atc === atc);\n                if (!atcData) {\n                    validationErrors.push(`${errorPrefix}: ATC code '${atc}' is not valid for Schedule 3.`);\n                }\n            } else validationErrors.push(`${errorPrefix}: ATC code is missing.`);\n            \n            return processedRow;\n        });\n\n    if (validationErrors.length > 0) return { ...defaultErrorResult, errors: validationErrors };\n\n    const datFileName = `${tin}${branchCode}${month.padStart(2, '0')}${year}1601FQ.DAT`;\n    const reportTypeShort = \"1601FQ\";\n    const drivePath = [tin, reportTypeShort, year];\n\n    if (!overwrite) {\n        const fileExists = await checkFileExists(datFileName, folderId, drivePath);\n        if (fileExists) {\n            return {\n                ...defaultErrorResult,\n                success: false,\n                fileExists: true,\n                fileName: datFileName,\n            };\n        }\n    }\n    \n    let datContentParts: string[] = [];\n    const taxpayerName = profile.entityType === 'Individual'\n        ? `${profile.lastName} ${profile.firstName} ${profile.middleName}`\n        : profile.companyName;\n\n    const mainHeader = ['HQAP', 'H1601FQ', profile.tpTIN, profile.branchCode, quoteIfNotEmpty(taxpayerName), reportingPeriod, profile.rdoCode].join(',');\n    datContentParts.push(mainHeader);\n\n    // Schedule 1\n    const totalTaxableIncomePaymentSched1 = processedSched1Data.reduce((acc, row) => acc + parseFloat(row[8]), 0);\n    const totalWithholdingTaxSched1 = processedSched1Data.reduce((acc, row) => acc + parseFloat(row[9]), 0);\n\n    if (processedSched1Data.length > 0) {\n        processedSched1Data.sort((a, b) => String(a[2]).localeCompare(String(b[2])));\n        const detailRows = processedSched1Data.map((row, index) => {\n            return [\n                'D1,1601FQ', row[0], row[1],\n                quoteIfNotEmpty(row[2]), quoteIfNotEmpty(row[3]),\n                quoteIfNotEmpty(row[4]), quoteIfNotEmpty(row[5]),\n                reportingPeriod, index + 1, row[6], row[7], row[8], row[9]\n            ].join(',');\n        }).join('\\n');\n        datContentParts.push(detailRows);\n\n        const footerRow = ['C1,1601FQ', tin, branchCode, reportingPeriod, totalTaxableIncomePaymentSched1.toFixed(2), totalWithholdingTaxSched1.toFixed(2)].join(',');\n        datContentParts.push(footerRow);\n    }\n    \n    // Schedule 2\n    const totalFringeBenefit = processedSched2Data.reduce((acc, row) => acc + parseFloat(row[6]), 0);\n    const totalGrossedUp = processedSched2Data.reduce((acc, row) => acc + parseFloat(row[7]), 0);\n    const totalWithholdingTaxSched2 = processedSched2Data.reduce((acc, row) => acc + parseFloat(row[8]), 0);\n    \n    if (processedSched2Data.length > 0) {\n        processedSched2Data.sort((a, b) => String(a[2]).localeCompare(String(b[2]))); // Sort by Last Name\n        \n        const detailRows = processedSched2Data.map((row, index) => {\n            return [\n                'D2,1601FQ', row[0], row[1],\n                quoteIfNotEmpty(row[2]), quoteIfNotEmpty(row[3]),\n                quoteIfNotEmpty(row[4]),\n                reportingPeriod, index + 1, row[5], row[6], row[7], row[8]\n            ].join(',');\n        }).join('\\n');\n        datContentParts.push(detailRows);\n\n        const footerRow = ['C2,1601FQ', tin, branchCode, reportingPeriod, totalFringeBenefit.toFixed(2), totalGrossedUp.toFixed(2), totalWithholdingTaxSched2.toFixed(2)].join(',');\n        datContentParts.push(footerRow);\n    }\n\n    // Schedule 3\n    const totalIncomePaymentSched3 = processedSched3Data.reduce((acc, row) => acc + parseFloat(row[8]), 0);\n    if (processedSched3Data.length > 0) {\n        processedSched3Data.sort((a, b) => String(a[2]).localeCompare(String(b[2])));\n       \n        const detailRows = processedSched3Data.map((row, index) => {\n            return [\n                'D3,1601FQ', row[0], row[1],\n                quoteIfNotEmpty(row[2]), quoteIfNotEmpty(row[3]),\n                quoteIfNotEmpty(row[4]), quoteIfNotEmpty(row[5]),\n                reportingPeriod, index + 1, row[6], row[7], row[8]\n            ].join(',');\n        }).join('\\n');\n        datContentParts.push(detailRows);\n\n        const footerRow = ['C3,1601FQ', tin, branchCode, reportingPeriod, totalIncomePaymentSched3.toFixed(2)].join(',');\n        datContentParts.push(footerRow);\n    }\n\n    const datContent = datContentParts.join('\\n');\n    \n    // Fire and forget\n    uploadFileToDrive(datFileName, datContent, folderId, drivePath, overwrite).then(uploadedFile => {\n        console.log(`[Action:generate1601FQDatFile] Background upload finished for ${uploadedFile.name}`);\n    }).catch(err => {\n        console.error(`[Action:generate1601FQDatFile] Background upload failed for ${datFileName}:`, err);\n    });\n\n    return {\n        ...defaultErrorResult,\n        success: true,\n        datContent: datContent,\n        fileName: datFileName,\n        totalWithholdingTax: totalWithholdingTaxSched1,\n        totalServices: totalWithholdingTaxSched2,\n        totalExemptIncomePayment: totalIncomePaymentSched3,\n    };\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 4677, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/actions/dat/sawt.ts"],"sourcesContent":["\n'use server';\n\nimport type { TaxProfile } from '@/lib/schemas';\nimport { uploadFileToDrive, checkFileExists } from '@/lib/drive';\nimport { atcWE, atcWG } from '@/lib/schedules';\nimport { processExcelFile } from './common';\nimport type { DatFileResult } from '@/lib/dat-utils';\nimport { sanitizeAndValidateString, sanitizeAndValidateNumber, quoteIfNotEmpty } from '@/lib/dat-utils';\n\n\nexport async function validateAndProcessSAWT(formData: FormData, overwrite: boolean = false): Promise<DatFileResult> {\n    const file = formData.get('file') as File;\n    const schedule = formData.get('schedule') as string;\n    const profileString = formData.get('profile') as string;\n    const month = formData.get('month') as string;\n    const year = formData.get('year') as string;\n    const folderId = formData.get('folderId') as string;\n\n    const defaultErrorResult: DatFileResult = {\n        success: false, datContent: null, fileName: null, errors: null, error: null, datFile: null,\n        totalExempt: null, totalZeroRated: null, totalTaxableSales: null, totalOutputTax: null,\n        totalServices: null, totalCapitalGoods: null, totalOtherGoods: null, totalInputTax: null,\n        totalTaxableIncomePayment: null, totalExemptIncomePayment: null, totalWithholdingTax: null,\n        processedData: null\n    };\n    \n    const profile: TaxProfile = JSON.parse(profileString);\n\n    const sheetName = `sawt_${schedule}`;\n    const { data: dataRows, validationErrors: fileErrors } = await processExcelFile(file, sheetName);\n    if (fileErrors.length > 0) {\n        return { ...defaultErrorResult, success: false, errors: fileErrors };\n    }\n\n    if (dataRows.length === 0) {\n        return { ...defaultErrorResult, success: false, errors: [`No data found in sheet \"${sheetName}\".`] };\n    }\n\n    const validationErrors: string[] = [];\n    const combinedATC = [...atcWE, ...atcWG];\n\n    const processedData = dataRows\n        .filter(row => row.some(cell => String(cell).trim() !== ''))\n        .map((row, index) => {\n            const originalRowNumber = index + 2;\n            const errorPrefix = `Row ${originalRowNumber}`;\n            const processedRow = [...row];\n            \n            if (String(processedRow[0] || '').trim()) {\n                const originalTin = String(processedRow[0]);\n                const sanitizedTin = originalTin.replace(/[^0-9]/g, '').substring(0, 9);\n                if (sanitizedTin.length > 0 && sanitizedTin.length < 9) validationErrors.push(`${errorPrefix}: TIN '${originalTin}' is too short. It must be 9 digits if provided.`);\n                processedRow[0] = sanitizedTin;\n            } else {\n                 processedRow[0] = '';\n            }\n            \n            let branchCode = String(processedRow[1] || '').replace(/[^0-9]/g, '');\n            processedRow[1] = branchCode ? branchCode.slice(-4).padStart(4, '0') : \"0000\";\n            \n            const nameFieldsInfo = [\n                { name: 'Registered Name', index: 2, maxLength: 50, required: true },\n                { name: 'Last Name', index: 3, maxLength: 30, required: false },\n                { name: 'First Name', index: 4, maxLength: 30, required: false },\n                { name: 'Middle Name', index: 5, maxLength: 30, required: false },\n            ];\n            nameFieldsInfo.forEach(field => {\n                const result = sanitizeAndValidateString(processedRow[field.index], field.name, field.maxLength, field.required, errorPrefix);\n                if (result.error) validationErrors.push(result.error);\n                processedRow[field.index] = result.value;\n            });\n\n            const atc = String(processedRow[6] || '').toUpperCase().replace(/[^A-Z0-9]/g, '');\n            processedRow[6] = atc;\n            \n            const numericFields = [{ name: 'Rate', index: 7 }, { name: 'Income Payment', index: 8 }, { name: 'Withholding Tax', index: 9 }];\n            numericFields.forEach(field => {\n                const result = sanitizeAndValidateNumber(processedRow[field.index], `${errorPrefix}: ${field.name}`);\n                if (result.error) validationErrors.push(result.error);\n                processedRow[field.index] = result.value;\n            });\n\n            if (atc) {\n                const atcData = combinedATC.find(item => item.atc === atc);\n                if (atcData) {\n                    if (parseFloat(processedRow[7]) !== atcData.rate) {\n                        validationErrors.push(`${errorPrefix}: Invalid rate for ATC ${atc}. Expected ${atcData.rate}%, but got ${parseFloat(processedRow[7])}%.`);\n                    }\n                } else {\n                    validationErrors.push(`${errorPrefix}: ATC code '${atc}' is not valid for SAWT.`);\n                }\n            } else {\n                validationErrors.push(`${errorPrefix}: ATC code is missing.`);\n            }\n            \n            return processedRow;\n        });\n\n    if (validationErrors.length > 0) {\n        return { ...defaultErrorResult, success: false, errors: validationErrors };\n    }\n\n    processedData.sort((a, b) => String(a[2]).localeCompare(String(b[2])));\n    \n    const datFileName = `${profile.tpTIN}${profile.branchCode}${month.padStart(2, '0')}${year}${schedule}.DAT`;\n    const reportTypeShort = `SAWT_${schedule}`;\n    const drivePath = [profile.tpTIN, reportTypeShort, year];\n\n    if (!overwrite) {\n        const fileExists = await checkFileExists(datFileName, folderId, drivePath);\n        if (fileExists) {\n            return {\n                ...defaultErrorResult,\n                success: false,\n                fileExists: true,\n                fileName: datFileName,\n            };\n        }\n    }\n\n    const reportingPeriod = `${month.padStart(2, '0')}/${year}`;\n\n    const taxpayerName = profile.entityType === 'Individual' \n        ? `${profile.lastName} ${profile.firstName} ${profile.middleName}`\n        : profile.companyName;\n\n    const header = ['HSAWT', `H${schedule}`, profile.tpTIN, profile.branchCode, quoteIfNotEmpty(taxpayerName), quoteIfNotEmpty(profile.firstName), quoteIfNotEmpty(profile.lastName), quoteIfNotEmpty(profile.middleName), reportingPeriod, profile.rdoCode].join(',');\n\n    const detailRows = processedData.map((row, index) => {\n        return [\n            'DSAWT', `D${schedule}`, index + 1, row[0], row[1],\n            quoteIfNotEmpty(row[2]), quoteIfNotEmpty(row[3]), quoteIfNotEmpty(row[4]), quoteIfNotEmpty(row[5]),\n            reportingPeriod, '', row[6], row[7], row[8], row[9]\n        ].join(',');\n    }).join('\\n');\n\n    const totalIncomePayment = processedData.reduce((acc, row) => acc + parseFloat(row[8]), 0);\n    const totalWithholdingTax = processedData.reduce((acc, row) => acc + parseFloat(row[9]), 0);\n    \n    const footer = ['CSAWT', `C${schedule}`, profile.tpTIN, profile.branchCode, reportingPeriod, totalIncomePayment.toFixed(2), totalWithholdingTax.toFixed(2)].join(',');\n\n    const datContent = [header, detailRows, footer].join('\\n');\n    \n    // Fire and forget\n    uploadFileToDrive(datFileName, datContent, folderId, drivePath, overwrite).then(uploadedFile => {\n        console.log(`[Action:validateAndProcessSAWT] Background upload finished for ${uploadedFile.name}`);\n    }).catch(err => {\n        console.error(`[Action:validateAndProcessSAWT] Background upload failed for ${datFileName}:`, err);\n    });\n\n    return {\n        ...defaultErrorResult,\n        success: true,\n        datContent: datContent,\n        fileName: datFileName,\n        datFile: null,\n        totalTaxableIncomePayment: totalIncomePayment,\n        totalWithholdingTax,\n    };\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 4928, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/actions/dat/main.ts"],"sourcesContent":["\n'use server';\n\nimport type { TaxProfile } from '@/lib/schemas';\nimport type { DatFileResult } from '@/lib/dat-utils';\nimport { generateSalesDatFile } from './sales';\nimport { validateExcelForPurchases, createPurchasesDatFile } from './purchases';\nimport { generate1601EQDatFile } from './1601eq';\nimport { generate1601FQDatFile } from './1601fq';\nimport { validateAndProcessSAWT } from './sawt';\n\nexport async function convertExcelToDat(formData: FormData): Promise<DatFileResult> {\n    const file = formData.get('file') as File | null;\n    const reportType = formData.get('reportType') as string | null;\n    const month = formData.get('month') as string | null;\n    const year = formData.get('year') as string | null;\n    const profileString = formData.get('profile') as string | null;\n    const folderId = formData.get('folderId') as string | null;\n    const schedule = formData.get('schedule') as string | null;\n\n    const defaultErrorResult: DatFileResult = {\n        success: false, datContent: null, fileName: null, errors: null, error: null, datFile: null,\n        totalExempt: null, totalZeroRated: null, totalTaxableSales: null, totalOutputTax: null,\n        totalServices: null, totalCapitalGoods: null, totalOtherGoods: null, totalInputTax: null,\n        totalTaxableIncomePayment: null, totalExemptIncomePayment: null, totalWithholdingTax: null,\n        processedData: null,\n    };\n\n    if (!file || !reportType || !month || !year || !profileString || !folderId) {\n        return { ...defaultErrorResult, error: 'Missing required parameters for conversion.' };\n    }\n\n    try {\n        const profile: TaxProfile = JSON.parse(profileString);\n        if (reportType === \"Summary of Sales (SLS)\") {\n            return await generateSalesDatFile(file, profile, month, year, folderId, false);\n        }\n        if (reportType === \"Summary of Purchases (SLP)\") {\n            return await validateExcelForPurchases(formData);\n        }\n        if (reportType === \"1601-EQ (Schedule 1 and 2)\") {\n            return await generate1601EQDatFile(file, profile, month, year, folderId, false);\n        }\n        if (reportType === \"1601-FQ (Schedule 1, 2, and 3)\") {\n            return await generate1601FQDatFile(file, profile, month, year, folderId, false);\n        }\n        if (reportType === \"Summary Alphalist of Withholding Tax (SAWT)\") {\n            if (!schedule) {\n                return { ...defaultErrorResult, error: 'SAWT schedule is missing.' };\n            }\n            const result = await validateAndProcessSAWT(formData, false);\n            if (result.success) {\n                 return { ...result };\n            }\n            return result;\n        }\n        return { ...defaultErrorResult, error: `Report type \"${reportType}\" is not yet supported.` };\n    } catch (e) {\n        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred during conversion.';\n        console.error('[convertExcelToDat] CRITICAL ERROR:', e);\n        return { ...defaultErrorResult, error: `Conversion failed: ${errorMessage}` };\n    }\n}\n\n\nexport async function overwriteDatFile(formData: FormData): Promise<DatFileResult> {\n    const file = formData.get('file') as File | null;\n    const reportType = formData.get('reportType') as string | null;\n    const month = formData.get('month') as string | null;\n    const year = formData.get('year') as string | null;\n    const profileString = formData.get('profile') as string | null;\n    const folderId = formData.get('folderId') as string | null;\n    const processedDataString = formData.get('processedData') as string | null;\n    const nonCreditableTaxString = formData.get('nonCreditableInputTax') as string | null;\n    const schedule = formData.get('schedule') as string | null;\n\n    const defaultErrorResult: DatFileResult = {\n        success: false, datContent: null, fileName: null, errors: null, error: null, datFile: null,\n        totalExempt: null, totalZeroRated: null, totalTaxableSales: null, totalOutputTax: null,\n        totalServices: null, totalCapitalGoods: null, totalOtherGoods: null, totalInputTax: null,\n        totalTaxableIncomePayment: null, totalExemptIncomePayment: null, totalWithholdingTax: null,\n        processedData: null,\n    };\n\n    if (!reportType || !month || !year || !profileString || !folderId) {\n        return { ...defaultErrorResult, error: 'Missing required parameters for overwrite.' };\n    }\n     const profile: TaxProfile = JSON.parse(profileString);\n\n    try {\n        if (reportType === \"Summary of Sales (SLS)\") {\n            if (!file) return { ...defaultErrorResult, error: 'Missing file for overwrite.' };\n            return await generateSalesDatFile(file, profile, month, year, folderId, true);\n        }\n        if (reportType === \"Summary of Purchases (SLP)\") {\n            if (!processedDataString || nonCreditableTaxString === null) return { ...defaultErrorResult, error: 'Missing processed data for overwrite.' };\n            const processedData = JSON.parse(processedDataString);\n            const nonCreditableInputTax = parseFloat(nonCreditableTaxString);\n            return await generatePurchasesDatFile(processedData, profile, month, year, nonCreditableInputTax, folderId, true);\n        }\n        if (reportType === \"1601-EQ (Schedule 1 and 2)\") {\n             if (!file) return { ...defaultErrorResult, error: 'Missing file for overwrite.' };\n             return await generate1601EQDatFile(file, profile, month, year, folderId, true);\n        }\n         if (reportType === \"1601-FQ (Schedule 1, 2, and 3)\") {\n             if (!file) return { ...defaultErrorResult, error: 'Missing file for overwrite.' };\n             return await generate1601FQDatFile(file, profile, month, year, folderId, true);\n        }\n        if (reportType === \"Summary Alphalist of Withholding Tax (SAWT)\") {\n            if (!file || !schedule) return { ...defaultErrorResult, error: 'Missing file or schedule for SAWT overwrite.' };\n            return await validateAndProcessSAWT(formData, true);\n        }\n\n        return { ...defaultErrorResult, error: `Report type \"${reportType}\" is not yet supported for overwrite.` };\n    } catch (e) {\n        const errorMessage = e instanceof Error ? e.message : 'An unknown error occurred during overwrite.';\n        console.error('[overwriteDatFile] CRITICAL ERROR:', e);\n        return { ...defaultErrorResult, error: `Overwrite failed: ${errorMessage}` };\n    }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 5124, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/.next-internal/server/app/%28app%29/home/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {logoutUser as '0077798b1627f8549856e5ef771e5b5197af078b59'} from 'ACTIONS_MODULE0'\nexport {getUserHeaderData as '40b981786947aad3d7b17012761d8eedf3b8c56d37'} from 'ACTIONS_MODULE1'\nexport {getDatFiles as '40a57fcb4a960a37a11746b24812e58ef776483800'} from 'ACTIONS_MODULE2'\nexport {getInitialPageToken as '00e0de5eecd8231df764d2365c49c18983c0b60260'} from 'ACTIONS_MODULE2'\nexport {checkForDatFileChanges as '600ba226d4d3d144eecda0e0fe4cc7cd068fe5c48c'} from 'ACTIONS_MODULE2'\nexport {getActiveSessions as '00870c2ea6729377d596915ebe8507f6144a01f34d'} from 'ACTIONS_MODULE3'\nexport {logoutSession as '60238026f028d1be8aa9779380ed8272294195b11e'} from 'ACTIONS_MODULE3'\nexport {convertExcelToDat as '402d9a12997dcb62a2a4d5d51bd6abab90805becd8'} from 'ACTIONS_MODULE4'\nexport {overwriteDatFile as '406f5894bbae82524a5e2abf80c21dcd7b4bbb8b3e'} from 'ACTIONS_MODULE4'\nexport {validateExcelForPurchases as '40f13033d8a880eee44dcd6a36e85bf2b57a5db135'} from 'ACTIONS_MODULE5'\nexport {createPurchasesDatFile as '40ec90e33963869b9290334a9c5b5d388e94fad285'} from 'ACTIONS_MODULE5'\nexport {addTaxProfile as '60772ebd7eee4b78eff3ac73c22413d13f400a55f3'} from 'ACTIONS_MODULE1'\nexport {updateTaxProfile as '60ea6d367d076c4efa427326e37f48bc65200d8fed'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":";AAAA;AACA;AACA;AAGA;AAEA;AAEA","debugId":null}},
    {"offset": {"line": 5233, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/%28app%29/home/page.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/app/(app)/home/page.tsx <module evaluation> from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/app/(app)/home/page.tsx <module evaluation>\",\n    \"default\",\n);\n"],"names":[],"mappings":";;;AAAA;;uCACe,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EACjC;IAAa,MAAM,IAAI,MAAM;AAA+R,GAC5T,6DACA","debugId":null}},
    {"offset": {"line": 5247, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/%28app%29/home/page.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/app/(app)/home/page.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/app/(app)/home/page.tsx\",\n    \"default\",\n);\n"],"names":[],"mappings":";;;AAAA;;uCACe,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EACjC;IAAa,MAAM,IAAI,MAAM;AAA2Q,GACxS,yCACA","debugId":null}},
    {"offset": {"line": 5261, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}}]
}